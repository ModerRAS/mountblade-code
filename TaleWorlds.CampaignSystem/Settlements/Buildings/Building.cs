using System;
using System.Collections.Generic;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Settlements.Buildings
{
	// Token: 0x0200036F RID: 879
	public class Building
	{
		// Token: 0x060033AE RID: 13230 RVA: 0x000D692C File Offset: 0x000D4B2C
		internal static void AutoGeneratedStaticCollectObjectsBuilding(object o, List<object> collectedObjects)
		{
			((Building)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x060033AF RID: 13231 RVA: 0x000D693A File Offset: 0x000D4B3A
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this.BuildingType);
			collectedObjects.Add(this.Town);
		}

		// Token: 0x060033B0 RID: 13232 RVA: 0x000D6954 File Offset: 0x000D4B54
		internal static object AutoGeneratedGetMemberValueTown(object o)
		{
			return ((Building)o).Town;
		}

		// Token: 0x060033B1 RID: 13233 RVA: 0x000D6961 File Offset: 0x000D4B61
		internal static object AutoGeneratedGetMemberValueBuildingType(object o)
		{
			return ((Building)o).BuildingType;
		}

		// Token: 0x060033B2 RID: 13234 RVA: 0x000D696E File Offset: 0x000D4B6E
		internal static object AutoGeneratedGetMemberValueBuildingProgress(object o)
		{
			return ((Building)o).BuildingProgress;
		}

		// Token: 0x060033B3 RID: 13235 RVA: 0x000D6980 File Offset: 0x000D4B80
		internal static object AutoGeneratedGetMemberValueIsCurrentlyDefault(object o)
		{
			return ((Building)o).IsCurrentlyDefault;
		}

		// Token: 0x060033B4 RID: 13236 RVA: 0x000D6992 File Offset: 0x000D4B92
		internal static object AutoGeneratedGetMemberValue_currentLevel(object o)
		{
			return ((Building)o)._currentLevel;
		}

		// Token: 0x060033B5 RID: 13237 RVA: 0x000D69A4 File Offset: 0x000D4BA4
		internal static object AutoGeneratedGetMemberValue_hitpoints(object o)
		{
			return ((Building)o)._hitpoints;
		}

		// Token: 0x17000CA7 RID: 3239
		// (get) Token: 0x060033B6 RID: 13238 RVA: 0x000D69B6 File Offset: 0x000D4BB6
		public TextObject Name
		{
			get
			{
				return this.BuildingType.Name;
			}
		}

		// Token: 0x17000CA8 RID: 3240
		// (get) Token: 0x060033B7 RID: 13239 RVA: 0x000D69C3 File Offset: 0x000D4BC3
		public TextObject Explanation
		{
			get
			{
				return this.BuildingType.Explanation;
			}
		}

		// Token: 0x17000CA9 RID: 3241
		// (get) Token: 0x060033B8 RID: 13240 RVA: 0x000D69D0 File Offset: 0x000D4BD0
		// (set) Token: 0x060033B9 RID: 13241 RVA: 0x000D69D8 File Offset: 0x000D4BD8
		[SaveableProperty(6)]
		public Town Town { get; private set; }

		// Token: 0x17000CAA RID: 3242
		// (get) Token: 0x060033BA RID: 13242 RVA: 0x000D69E1 File Offset: 0x000D4BE1
		// (set) Token: 0x060033BB RID: 13243 RVA: 0x000D69E9 File Offset: 0x000D4BE9
		public int CurrentLevel
		{
			get
			{
				return this._currentLevel;
			}
			set
			{
				this._currentLevel = value;
				if (this.Town.Owner != null)
				{
					this.Town.Owner.SetLevelMaskIsDirty();
				}
			}
		}

		// Token: 0x060033BC RID: 13244 RVA: 0x000D6A0F File Offset: 0x000D4C0F
		public Building(BuildingType buildingType, Town town, float buildingProgress = 0f, int currentLevel = 0)
		{
			this.BuildingType = buildingType;
			this.BuildingProgress = buildingProgress;
			this.Town = town;
			this._currentLevel = currentLevel;
			this.IsCurrentlyDefault = false;
			bool isDefaultProject = buildingType.IsDefaultProject;
		}

		// Token: 0x060033BD RID: 13245 RVA: 0x000D6A4D File Offset: 0x000D4C4D
		public override int GetHashCode()
		{
			return this.BuildingType.GetHashCode() + this.Town.GetHashCode();
		}

		// Token: 0x060033BE RID: 13246 RVA: 0x000D6A68 File Offset: 0x000D4C68
		public int GetConstructionCost()
		{
			float num = 1f;
			if (this.Town.Settlement.OwnerClan.Kingdom != null && this.Town.Settlement.OwnerClan.Kingdom.ActivePolicies.Contains(DefaultPolicies.CastleCharters))
			{
				num = 0.8f;
			}
			return (int)((float)this.BuildingType.GetProductionCost(this._currentLevel) * num);
		}

		// Token: 0x060033BF RID: 13247 RVA: 0x000D6AD4 File Offset: 0x000D4CD4
		public void LevelUp()
		{
			if (this.CurrentLevel < 3)
			{
				int constructionCost = this.GetConstructionCost();
				this.CurrentLevel++;
				this.BuildingProgress -= (float)constructionCost;
				CampaignEventDispatcher.Instance.OnBuildingLevelChanged(this.Town, this, 1);
			}
		}

		// Token: 0x060033C0 RID: 13248 RVA: 0x000D6B20 File Offset: 0x000D4D20
		public void LevelDown()
		{
			if (this.CurrentLevel != this.BuildingType.StartLevel)
			{
				this.CurrentLevel--;
				this.BuildingProgress = 0f;
				this._hitpoints = 100f;
				CampaignEventDispatcher.Instance.OnBuildingLevelChanged(this.Town, this, -1);
			}
		}

		// Token: 0x060033C1 RID: 13249 RVA: 0x000D6B78 File Offset: 0x000D4D78
		public void HitPointChanged(float change)
		{
			if (this.CurrentLevel == this.BuildingType.StartLevel)
			{
				return;
			}
			this._hitpoints = MathF.Clamp(this._hitpoints + change, 0f, 100f);
			if (this._hitpoints == 0f)
			{
				this.LevelDown();
			}
		}

		// Token: 0x060033C2 RID: 13250 RVA: 0x000D6BCC File Offset: 0x000D4DCC
		public float GetBuildingEffectAmount(BuildingEffectEnum effect)
		{
			if (this._currentLevel < this.BuildingType.StartLevel || this._currentLevel > 3)
			{
				Debug.FailedAssert("Building: " + this.Name + " current level is out of bounds!", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Settlements\\Buildings\\Building.cs", "GetBuildingEffectAmount", 126);
			}
			if (this._currentLevel == 0)
			{
				return 0f;
			}
			return Campaign.Current.Models.BuildingEffectModel.GetBuildingEffectAmount(this, effect);
		}

		// Token: 0x060033C3 RID: 13251 RVA: 0x000D6C3F File Offset: 0x000D4E3F
		public TextObject GetBonusExplanation()
		{
			if (this._currentLevel == 0)
			{
				return TextObject.Empty;
			}
			return this.GetBonusExplanations()[this._currentLevel - 1];
		}

		// Token: 0x060033C4 RID: 13252 RVA: 0x000D6C60 File Offset: 0x000D4E60
		private TextObject[] GetBonusExplanations()
		{
			TextObject[] array = new TextObject[]
			{
				TextObject.Empty,
				TextObject.Empty,
				TextObject.Empty
			};
			if (this._currentLevel == 0 || this._currentLevel > 3)
			{
				return array;
			}
			for (int i = 0; i < this._currentLevel; i++)
			{
				array[i] = this.BuildingType.GetExplanationAtLevel(i);
			}
			return array;
		}

		// Token: 0x040010AD RID: 4269
		[SaveableField(0)]
		public readonly BuildingType BuildingType;

		// Token: 0x040010AE RID: 4270
		[SaveableField(1)]
		public float BuildingProgress;

		// Token: 0x040010AF RID: 4271
		public const float MaxHitpoints = 100f;

		// Token: 0x040010B0 RID: 4272
		[SaveableField(2)]
		public bool IsCurrentlyDefault;

		// Token: 0x040010B1 RID: 4273
		[SaveableField(3)]
		private int _currentLevel;

		// Token: 0x040010B3 RID: 4275
		[SaveableField(5)]
		private float _hitpoints = 100f;
	}
}
