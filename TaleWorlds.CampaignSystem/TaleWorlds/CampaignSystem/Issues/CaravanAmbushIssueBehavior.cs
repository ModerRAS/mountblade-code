// Decompiled with JetBrains decompiler
// Type: TaleWorlds.CampaignSystem.Issues.CaravanAmbushIssueBehavior
// Assembly: TaleWorlds.CampaignSystem, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: E85F8C15-4DF6-4E9C-A58A-29177E40D07A
// Assembly location: D:\steam\steamapps\common\Mount & Blade II Bannerlord\bin\Win64_Shipping_Client\TaleWorlds.CampaignSystem.dll

using Helpers;
using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Party.PartyComponents;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

#nullable disable
namespace TaleWorlds.CampaignSystem.Issues
{
  public class CaravanAmbushIssueBehavior : CampaignBehaviorBase
  {
    private const IssueBase.IssueFrequency CaravanAmbushIssueFrequency = IssueBase.IssueFrequency.Common;

    public override void RegisterEvents()
    {
      CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener((object) this, new Action<Hero>(this.OnCheckForIssue));
    }

    private void OnCheckForIssue(Hero hero)
    {
      if (!this.ConditionsHold(hero))
        return;
      Settlement targetSettlement = this.GetTargetSettlement(hero.CurrentSettlement);
      if (targetSettlement == null)
        return;
      Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnIssueSelected), typeof (CaravanAmbushIssueBehavior.CaravanAmbushIssue), IssueBase.IssueFrequency.Common, (object) targetSettlement));
    }

    private IssueBase OnIssueSelected(in PotentialIssueData pid, Hero issueOwner)
    {
      return (IssueBase) new CaravanAmbushIssueBehavior.CaravanAmbushIssue(issueOwner, pid.RelatedObject as Settlement);
    }

    private bool ConditionsHold(Hero issueGiver)
    {
      if (issueGiver == null || !issueGiver.IsNotable || issueGiver.OwnedCaravans.IsEmpty<CaravanPartyComponent>())
        return false;
      return issueGiver.IsArtisan || issueGiver.IsMerchant;
    }

    private Settlement GetTargetSettlement(Settlement currentSettlement)
    {
      IEnumerable<Settlement> source = Settlement.All.Where<Settlement>((Func<Settlement, bool>) (t => t.IsTown && t != currentSettlement && t.MapFaction != null && !t.MapFaction.IsAtWarWith(currentSettlement.MapFaction) && !t.IsUnderRaid && !t.IsUnderSiege));
      return !source.Any<Settlement>() ? (Settlement) null : source.MinBy<Settlement, float>((Func<Settlement, float>) (t => Campaign.Current.Models.MapDistanceModel.GetDistance(t, currentSettlement)));
    }

    public override void SyncData(IDataStore dataStore)
    {
    }

    public class CaravanAmbushIssue : IssueBase
    {
      private const float CaravanAmbushIssueDurationInDays = 20f;
      private const int AlternativeSolutionMinimumTroopTier = 2;
      private const int AlternativeSolutionRenownReward = 3;
      private const int AlternativeSolutionRelationReward = 5;
      private const int AlternativeSolutionRelationPenalty = -5;
      private const int CaravanAmbushIssueNotableMinimumRelation = -10;
      private const int CompanionSkill = 120;
      private const int MinimumRequiredMenCount = 30;
      [SaveableField(1)]
      private readonly Settlement _targetSettlement;

      internal static void AutoGeneratedStaticCollectObjectsCaravanAmbushIssue(
        object o,
        List<object> collectedObjects)
      {
        ((MBObjectBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
      }

      protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
      {
        base.AutoGeneratedInstanceCollectObjects(collectedObjects);
        collectedObjects.Add((object) this._targetSettlement);
      }

      internal static object AutoGeneratedGetMemberValue_targetSettlement(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssue) o)._targetSettlement;
      }

      public override IssueBase.AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags
      {
        get
        {
          return IssueBase.AlternativeSolutionScaleFlag.Casualties | IssueBase.AlternativeSolutionScaleFlag.FailureRisk;
        }
      }

      public override TextObject IssueBriefByIssueGiver
      {
        get
        {
          return new TextObject("{=kOxu3Lw0}Yes... I run caravans, as you may know. I lose a few to bandits from time to time, but generally my caravans are sufficiently well guarded to scare off the small gangs and move quickly enough to outrun the big ones.The problem is that there's a new bandit chief out there who knows his business, who has outfitted his men with horses and uses proper cavalry tactics.I’ve lost three caravans in a row, and I can’t afford to keep this up for long.[if:convo_stern][ib:hip]");
        }
      }

      public override TextObject IssueAcceptByPlayer
      {
        get => new TextObject("{=aJcChHfj}What are you planning to do about them?");
      }

      protected override int CompanionSkillRewardXP
      {
        get => (int) (600.0 + 800.0 * (double) this.IssueDifficultyMultiplier);
      }

      public override TextObject IssueQuestSolutionExplanationByIssueGiver
      {
        get
        {
          TextObject explanationByIssueGiver = new TextObject("{=iWWKTOik}I've got a trick up my sleeve. We'll bait them. I've paid some of my workers to spread rumors about a particularly fat caravan laden with silverware heading out towards {TARGET_SETTLEMENT}. It is a trap, of course. I've got a bunch of mercenaries going with it, disguised as packers. But they could use some backup. Go and follow my caravan. Stay at a proper distance, until they are attacked. Then move in to finish the bandits once and for all. My caravan master will pay you {REWARD}{GOLD_ICON} when the fight is over.[if:convo_mocking_revenge][ib:confident2]");
          explanationByIssueGiver.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.EncyclopediaLinkWithName);
          explanationByIssueGiver.SetTextVariable("REWARD", this.RewardGold);
          explanationByIssueGiver.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          return explanationByIssueGiver;
        }
      }

      public override TextObject IssueQuestSolutionAcceptByPlayer
      {
        get => new TextObject("{=Ov3b2b8p}I'll help you myself.");
      }

      public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
      {
        get
        {
          TextObject explanationByIssueGiver = new TextObject("{=jiFCxZ4B}In that case you should send a good commander with some {TROOP_COUNT} men, just to be safe. And I'll send them back to you in {RETURN_DAYS} days. [if:convo_normal][ib:closed]");
          explanationByIssueGiver.SetTextVariable("TROOP_COUNT", this.GetTotalAlternativeSolutionNeededMenCount());
          explanationByIssueGiver.SetTextVariable("RETURN_DAYS", this.GetTotalAlternativeSolutionDurationInDays());
          return explanationByIssueGiver;
        }
      }

      public override TextObject IssueAlternativeSolutionAcceptByPlayer
      {
        get
        {
          TextObject solutionAcceptByPlayer = new TextObject("{=XLswis9W}I will lend you one of my best lieutenants and {TROOP_COUNT} men.");
          solutionAcceptByPlayer.SetTextVariable("TROOP_COUNT", this.GetTotalAlternativeSolutionNeededMenCount());
          solutionAcceptByPlayer.SetTextVariable("RETURN_DAYS", this.GetTotalAlternativeSolutionDurationInDays());
          return solutionAcceptByPlayer;
        }
      }

      public override TextObject IssueDiscussAlternativeSolution
      {
        get
        {
          return new TextObject("{=L3U98ygQ}We're still preparing the ambush. I hope to have your men back to you shortly.");
        }
      }

      public override TextObject IssueAlternativeSolutionResponseByIssueGiver
      {
        get => new TextObject("{=Y9LNbRho}Thank you. I will put your men to good use.");
      }

      public override bool IsThereLordSolution => false;

      public override TextObject Title => new TextObject("{=wF7uiYzy}Caravan Ambush");

      public override TextObject Description
      {
        get
        {
          TextObject parent = new TextObject("{=H3B75sYi}A merchant asked you to follow a fake caravan that was sent out as a trap to destroy a particularly large and dangerous group of bandits.");
          StringHelpers.SetCharacterProperties("NOTABLE", this.IssueOwner.CharacterObject, parent);
          return parent;
        }
      }

      protected override TextObject AlternativeSolutionStartLog
      {
        get
        {
          TextObject parent = new TextObject("{=YbZYXRqt}{QUEST_GIVER.LINK} asked you to follow a caravan that he sent out as bait to destroy a particularly large and dangerous group of bandits. You ordered {COMPANION.LINK} and {TROOP_COUNT} of your men to follow the caravan from a safe distance and join in the fight once it is attacked. You expect them to return in {RETURN_DAYS} days with the news of success and {REWARD_GOLD}{GOLD_ICON}.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.IssueOwner.CharacterObject, parent);
          StringHelpers.SetCharacterProperties("COMPANION", this.AlternativeSolutionHero.CharacterObject, parent);
          parent.SetTextVariable("REWARD_GOLD", this.RewardGold);
          parent.SetTextVariable("TROOP_COUNT", this.AlternativeSolutionSentTroops.TotalManCount - 1);
          parent.SetTextVariable("RETURN_DAYS", this.GetTotalAlternativeSolutionDurationInDays());
          parent.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          return parent;
        }
      }

      public override TextObject IssueAlternativeSolutionSuccessLog
      {
        get
        {
          TextObject parent = new TextObject("{=PHAm9BIp}{COMPANION.LINK} and the men you sent with {?COMPANION.GENDER}her{?}him{\\?} successfully protected the caravan. {QUEST_GIVER.LINK} is happy and sends you {?QUES_GIVER.GENDER}her{?}him{\\?} regards with {REWARD_GOLD}{GOLD_ICON} he promised.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.IssueOwner.CharacterObject, parent);
          StringHelpers.SetCharacterProperties("COMPANION", this.AlternativeSolutionHero.CharacterObject, parent);
          parent.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          parent.SetTextVariable("REWARD_GOLD", this.RewardGold);
          return parent;
        }
      }

      public override TextObject IssuePlayerResponseAfterAlternativeExplanation
      {
        get => new TextObject("{=DAYaprEi}Maybe I'll send someone to look.");
      }

      public override bool IsThereAlternativeSolution => true;

      public override int AlternativeSolutionBaseNeededMenCount
      {
        get => 22 + MathF.Ceiling(30f * this.IssueDifficultyMultiplier);
      }

      protected override int AlternativeSolutionBaseDurationInDaysInternal
      {
        get => 3 + MathF.Ceiling(5f * this.IssueDifficultyMultiplier);
      }

      protected override int RewardGold
      {
        get => (int) (1000.0 + 3000.0 * (double) this.IssueDifficultyMultiplier);
      }

      public CaravanAmbushIssue(Hero issueOwner, Settlement targetSettlement)
        : base(issueOwner, CampaignTime.DaysFromNow(20f))
      {
        this._targetSettlement = targetSettlement;
      }

      protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
      {
        if (issueEffect == DefaultIssueEffects.SettlementProsperity)
          return -0.3f;
        if (issueEffect == DefaultIssueEffects.SettlementSecurity)
          return -1f;
        return issueEffect == DefaultIssueEffects.IssueOwnerPower ? -0.2f : 0.0f;
      }

      public override (SkillObject, int) GetAlternativeSolutionSkill(Hero hero)
      {
        return (hero.GetSkillValue(DefaultSkills.Tactics) >= hero.GetSkillValue(DefaultSkills.Roguery) ? DefaultSkills.Tactics : DefaultSkills.Roguery, 120);
      }

      protected override void OnGameLoad()
      {
      }

      protected override void HourlyTick()
      {
      }

      protected override QuestBase GenerateIssueQuest(string questId)
      {
        return (QuestBase) new CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest("caravan_ambush_quest_" + (object) CampaignTime.Now.ElapsedSecondsUntilNow, this.IssueOwner, this._targetSettlement, CampaignTime.DaysFromNow(20f), this.RewardGold, this.IssueDifficultyMultiplier);
      }

      public override IssueBase.IssueFrequency GetFrequency() => IssueBase.IssueFrequency.Common;

      protected override bool CanPlayerTakeQuestConditions(
        Hero issueGiver,
        out IssueBase.PreconditionFlags flag,
        out Hero relationHero,
        out SkillObject skill)
      {
        flag = IssueBase.PreconditionFlags.None;
        relationHero = issueGiver;
        skill = (SkillObject) null;
        if ((double) issueGiver.GetRelationWithPlayer() < -10.0)
          flag |= IssueBase.PreconditionFlags.Relation;
        if (issueGiver.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
          flag |= IssueBase.PreconditionFlags.AtWar;
        if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 30)
          flag |= IssueBase.PreconditionFlags.NotEnoughTroops;
        return flag == IssueBase.PreconditionFlags.None;
      }

      public override bool IssueStayAliveConditions()
      {
        return this.IssueOwner != null && this.IssueOwner.OwnedCaravans.Count > 0 && !this.IssueOwner.MapFaction.IsAtWarWith((IFaction) Clan.PlayerClan);
      }

      public override bool DoTroopsSatisfyAlternativeSolution(
        TroopRoster troopRoster,
        out TextObject explanation)
      {
        explanation = TextObject.Empty;
        return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, this.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2);
      }

      public override bool IsTroopTypeNeededByAlternativeSolution(CharacterObject character)
      {
        return character.Tier >= 2;
      }

      protected override void CompleteIssueWithTimedOutConsequences()
      {
      }

      public override bool AlternativeSolutionCondition(out TextObject explanation)
      {
        explanation = TextObject.Empty;
        return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, this.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2);
      }

      protected override void AlternativeSolutionEndWithSuccessConsequence()
      {
        this.AlternativeSolutionHero.AddSkillXp(DefaultSkills.Scouting, (float) (int) (600.0 + 800.0 * (double) this.IssueDifficultyMultiplier));
        float randomFloat = MBRandom.RandomFloat;
        this.AlternativeSolutionHero.AddSkillXp((double) randomFloat <= 0.6600000262260437 ? ((double) randomFloat > 0.6600000262260437 || (double) randomFloat <= 0.33000001311302185 ? DefaultSkills.Polearm : DefaultSkills.TwoHanded) : DefaultSkills.OneHanded, (float) (int) (600.0 + 800.0 * (double) this.IssueDifficultyMultiplier));
        Clan.PlayerClan.AddRenown(3f);
        this.RelationshipChangeWithIssueOwner = 5;
      }

      protected override void AlternativeSolutionEndWithFailureConsequence()
      {
        this.RelationshipChangeWithIssueOwner = -5;
        this.IssueOwner.AddPower(-5f);
      }
    }

    public class CaravanAmbushIssueQuest : QuestBase
    {
      private const int VicinityCheckFailedRelationPenalty = -5;
      private const int VicinityCheckFailedPowerPenalty = -5;
      private const int CaravanDestroyedRelationPenalty = -5;
      private const int CaravanDestroyedPowerPenalty = -5;
      private const int TimeoutRelationPenalty = -5;
      private const int TimeoutPowerPenalty = -5;
      private const int QuestSucceededRelationReward = 5;
      private const int QuestSucceededRenownReward = 3;
      private const float VicinityCheckDistanceSquared = 9f;
      private const int VicinityCheckFailThreshold = 5;
      private const float CaravanWaitOnMapDurationInHours = 2f;
      private const float CaravanWaitOnMapPeriodInHours = 6f;
      private const int NumberOfRandomRewardItems = 3;
      private const float MapEventInvulnerabilityDurationInHours = 6f;
      private const float CaravanMainPartySpeedRatio = 0.7f;
      private const float PartyEscortOuterRadius = 7.1f;
      private const float PartyEscortInnerRadius = 6.3f;
      [SaveableField(1)]
      private readonly Settlement _targetSettlement;
      [SaveableField(2)]
      private readonly float _issueDifficulty;
      [SaveableField(3)]
      private MobileParty _caravanParty;
      [SaveableField(4)]
      private MobileParty _banditParty;
      [SaveableField(5)]
      private int _vicinityCheckFailCounter;
      [SaveableField(6)]
      private List<ItemObject> _rewardItems = new List<ItemObject>();
      [SaveableField(7)]
      private bool _isCaravanSaved;
      [SaveableField(8)]
      private CampaignTime _vicinityCheckDisabledUntil;
      [SaveableField(10)]
      private bool _isCaravanWaitingForEscort;

      internal static void AutoGeneratedStaticCollectObjectsCaravanAmbushIssueQuest(
        object o,
        List<object> collectedObjects)
      {
        ((MBObjectBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
      }

      protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
      {
        base.AutoGeneratedInstanceCollectObjects(collectedObjects);
        collectedObjects.Add((object) this._targetSettlement);
        collectedObjects.Add((object) this._caravanParty);
        collectedObjects.Add((object) this._banditParty);
        collectedObjects.Add((object) this._rewardItems);
        CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime((object) this._vicinityCheckDisabledUntil, collectedObjects);
      }

      internal static object AutoGeneratedGetMemberValue_targetSettlement(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._targetSettlement;
      }

      internal static object AutoGeneratedGetMemberValue_issueDifficulty(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._issueDifficulty;
      }

      internal static object AutoGeneratedGetMemberValue_caravanParty(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._caravanParty;
      }

      internal static object AutoGeneratedGetMemberValue_banditParty(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._banditParty;
      }

      internal static object AutoGeneratedGetMemberValue_vicinityCheckFailCounter(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._vicinityCheckFailCounter;
      }

      internal static object AutoGeneratedGetMemberValue_rewardItems(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._rewardItems;
      }

      internal static object AutoGeneratedGetMemberValue_isCaravanSaved(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._isCaravanSaved;
      }

      internal static object AutoGeneratedGetMemberValue_vicinityCheckDisabledUntil(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._vicinityCheckDisabledUntil;
      }

      internal static object AutoGeneratedGetMemberValue_isCaravanWaitingForEscort(object o)
      {
        return (object) ((CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest) o)._isCaravanWaitingForEscort;
      }

      private int CaravanPartyTroopCount => 22 + MathF.Ceiling(30f * this._issueDifficulty);

      private int BanditPartyTroopCount => 25 + MathF.Ceiling(50f * this._issueDifficulty);

      public override TextObject Title => new TextObject("{=wF7uiYzy}Caravan Ambush");

      public override bool IsRemainingTimeHidden => false;

      private TextObject _caravanAmbushIssueQuestActivatedLogText
      {
        get
        {
          TextObject parent = new TextObject("{=S4kpdrgw}{QUEST_GIVER.LINK}, {?IS_ARTISAN}an artisan{?}a merchant{\\?} from {SETTLEMENT}, asked you to follow a fake caravan that was bait for a particularly large and dangerous group of bandits. {?QUEST_GIVER.GENDER}She{?}He{\\?} suspects this fake caravan will be attacked on its way to {TARGET_SETTLEMENT}, so {?QUEST_GIVER.GENDER}she{?}he{\\?} wants you to follow the caravan from a safe distance and join in the fight once it is attacked. If you succeed, {?QUEST_GIVER.GENDER}she{?}he{\\?} promised to pay you {REWARD_GOLD}{GOLD_ICON}. ");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("IS_ARTISAN", this.QuestGiver.IsArtisan ? 1 : 0);
          parent.SetTextVariable("SETTLEMENT", this.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
          parent.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.EncyclopediaLinkWithName);
          parent.SetTextVariable("REWARD_GOLD", this.RewardGold);
          parent.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          return parent;
        }
      }

      private TextObject _caravanAmbushIssueQuestSucceededLogText
      {
        get
        {
          TextObject parent = new TextObject("{=g5bRX0dd}You have defeated the large group of bandits that {QUEST_GIVER.LINK} mentioned and {?QUEST_GIVER.GENDER}she{?}he{\\?} sends {?QUEST_GIVER.GENDER}her{?}his{\\?} regards with the {REWARD_GOLD}{GOLD_ICON} {?QUEST_GIVER.GENDER}she{?}he{\\?} promised and some trade goods as reward.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("REWARD_GOLD", this.RewardGold);
          parent.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          return parent;
        }
      }

      private TextObject _caravanAmbushIssueQuestVicinityCheckFailedLogText
      {
        get
        {
          TextObject parent = new TextObject("{=DbXMSRmA}You got too close to the caravan. The bandits saw you and withdrew. {QUEST_GIVER.LINK}'s plan failed and {?QUEST_GIVER.GENDER}she{?}he{\\?} will be very upset.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject _caravanAmbushIssueQuestCaravanDestroyedLogText
      {
        get
        {
          TextObject parent = new TextObject("{=WtCSdcs9}You have failed to defeat the bandits, as {QUEST_GIVER.LINK} asked you to do.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject _caravanAmbushIssueQuestTimeOutLogText
      {
        get
        {
          TextObject parent = new TextObject("{=qi0wKvPX}You failed to catch up to the caravan before it was overwhelmed. {QUEST_GIVER.LINK} will be very upset about this.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject _caravanSurvivedWithoutHelpLogText
      {
        get
        {
          TextObject parent = new TextObject("{=UFce0iyy}The caravan survived the battle without your help. You failed to keep your promise to {QUEST_GIVER.LINK}.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject _caravanAmbushIssueQuestHiredBanditsLogText
      {
        get
        {
          TextObject parent = new TextObject("{=bdab7SmZ}You recruited the bandits who were giving {QUEST_GIVER.LINK} trouble. {?QUEST_GIVER.GENDER}she{?}he{\\?} is satisfied with this outcome, and sends you {REWARD_GOLD}{GOLD_ICON} that {?QUEST_GIVER.GENDER}she{?}he{\\?} promised.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("REWARD_GOLD", this.RewardGold);
          parent.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          return parent;
        }
      }

      private TextObject _caravanAmbushWarDeclaredCancelLogText
      {
        get
        {
          TextObject to = new TextObject("{=dQl0Bnwm}Your clan is now at war with the {QUEST_GIVER.LINK}'s faction. Your agreement with {QUEST_GIVER.LINK} has been canceled.");
          to.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject);
          return to;
        }
      }

      public CaravanAmbushIssueQuest(
        string questId,
        Hero questGiver,
        Settlement targetSettlement,
        CampaignTime duration,
        int rewardGold,
        float issueDifficulty)
        : base(questId, questGiver, duration, rewardGold)
      {
        this._targetSettlement = targetSettlement;
        this._issueDifficulty = issueDifficulty;
        this.SetDialogs();
        this.InitializeQuestOnCreation();
      }

      protected override void SetDialogs()
      {
        this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start").NpcLine("{=1sbbbOyr}Excellent... I'm counting on you! The caravan will be leaving soon.[if:convo_normal][ib:hip]").Condition((ConversationSentence.OnConditionDelegate) (() => Hero.OneToOneConversationHero == this.QuestGiver)).Consequence(new ConversationSentence.OnConsequenceDelegate(this.OnQuestAccepted)).CloseDialog();
        this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss").NpcLine("{=5o9udV96}Yes? You should go already. The caravan is on its way.[if:convo_annoyed][ib:normal2]").Condition((ConversationSentence.OnConditionDelegate) (() => Hero.OneToOneConversationHero == this.QuestGiver && !this._isCaravanSaved)).BeginPlayerOptions().PlayerOption("{=DKiLA9f2}Don't worry, I'll find them.").NpcLine("{=ddEu5IFQ}I hope so.").CloseDialog().PlayerOption("{=zpqP5LsC}I'll go right away.").NpcLine("{=3ssQAe1t}Good to hear that").CloseDialog().EndPlayerOptions().CloseDialog();
        Campaign.Current.ConversationManager.AddDialogFlow(this.GetCaravaneerDialogFlow(), (object) this);
      }

      private DialogFlow GetCaravaneerDialogFlow()
      {
        return DialogFlow.CreateDialogFlow("start", 125).NpcLine("{=LqEdr7sQ}Thank you, {?PLAYER.GENDER}milady{?}sir{\\?}. {QUEST_GIVER.LINK} had informed me that help would be on the way. We needed it, I think. Those were a pretty tough lot.").Condition((ConversationSentence.OnConditionDelegate) (() =>
        {
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject);
          return CharacterObject.OneToOneConversationCharacter == ConversationHelper.GetConversationCharacterPartyLeader(this._caravanParty.Party) && this._isCaravanSaved;
        })).PlayerLine("{=MKbLhn9d}I'm glad we caught up to you in time.").NpcLine("{=yxg91L0a}We'll tell everyone what you did.[if:convo_happy][ib:normal2] Please take some of these goods in compensation. We have no intention to sell them anyway. Safe travels, {?PLAYER.GENDER}milady{?}sir{\\?}.").Consequence((ConversationSentence.OnConsequenceDelegate) (() => Campaign.Current.ConversationManager.ConversationEndOneShot += new Action(this.OnQuestSucceeded))).CloseDialog();
      }

      private void OnQuestAccepted()
      {
        this.StartQuest();
        this.AddLog(this._caravanAmbushIssueQuestActivatedLogText);
        ItemRoster caravanItems = new ItemRoster();
        caravanItems.AddToCounts(MBObjectManager.Instance.GetObject<ItemObject>("fish"), 20);
        caravanItems.AddToCounts(MBObjectManager.Instance.GetObject<ItemObject>("grain"), 40);
        caravanItems.AddToCounts(MBObjectManager.Instance.GetObject<ItemObject>("butter"), 20);
        caravanItems.AddToCounts(DefaultItems.HardWood, 60);
        this._caravanParty = CaravanPartyComponent.CreateCaravanParty(this.QuestGiver, this.QuestGiver.CurrentSettlement, caravanItems: caravanItems);
        this._caravanParty.MemberRoster.Clear();
        this._caravanParty.MemberRoster.AddToCounts(this.QuestGiver.Culture.CaravanMaster, 1);
        this._caravanParty.MemberRoster.AddToCounts(this.QuestGiver.Culture.BasicTroop, this.CaravanPartyTroopCount);
        this._caravanParty.IgnoreByOtherPartiesTill(this.QuestDueTime);
        Campaign.Current.MobilePartyLocator.UpdateLocator(this._caravanParty);
        SetPartyAiAction.GetActionForVisitingSettlement(this._caravanParty, this._targetSettlement);
        this._caravanParty.Ai.SetDoNotMakeNewDecisions(true);
        this._caravanParty.SetPartyUsedByQuest(true);
        this.AddTrackedObject((ITrackableCampaignObject) this._caravanParty);
        MobilePartyHelper.TryMatchPartySpeedWithItemWeight(this._caravanParty, MobileParty.MainParty.Speed * 0.7f);
        Settlement nearestHideout = SettlementHelper.FindNearestHideout((Func<Settlement, bool>) (x => x.IsActive));
        Clan clan = Clan.BanditFactions.FirstOrDefault<Clan>((Func<Clan, bool>) (x => x.StringId == "looters"));
        this._banditParty = BanditPartyComponent.CreateBanditParty("caravan_ambush_quest_" + (object) clan.Name, clan, nearestHideout.Hideout, false);
        Vec2 gatePosition = this._targetSettlement.GatePosition;
        PartyTemplateObject pt = Campaign.Current.ObjectManager.GetObject<PartyTemplateObject>("kingdom_hero_party_caravan_ambushers") ?? clan.DefaultPartyTemplate;
        this._banditParty.InitializeMobilePartyAroundPosition(pt, gatePosition, 0.2f, 0.1f);
        this._banditParty.SetCustomName(new TextObject("{=u1Pkt4HC}Raiders"));
        Campaign.Current.MobilePartyLocator.UpdateLocator(this._banditParty);
        this._banditParty.MemberRoster.Clear();
        this._banditParty.SetPartyUsedByQuest(true);
        for (int index = 0; index < this.BanditPartyTroopCount; ++index)
        {
          List<(PartyTemplateStack, float)> weightList = new List<(PartyTemplateStack, float)>();
          foreach (PartyTemplateStack stack in (List<PartyTemplateStack>) pt.Stacks)
            weightList.Add((stack, (float) (64 - stack.Character.Level)));
          this._banditParty.MemberRoster.AddToCounts(MBRandom.ChooseWeighted<PartyTemplateStack>((IReadOnlyList<(PartyTemplateStack, float)>) weightList).Character, 1);
        }
        this._banditParty.ItemRoster.AddToCounts(MBObjectManager.Instance.GetObject<ItemObject>("sumpter_horse"), this.BanditPartyTroopCount / 4);
        this._banditParty.IgnoreByOtherPartiesTill(this.QuestDueTime);
        SetPartyAiAction.GetActionForEngagingParty(this._banditParty, this._caravanParty);
        this._banditParty.Ai.SetDoNotMakeNewDecisions(true);
        for (int index = 0; index < 3; ++index)
          this._rewardItems.Add(Items.All.GetRandomElementWithPredicate<ItemObject>((Func<ItemObject, bool>) (t => t.IsTradeGood && !t.NotMerchandise)));
        this._vicinityCheckDisabledUntil = CampaignTime.HoursFromNow(1f);
      }

      private void OnQuestSucceeded()
      {
        this.AddLog(this._caravanAmbushIssueQuestSucceededLogText);
        GiveGoldAction.ApplyBetweenCharacters((Hero) null, Hero.MainHero, this.RewardGold);
        this.RelationshipChangeWithQuestGiver = 5;
        Clan.PlayerClan.AddRenown(3f);
        foreach (ItemObject rewardItem in this._rewardItems)
          MobileParty.MainParty.ItemRoster.AddToCounts(rewardItem, 1);
        if (PlayerEncounter.Current != null)
          PlayerEncounter.LeaveEncounter = true;
        this.CompleteQuestWithSuccess();
      }

      private void OnPlayerHiredBandits()
      {
        this.AddLog(this._caravanAmbushIssueQuestHiredBanditsLogText);
        GiveGoldAction.ApplyBetweenCharacters((Hero) null, Hero.MainHero, this.RewardGold);
        this.RelationshipChangeWithQuestGiver = 5;
        Clan.PlayerClan.AddRenown(3f);
        if (PlayerEncounter.Current != null)
          PlayerEncounter.LeaveEncounter = true;
        this.CompleteQuestWithSuccess();
      }

      protected override void HourlyTick()
      {
        if (this._caravanParty == null || this._banditParty == null || !this.IsOngoing)
          return;
        if (this._caravanParty.MapEvent == null && !this._isCaravanSaved)
        {
          if ((double) this._caravanParty.Position2D.DistanceSquared(this.QuestGiver.CurrentSettlement.GatePosition) >= 100.0 && (double) this._caravanParty.Position2D.DistanceSquared(MobileParty.MainParty.Position2D) <= 9.0 && this._vicinityCheckDisabledUntil.IsPast)
          {
            MBInformationManager.AddQuickInformation(new TextObject("{=ki1CWgcP}Warning! You are too close to the caravan. Stay a bit farther away."));
            ++this._vicinityCheckFailCounter;
            if (this._vicinityCheckFailCounter >= 5)
              this.OnFailedVicinityChecks();
          }
          MobilePartyHelper.UtilizePartyEscortBehavior(this._caravanParty, MobileParty.MainParty, ref this._isCaravanWaitingForEscort, 6.3f, 7.1f, new MobilePartyHelper.ResumePartyEscortBehaviorDelegate(this.ResumeCaravanMovement));
          if ((double) this._caravanParty.Position2D.DistanceSquared(this._banditParty.Position2D) <= 7.0)
            EncounterManager.StartPartyEncounter(this._banditParty.Party, this._caravanParty.Party);
        }
        if (this._caravanParty.MapEvent == null || !this._caravanParty.MapEvent.IsInvulnerable || (double) this._caravanParty.MapEvent.BattleStartTime.ElapsedHoursUntilNow <= 6.0)
          return;
        this._caravanParty.MapEvent.IsInvulnerable = false;
      }

      private void ResumeCaravanMovement()
      {
        SetPartyAiAction.GetActionForVisitingSettlement(this._caravanParty, this._targetSettlement);
      }

      private void OnFailedVicinityChecks()
      {
        this.AddLog(this._caravanAmbushIssueQuestVicinityCheckFailedLogText);
        this.RelationshipChangeWithQuestGiver = -5;
        this.QuestGiver.AddPower(-5f);
        this.HandlePartyAiAfterCompletion();
        this.CompleteQuestWithFail();
      }

      protected override void OnTimedOut()
      {
        this.AddLog(this._caravanAmbushIssueQuestTimeOutLogText);
        this.RelationshipChangeWithQuestGiver = -5;
        this.QuestGiver.AddPower(-5f);
      }

      private void OnSettlementEntered(MobileParty party, Settlement settlement, Hero hero)
      {
        if (party != this._caravanParty)
          return;
        Debug.FailedAssert("Caravan has arrived at settlement without encountering the bandits", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Issues\\CaravanAmbushIssueBehavior.cs", nameof (OnSettlementEntered), 698);
        DestroyPartyAction.Apply(this._caravanParty.Party, this._caravanParty);
        this._caravanParty = (MobileParty) null;
        this._banditParty.Ai.SetDoNotMakeNewDecisions(false);
        this.CompleteQuestWithCancel();
      }

      protected override void RegisterEvents()
      {
        CampaignEvents.MapEventEnded.AddNonSerializedListener((object) this, new Action<MapEvent>(this.MapEventEnded));
        CampaignEvents.MapEventStarted.AddNonSerializedListener((object) this, new Action<MapEvent, PartyBase, PartyBase>(this.MapEventStarted));
        CampaignEvents.SettlementEntered.AddNonSerializedListener((object) this, new Action<MobileParty, Settlement, Hero>(this.OnSettlementEntered));
        CampaignEvents.BanditPartyRecruited.AddNonSerializedListener((object) this, new Action<MobileParty>(this.OnBanditPartyRecruited));
        CampaignEvents.WarDeclared.AddNonSerializedListener((object) this, new Action<IFaction, IFaction, DeclareWarAction.DeclareWarDetail>(this.OnWarDeclared));
        CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener((object) this, new Action<Clan, Kingdom, Kingdom, ChangeKingdomAction.ChangeKingdomActionDetail, bool>(this.OnClanChangedKingdom));
      }

      private void OnBanditPartyRecruited(MobileParty party)
      {
        if (party != this._banditParty)
          return;
        this.OnPlayerHiredBandits();
      }

      private void OnWarDeclared(
        IFaction faction1,
        IFaction faction2,
        DeclareWarAction.DeclareWarDetail declareWarDetail)
      {
        if (!this.QuestGiver.CurrentSettlement.MapFaction.IsAtWarWith(Clan.PlayerClan.MapFaction))
          return;
        this.CompleteQuestWithCancel(this._caravanAmbushWarDeclaredCancelLogText);
      }

      private void MapEventEnded(MapEvent mapEvent)
      {
        if (mapEvent.WinningSide == BattleSideEnum.None || mapEvent.DefeatedSide == BattleSideEnum.None)
          return;
        MapEventSide mapEventSide1 = mapEvent.GetMapEventSide(mapEvent.WinningSide);
        MapEventSide mapEventSide2 = mapEvent.GetMapEventSide(mapEvent.DefeatedSide);
        if (mapEventSide2.Parties.Any<MapEventParty>((Func<MapEventParty, bool>) (t => t.Party == this._caravanParty.Party)))
        {
          this.HandlePartyAiAfterCompletion();
          this.OnCaravanDestroyed(mapEventSide1.LeaderParty);
        }
        else
        {
          if (!mapEventSide2.Parties.Any<MapEventParty>((Func<MapEventParty, bool>) (t => t.Party == this._banditParty.Party)))
            return;
          this._isCaravanSaved = true;
          this.HandlePartyAiAfterCompletion();
          if (mapEventSide1.IsMainPartyAmongParties())
          {
            if (this._caravanParty.IsActive && mapEventSide1.Parties.Any<MapEventParty>((Func<MapEventParty, bool>) (t => t.Party == this._caravanParty.Party)))
              CampaignMapConversation.OpenConversation(new ConversationCharacterData(Hero.MainHero.CharacterObject), new ConversationCharacterData(ConversationHelper.GetConversationCharacterPartyLeader(this._caravanParty.Party)));
            else
              this.OnQuestSucceeded();
          }
          else
            this.OnCaravanSurvivedWithoutHelp();
        }
      }

      private void OnWarDeclared(IFaction faction1, IFaction faction2)
      {
        this.CheckFailureDueToDiplomaticState();
      }

      private void OnClanChangedKingdom(
        Clan clan,
        Kingdom oldKingdom,
        Kingdom newKingdom,
        ChangeKingdomAction.ChangeKingdomActionDetail detail,
        bool showNotification = true)
      {
        if (clan != Clan.PlayerClan || newKingdom == null)
          return;
        this.CheckFailureDueToDiplomaticState();
      }

      private void CheckFailureDueToDiplomaticState()
      {
        if (!this.QuestGiver.CurrentSettlement.MapFaction.IsAtWarWith(Clan.PlayerClan.MapFaction))
          return;
        this.CompleteQuestWithCancel(this._caravanAmbushWarDeclaredCancelLogText);
      }

      private void MapEventStarted(
        MapEvent mapEvent,
        PartyBase attackerParty,
        PartyBase defenderParty)
      {
        if (defenderParty.MobileParty != this._caravanParty || attackerParty.MobileParty != this._banditParty)
          return;
        mapEvent.IsInvulnerable = true;
      }

      private void OnCaravanSurvivedWithoutHelp()
      {
        this.AddLog(this._caravanSurvivedWithoutHelpLogText);
        ChangeRelationAction.ApplyPlayerRelation(this.QuestGiver, -5);
        this.QuestGiver.AddPower(-5f);
        this.HandlePartyAiAfterCompletion();
        this.CompleteQuestWithFail();
      }

      private void OnCaravanDestroyed(PartyBase destroyerParty)
      {
        this.AddLog(this._caravanAmbushIssueQuestCaravanDestroyedLogText);
        this.RelationshipChangeWithQuestGiver = -5;
        this.QuestGiver.AddPower(-5f);
        if (this._caravanParty.MapEvent != null)
          this._caravanParty.MapEvent.IsInvulnerable = false;
        this._caravanParty = (MobileParty) null;
        this.CompleteQuestWithFail();
      }

      private void HandlePartyAiAfterCompletion()
      {
        if (this._caravanParty.IsActive)
        {
          this._caravanParty.Ai.SetDoNotMakeNewDecisions(false);
          SetPartyAiAction.GetActionForVisitingSettlement(this._caravanParty, this._targetSettlement);
        }
        if (this._banditParty.IsActive)
        {
          this._banditParty.Ai.SetDoNotMakeNewDecisions(false);
          SetPartyAiAction.GetActionForVisitingSettlement(this._banditParty, this._banditParty.HomeSettlement);
        }
        else
          this._banditParty = (MobileParty) null;
      }

      protected override void InitializeQuestOnGameLoad()
      {
        this.SetDialogs();
        if (this._banditParty.MapEvent != null && this._banditParty.MapEvent.DefenderSide.LeaderParty.MobileParty != this._caravanParty)
          this._banditParty.MapEvent.FinalizeEvent();
        if (this._banditParty.Ai.DoNotMakeNewDecisions && this._banditParty.TargetParty == this._caravanParty)
          return;
        SetPartyAiAction.GetActionForEngagingParty(this._banditParty, this._caravanParty);
        this._banditParty.Ai.SetDoNotMakeNewDecisions(true);
        this._banditParty.IgnoreByOtherPartiesTill(this.QuestDueTime);
      }
    }

    public class CaravanAmbushIssueTypeDefiner : SaveableTypeDefiner
    {
      public CaravanAmbushIssueTypeDefiner()
        : base(380000)
      {
      }

      protected override void DefineClassTypes()
      {
        this.AddClassDefinition(typeof (CaravanAmbushIssueBehavior.CaravanAmbushIssue), 1);
        this.AddClassDefinition(typeof (CaravanAmbushIssueBehavior.CaravanAmbushIssueQuest), 2);
      }
    }
  }
}
