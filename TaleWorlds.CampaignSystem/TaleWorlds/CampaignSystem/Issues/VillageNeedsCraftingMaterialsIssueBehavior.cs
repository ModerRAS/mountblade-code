// Decompiled with JetBrains decompiler
// Type: TaleWorlds.CampaignSystem.Issues.VillageNeedsCraftingMaterialsIssueBehavior
// Assembly: TaleWorlds.CampaignSystem, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: E85F8C15-4DF6-4E9C-A58A-29177E40D07A
// Assembly location: D:\steam\steamapps\common\Mount & Blade II Bannerlord\bin\Win64_Shipping_Client\TaleWorlds.CampaignSystem.dll

using Helpers;
using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Extensions;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

#nullable disable
namespace TaleWorlds.CampaignSystem.Issues
{
  public class VillageNeedsCraftingMaterialsIssueBehavior : CampaignBehaviorBase
  {
    private const IssueBase.IssueFrequency VillageNeedsCraftingMaterialsIssueFrequency = IssueBase.IssueFrequency.Rare;

    public override void RegisterEvents()
    {
      CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener((object) this, new Action<Hero>(this.OnCheckForIssue));
    }

    private void OnCheckForIssue(Hero hero)
    {
      Campaign.Current.IssueManager.AddPotentialIssueData(hero, this.ConditionsHold(hero) ? new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnStartIssue), typeof (VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssue), IssueBase.IssueFrequency.Rare) : new PotentialIssueData(typeof (VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssue), IssueBase.IssueFrequency.Rare));
    }

    private bool ConditionsHold(Hero issueGiver)
    {
      return issueGiver.IsRuralNotable && !issueGiver.MapFaction.IsAtWarWith((IFaction) Clan.PlayerClan);
    }

    private IssueBase OnStartIssue(in PotentialIssueData pid, Hero issueOwner)
    {
      return (IssueBase) new VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssue(issueOwner);
    }

    private static ItemObject SelectCraftingMaterial()
    {
      switch (MBRandom.RandomInt(0, 2))
      {
        case 0:
          return DefaultItems.IronIngot1;
        case 1:
          return DefaultItems.IronIngot2;
        default:
          return DefaultItems.IronIngot1;
      }
    }

    public override void SyncData(IDataStore dataStore)
    {
    }

    public class VillageNeedsCraftingMaterialsIssue : IssueBase
    {
      private const int TimeLimit = 30;
      private const int PowerChangeForQuestGiver = 10;
      private const int RelationWithIssueOwnerRewardOnSuccess = 5;
      private const int VillageHeartChangeOnAlternativeSuccess = 60;
      private const int RequiredSkillValueForAlternativeSolution = 120;
      [SaveableField(1)]
      private readonly ItemObject _requestedItem;
      [SaveableField(4)]
      private int _promisedPayment;

      internal static void AutoGeneratedStaticCollectObjectsVillageNeedsCraftingMaterialsIssue(
        object o,
        List<object> collectedObjects)
      {
        ((MBObjectBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
      }

      protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
      {
        base.AutoGeneratedInstanceCollectObjects(collectedObjects);
        collectedObjects.Add((object) this._requestedItem);
      }

      internal static object AutoGeneratedGetMemberValue_requestedItem(object o)
      {
        return (object) ((VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssue) o)._requestedItem;
      }

      internal static object AutoGeneratedGetMemberValue_promisedPayment(object o)
      {
        return (object) ((VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssue) o)._promisedPayment;
      }

      private int _numberOfRequestedItem
      {
        get
        {
          return MathF.Round((float) (int) (750.0 / (double) this._requestedItem.Value) * this.IssueDifficultyMultiplier);
        }
      }

      protected override int CompanionSkillRewardXP
      {
        get => 500 + (int) (700.0 * (double) this.IssueDifficultyMultiplier);
      }

      protected override bool IssueQuestCanBeDuplicated => false;

      public override int AlternativeSolutionBaseNeededMenCount => 4;

      protected override int AlternativeSolutionBaseDurationInDaysInternal
      {
        get => (int) (2.0 + 4.0 * (double) this.IssueDifficultyMultiplier);
      }

      protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
      {
        if (issueEffect == DefaultIssueEffects.VillageHearth)
          return -0.2f;
        return issueEffect == DefaultIssueEffects.IssueOwnerPower ? -0.1f : 0.0f;
      }

      public override (SkillObject, int) GetAlternativeSolutionSkill(Hero hero)
      {
        return (DefaultSkills.Crafting, 120);
      }

      public override bool AlternativeSolutionCondition(out TextObject explanation)
      {
        explanation = TextObject.Empty;
        return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, this.GetTotalAlternativeSolutionNeededMenCount(), ref explanation);
      }

      protected override void AlternativeSolutionEndWithSuccessConsequence()
      {
        GiveGoldAction.ApplyBetweenCharacters((Hero) null, Hero.MainHero, this.GetPayment());
        this.RelationshipChangeWithIssueOwner = 5;
        this.IssueSettlement.Village.Hearth += 60f;
        this.IssueOwner.AddPower(10f);
      }

      public override bool DoTroopsSatisfyAlternativeSolution(
        TroopRoster troopRoster,
        out TextObject explanation)
      {
        explanation = TextObject.Empty;
        return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, this.GetTotalAlternativeSolutionNeededMenCount(), ref explanation);
      }

      public override TextObject Title
      {
        get
        {
          TextObject title = new TextObject("{=eR7P1cVA}{VILLAGE} Needs Crafting Materials");
          title.SetTextVariable("VILLAGE", this.IssueOwner.CurrentSettlement.Name);
          return title;
        }
      }

      public override TextObject Description
      {
        get
        {
          TextObject to = new TextObject("{=5CJrR0X3}{ISSUE_GIVER.LINK} in the village requested crafting materials for their ongoing project.");
          to.SetCharacterProperties("ISSUE_GIVER", this.IssueOwner.CharacterObject);
          return to;
        }
      }

      public override TextObject IssueBriefByIssueGiver
      {
        get
        {
          return new TextObject("{=095beaQ5}Yes, there's a lot of work we need to do around the village, and we're short on the materials that our smith needs to make us tools and fittings. Do you think you could get us some? We'll pay well.[ib:demure][if:convo_dismayed]");
        }
      }

      public override TextObject IssueAcceptByPlayer
      {
        get => new TextObject("{=xmu89biL}Maybe I can help. What do you need exactly?");
      }

      public override TextObject IssueQuestSolutionExplanationByIssueGiver
      {
        get
        {
          TextObject explanationByIssueGiver = new TextObject("{=PftlaE0x}We need {REQUESTED_ITEM_COUNT} {?(REQUESTED_ITEM_COUNT > 1)}{PLURAL(REQUESTED_ITEM)}{?}{REQUESTED_ITEM}{\\?} in {NUMBER_OF_DAYS} days. We need to repair some roofs before the next big storms. I can offer {PAYMENT}{GOLD_ICON}. What do you say?");
          explanationByIssueGiver.SetTextVariable("PAYMENT", this.GetPayment());
          explanationByIssueGiver.SetTextVariable("REQUESTED_ITEM", this._requestedItem.Name);
          explanationByIssueGiver.SetTextVariable("REQUESTED_ITEM_COUNT", this._numberOfRequestedItem);
          explanationByIssueGiver.SetTextVariable("NUMBER_OF_DAYS", 30);
          explanationByIssueGiver.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          return explanationByIssueGiver;
        }
      }

      public override TextObject IssuePlayerResponseAfterAlternativeExplanation
      {
        get => new TextObject("{=i96OaGH3}Is there anything else I could do to help?");
      }

      public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
      {
        get
        {
          return new TextObject("{=WzdhPF7M}Well, if we had some extra skilled labor, we could probably melt down old tools and reforge them. That's too much work for just our smith by himself, but maybe he could do it with someone proficient in crafting to help him.[ib:demure2][if:convo_thinking]");
        }
      }

      public override TextObject IssueQuestSolutionAcceptByPlayer
      {
        get => new TextObject("{=WsmH9Cfd}I will provide what you need.");
      }

      public override TextObject IssueAlternativeSolutionAcceptByPlayer
      {
        get
        {
          return new TextObject("{=8DWTTnpP}My comrade will help your smith to produce what you need.");
        }
      }

      public override TextObject IssueAlternativeSolutionResponseByIssueGiver
      {
        get
        {
          return new TextObject("{=xlagNKZ2}Thank you. With their help, we should be able to make what we need.[if:convo_astonished]");
        }
      }

      public override TextObject IssueDiscussAlternativeSolution
      {
        get
        {
          return new TextObject("{=P3Uu0Ham}Your companion is still working with our smith. I hope they will finish the order in time.[if:convo_approving]");
        }
      }

      public override bool IsThereAlternativeSolution => true;

      public override bool IsThereLordSolution => false;

      public override IssueBase.AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags
      {
        get => IssueBase.AlternativeSolutionScaleFlag.Duration;
      }

      protected override TextObject AlternativeSolutionStartLog
      {
        get
        {
          TextObject parent = new TextObject("{=1XuYGQcT}{ISSUE_GIVER.LINK} told you that {?QUEST_GIVER.GENDER}her{?}his{\\?} local smith needs {REQUESTED_ITEM} to forge more tools. You asked your companion {COMPANION.LINK} to help the local smith and craft {REQUESTED_ITEM_COUNT} {?(REQUESTED_ITEM_COUNT > 1)}{PLURAL(REQUESTED_ITEM)}{?}{REQUESTED_ITEM}{\\?} for the village. Your companion will rejoin your party in {RETURN_DAYS} days.");
          StringHelpers.SetCharacterProperties("ISSUE_GIVER", this.IssueOwner.CharacterObject, parent);
          StringHelpers.SetCharacterProperties("COMPANION", this.AlternativeSolutionHero.CharacterObject, parent);
          parent.SetTextVariable("SETTLEMENT", this.IssueOwner.CurrentSettlement.EncyclopediaLinkWithName);
          parent.SetTextVariable("REQUESTED_ITEM", this._requestedItem.Name);
          parent.SetTextVariable("REQUESTED_ITEM_COUNT", this._numberOfRequestedItem);
          parent.SetTextVariable("RETURN_DAYS", this.GetTotalAlternativeSolutionDurationInDays());
          return parent;
        }
      }

      public override TextObject IssueAlternativeSolutionSuccessLog
      {
        get
        {
          TextObject parent = new TextObject("{=n86jgG3m}Your companion {COMPANION.LINK} has helped the local smith and produced {REQUESTED_AMOUNT} {?(REQUESTED_AMOUNT > 1)}{PLURAL(REQUESTED_GOOD)}{?}{REQUESTED_GOOD}{\\?} as you promised.");
          StringHelpers.SetCharacterProperties("COMPANION", this.AlternativeSolutionHero.CharacterObject, parent);
          parent.SetTextVariable("REQUESTED_AMOUNT", this._numberOfRequestedItem);
          parent.SetTextVariable("REQUESTED_GOOD", this._requestedItem.Name);
          return parent;
        }
      }

      protected override void OnGameLoad()
      {
      }

      protected override void HourlyTick()
      {
      }

      protected override QuestBase GenerateIssueQuest(string questId)
      {
        return (QuestBase) new VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssueQuest(questId, this.IssueOwner, CampaignTime.DaysFromNow(30f), this.GetPayment(), this._requestedItem, this._numberOfRequestedItem);
      }

      public override IssueBase.IssueFrequency GetFrequency() => IssueBase.IssueFrequency.Rare;

      public override void AlternativeSolutionStartConsequence()
      {
        this._promisedPayment = this.GetPayment();
      }

      protected override bool CanPlayerTakeQuestConditions(
        Hero issueGiver,
        out IssueBase.PreconditionFlags flags,
        out Hero relationHero,
        out SkillObject skill)
      {
        flags = IssueBase.PreconditionFlags.None;
        relationHero = (Hero) null;
        skill = (SkillObject) null;
        if ((double) issueGiver.GetRelationWithPlayer() < -10.0)
        {
          flags |= IssueBase.PreconditionFlags.Relation;
          relationHero = issueGiver;
        }
        if (FactionManager.IsAtWarAgainstFaction(issueGiver.MapFaction, Hero.MainHero.MapFaction))
          flags |= IssueBase.PreconditionFlags.AtWar;
        return flags == IssueBase.PreconditionFlags.None;
      }

      protected override void CompleteIssueWithTimedOutConsequences()
      {
      }

      public override bool IssueStayAliveConditions()
      {
        return !this.IssueOwner.CurrentSettlement.IsRaided && !this.IssueOwner.CurrentSettlement.IsUnderRaid;
      }

      public VillageNeedsCraftingMaterialsIssue(Hero issueOwner)
        : base(issueOwner, CampaignTime.DaysFromNow(30f))
      {
        this._requestedItem = VillageNeedsCraftingMaterialsIssueBehavior.SelectCraftingMaterial();
      }

      private int GetPayment()
      {
        return this._promisedPayment != 0 ? this._promisedPayment : 750 + (this.IssueSettlement.Village.Bound.Town.MarketData.GetPrice(this._requestedItem) + QuestHelper.GetAveragePriceOfItemInTheWorld(this._requestedItem) / 2) * this._numberOfRequestedItem;
      }
    }

    public class VillageNeedsCraftingMaterialsIssueQuest : QuestBase
    {
      [SaveableField(10)]
      private readonly int _requestedItemAmount;
      [SaveableField(20)]
      private readonly ItemObject _requestedItem;
      [SaveableField(30)]
      private JournalLog _playerAcceptedQuestLog;
      [SaveableField(40)]
      private JournalLog _playerHasNeededItemsLog;
      private const int SuccessRelationBonus = 5;
      private const int FailRelationPenalty = -5;
      private const int SuccessPowerBonus = 10;
      private const int FailPowerPenalty = -10;
      private const int SuccessHonorBonus = 30;
      private const int FailWithCrimeHonorPenalty = -50;
      private const int SuccessHearthBonus = 30;
      private const int FailToDeliverInTimeHearthPenalty = -40;

      internal static void AutoGeneratedStaticCollectObjectsVillageNeedsCraftingMaterialsIssueQuest(
        object o,
        List<object> collectedObjects)
      {
        ((MBObjectBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
      }

      protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
      {
        base.AutoGeneratedInstanceCollectObjects(collectedObjects);
        collectedObjects.Add((object) this._requestedItem);
        collectedObjects.Add((object) this._playerAcceptedQuestLog);
        collectedObjects.Add((object) this._playerHasNeededItemsLog);
      }

      internal static object AutoGeneratedGetMemberValue_requestedItemAmount(object o)
      {
        return (object) ((VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssueQuest) o)._requestedItemAmount;
      }

      internal static object AutoGeneratedGetMemberValue_requestedItem(object o)
      {
        return (object) ((VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssueQuest) o)._requestedItem;
      }

      internal static object AutoGeneratedGetMemberValue_playerAcceptedQuestLog(object o)
      {
        return (object) ((VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssueQuest) o)._playerAcceptedQuestLog;
      }

      internal static object AutoGeneratedGetMemberValue_playerHasNeededItemsLog(object o)
      {
        return (object) ((VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssueQuest) o)._playerHasNeededItemsLog;
      }

      private TextObject QuestStartedLogText
      {
        get
        {
          TextObject parent = new TextObject("{=YZeKScP5}{QUEST_GIVER.LINK} told you that {?QUEST_GIVER.GENDER}her{?}his{\\?} local smith needs {REQUESTED_ITEM} to forge more tools. {?QUEST_GIVER.GENDER}She{?}He{\\?} asked you to bring {REQUESTED_ITEM_AMOUNT} {?(REQUESTED_ITEM_AMOUNT > 1)}{PLURAL(REQUESTED_ITEM)}{?}{REQUESTED_ITEM}{\\?} to {?QUEST_GIVER.GENDER}her{?}him{\\?}.");
          parent.SetTextVariable("REQUESTED_ITEM_AMOUNT", this._requestedItemAmount);
          parent.SetTextVariable("REQUESTED_ITEM", this._requestedItem.Name);
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject QuestSuccessLogText
      {
        get
        {
          TextObject parent = new TextObject("{=LiDSTrvV}You brought {REQUESTED_ITEM_AMOUNT} {?(REQUESTED_ITEM_AMOUNT > 1)}{PLURAL(REQUESTED_ITEM)}{?}{REQUESTED_ITEM}{\\?} to {?QUEST_GIVER.GENDER}her{?}him{\\?} as promised.");
          parent.SetTextVariable("REQUESTED_ITEM_AMOUNT", this._requestedItemAmount);
          parent.SetTextVariable("REQUESTED_ITEM", this._requestedItem.Name);
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject QuestCanceledWarDeclaredLogText
      {
        get
        {
          TextObject parent = new TextObject("{=vW6kBki9}Your clan is now at war with {QUEST_GIVER.LINK}'s realm. Your agreement with {QUEST_GIVER.LINK} is canceled.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject QuestGiverVillageRaidedLogText
      {
        get
        {
          TextObject parent = new TextObject("{=gJG0xmAq}{QUEST_GIVER.LINK}'s village {QUEST_SETTLEMENT} was raided. Your agreement with {QUEST_GIVER.LINK} is canceled.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("QUEST_SETTLEMENT", this.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
          return parent;
        }
      }

      private TextObject QuestFailedWithTimeOutLogText
      {
        get
        {
          TextObject parent = new TextObject("{=nmz1ky2D}You failed to deliver {REQUESTED_ITEM_AMOUNT} {?(REQUESTED_ITEM_AMOUNT > 1)}{PLURAL(REQUESTED_ITEM)}{?}{REQUESTED_ITEM}{\\?} to {QUEST_GIVER.LINK} in time.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("REQUESTED_ITEM_AMOUNT", this._requestedItemAmount);
          parent.SetTextVariable("REQUESTED_ITEM", this._requestedItem.Name);
          return parent;
        }
      }

      private TextObject PlayerHasNeededItemsLogText
      {
        get
        {
          TextObject neededItemsLogText = new TextObject("{=MxpPkytG}You now have enough {ITEM} to complete the quest. Return to {QUEST_SETTLEMENT} to hand them over.");
          neededItemsLogText.SetTextVariable("ITEM", this._requestedItem.Name);
          neededItemsLogText.SetTextVariable("QUEST_SETTLEMENT", this.QuestGiver.CurrentSettlement.Name);
          return neededItemsLogText;
        }
      }

      public VillageNeedsCraftingMaterialsIssueQuest(
        string questId,
        Hero questGiver,
        CampaignTime duration,
        int rewardGold,
        ItemObject requestedItem,
        int requestedItemAmount)
        : base(questId, questGiver, duration, rewardGold)
      {
        this._requestedItem = requestedItem;
        this._requestedItemAmount = requestedItemAmount;
        this.SetDialogs();
        this.InitializeQuestOnCreation();
      }

      public override TextObject Title
      {
        get
        {
          TextObject title = new TextObject("{=LgiRMbgE}{ISSUE_SETTLEMENT} Needs Crafting Materials");
          title.SetTextVariable("ISSUE_SETTLEMENT", this.QuestGiver.CurrentSettlement.Name);
          return title;
        }
      }

      public override bool IsRemainingTimeHidden => false;

      protected override void SetDialogs()
      {
        TextObject npcText1 = new TextObject("{=UbUokDyI}Thank you. We'd appreciate it if you got the goods to us as quickly as possible. Good luck![ib:nervous2][if:convo_excited]");
        TextObject textObject1 = new TextObject("{=4c9ySfVj}Did you find what we needed, {?PLAYER.GENDER}madam{?}sir{\\?}?");
        TextObject textObject2 = new TextObject("{=nEGe8rUd}Thank you for your help, {?PLAYER.GENDER}madam{?}sir{\\?}. Here is what we promised.");
        TextObject npcText2 = new TextObject("{=sTfr1C8H}Thank you. But if the storms come before you find them, well, that would be bad for us.[ib:nervous2][if:convo_nervous]");
        textObject1.SetCharacterProperties("PLAYER", Hero.MainHero.CharacterObject);
        textObject2.SetCharacterProperties("PLAYER", Hero.MainHero.CharacterObject);
        this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start").NpcLine(npcText1).Condition((ConversationSentence.OnConditionDelegate) (() => CharacterObject.OneToOneConversationCharacter == this.QuestGiver.CharacterObject)).Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestAcceptedConsequences)).CloseDialog();
        this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss").NpcLine(textObject1).Condition((ConversationSentence.OnConditionDelegate) (() => CharacterObject.OneToOneConversationCharacter == this.QuestGiver.CharacterObject)).BeginPlayerOptions().PlayerOption(new TextObject("{=bLRGix1b}Yes, I have them with me.")).ClickableCondition(new ConversationSentence.OnClickableConditionDelegate(this.CompleteQuestClickableConditions)).NpcLine(textObject2).Consequence((ConversationSentence.OnConsequenceDelegate) (() => Campaign.Current.ConversationManager.ConversationEndOneShot += new Action(this.Success))).CloseDialog().PlayerOption(new TextObject("{=D8KFcE2i}Not yet, I am still working on it.")).NpcLine(npcText2).CloseDialog().EndPlayerOptions().CloseDialog();
      }

      private bool CompleteQuestClickableConditions(out TextObject explanation)
      {
        if (this._playerAcceptedQuestLog.CurrentProgress >= this._requestedItemAmount)
        {
          explanation = TextObject.Empty;
          return true;
        }
        explanation = new TextObject("{=EmBla2xa}You don't have enough {ITEM}");
        explanation.SetTextVariable("ITEM", this._requestedItem.Name);
        return false;
      }

      protected override void InitializeQuestOnGameLoad() => this.SetDialogs();

      protected override void HourlyTick()
      {
      }

      private void QuestAcceptedConsequences()
      {
        this.StartQuest();
        int itemCountOnPlayer = this.GetRequiredItemCountOnPlayer();
        TextObject taskName = new TextObject("{=nAEhfGJk}Collect {ITEM}");
        taskName.SetTextVariable("ITEM", this._requestedItem.Name);
        this._playerAcceptedQuestLog = this.AddDiscreteLog(this.QuestStartedLogText, taskName, itemCountOnPlayer, this._requestedItemAmount);
      }

      protected override void OnTimedOut() => this.Fail();

      private void Success()
      {
        this.AddLog(this.QuestSuccessLogText);
        ItemRosterElement itemRosterElement = new ItemRosterElement(this._requestedItem, this._requestedItemAmount);
        GiveItemAction.ApplyForParties(PartyBase.MainParty, Settlement.CurrentSettlement.Party, in itemRosterElement);
        GiveGoldAction.ApplyBetweenCharacters((Hero) null, Hero.MainHero, this.RewardGold);
        TraitLevelingHelper.OnIssueSolvedThroughQuest(Hero.MainHero, new Tuple<TraitObject, int>[1]
        {
          new Tuple<TraitObject, int>(DefaultTraits.Honor, 30)
        });
        this.QuestGiver.AddPower(10f);
        this.RelationshipChangeWithQuestGiver = 5;
        this.QuestGiver.CurrentSettlement.Village.Hearth += 30f;
        this.CompleteQuestWithSuccess();
      }

      private void Fail()
      {
        this.AddLog(this.QuestFailedWithTimeOutLogText);
        this.QuestGiver.AddPower(-10f);
        this.RelationshipChangeWithQuestGiver = -5;
        this.QuestGiver.CurrentSettlement.Village.Hearth += -40f;
        this.CompleteQuestWithFail();
      }

      private int GetRequiredItemCountOnPlayer()
      {
        int itemNumber = PartyBase.MainParty.ItemRoster.GetItemNumber(this._requestedItem);
        if (itemNumber >= this._requestedItemAmount)
        {
          TextObject message = new TextObject("{=MTCrXEvj}You have enough {ITEM} to complete the quest. Return to {QUEST_SETTLEMENT} to hand it over.");
          message.SetTextVariable("QUEST_SETTLEMENT", this.QuestGiver.CurrentSettlement.Name);
          message.SetTextVariable("ITEM", this._requestedItem.Name);
          MBInformationManager.AddQuickInformation(message);
        }
        return itemNumber <= this._requestedItemAmount ? itemNumber : this._requestedItemAmount;
      }

      protected override void RegisterEvents()
      {
        CampaignEvents.WarDeclared.AddNonSerializedListener((object) this, new Action<IFaction, IFaction, DeclareWarAction.DeclareWarDetail>(this.OnWarDeclared));
        CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener((object) this, new Action<Clan, Kingdom, Kingdom, ChangeKingdomAction.ChangeKingdomActionDetail, bool>(this.OnClanChangedKingdom));
        CampaignEvents.RaidCompletedEvent.AddNonSerializedListener((object) this, new Action<BattleSideEnum, RaidEventComponent>(this.OnRaidCompleted));
        CampaignEvents.PlayerInventoryExchangeEvent.AddNonSerializedListener((object) this, new Action<List<(ItemRosterElement, int)>, List<(ItemRosterElement, int)>, bool>(this.OnPlayerInventoryExchange));
        CampaignEvents.OnNewItemCraftedEvent.AddNonSerializedListener((object) this, new Action<ItemObject, ItemModifier, bool>(this.OnItemCrafted));
        CampaignEvents.MapEventStarted.AddNonSerializedListener((object) this, new Action<MapEvent, PartyBase, PartyBase>(this.OnMapEventStarted));
        CampaignEvents.OnEquipmentSmeltedByHeroEvent.AddNonSerializedListener((object) this, new Action<Hero, EquipmentElement>(this.OnEquipmentSmeltedByHero));
        CampaignEvents.OnItemsRefinedEvent.AddNonSerializedListener((object) this, new Action<Hero, TaleWorlds.Core.Crafting.RefiningFormula>(this.OnItemsRefined));
      }

      private void OnItemsRefined(Hero hero, TaleWorlds.Core.Crafting.RefiningFormula refiningFormula)
      {
        if (hero != Hero.MainHero)
          return;
        this.UpdateQuestLog();
      }

      private void OnEquipmentSmeltedByHero(Hero hero, EquipmentElement equipmentElement)
      {
        if (hero != Hero.MainHero)
          return;
        this.UpdateQuestLog();
      }

      private void OnWarDeclared(
        IFaction faction1,
        IFaction faction2,
        DeclareWarAction.DeclareWarDetail detail)
      {
        QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest((QuestBase) this, faction1, faction2, detail, this.QuestCanceledWarDeclaredLogText, this.QuestCanceledWarDeclaredLogText);
      }

      private void OnMapEventStarted(
        MapEvent mapEvent,
        PartyBase attackerParty,
        PartyBase defenderParty)
      {
        if (!QuestHelper.CheckMinorMajorCoercion((QuestBase) this, mapEvent, attackerParty))
          return;
        QuestHelper.ApplyGenericMinorMajorCoercionConsequences((QuestBase) this, mapEvent);
      }

      private void OnItemCrafted(
        ItemObject item,
        ItemModifier overriddenItemModifier,
        bool isCraftingOrderItem)
      {
        this.UpdateQuestLog();
      }

      private void OnPlayerInventoryExchange(
        List<(ItemRosterElement, int)> purchasedItems,
        List<(ItemRosterElement, int)> soldItems,
        bool isTrading)
      {
        this.UpdateQuestLog();
      }

      private void OnClanChangedKingdom(
        Clan clan,
        Kingdom oldKingdom,
        Kingdom newKingdom,
        ChangeKingdomAction.ChangeKingdomActionDetail detail,
        bool showNotification = true)
      {
        if (!this.QuestGiver.CurrentSettlement.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
          return;
        this.CompleteQuestWithCancel(this.QuestCanceledWarDeclaredLogText);
      }

      private void OnRaidCompleted(BattleSideEnum battleSide, RaidEventComponent mapEvent)
      {
        if (mapEvent.MapEventSettlement != this.QuestGiver.CurrentSettlement)
          return;
        this.CompleteQuestWithCancel(this.QuestGiverVillageRaidedLogText);
      }

      private void CheckIfPlayerReadyToReturnItems()
      {
        if (this._playerHasNeededItemsLog == null && this._playerAcceptedQuestLog.CurrentProgress >= this._requestedItemAmount)
        {
          this._playerHasNeededItemsLog = this.AddLog(this.PlayerHasNeededItemsLogText);
        }
        else
        {
          if (this._playerHasNeededItemsLog == null || this._playerAcceptedQuestLog.CurrentProgress >= this._requestedItemAmount)
            return;
          this.RemoveLog(this._playerHasNeededItemsLog);
          this._playerHasNeededItemsLog = (JournalLog) null;
        }
      }

      private void UpdateQuestLog()
      {
        this._playerAcceptedQuestLog.UpdateCurrentProgress(this.GetRequiredItemCountOnPlayer());
        this.CheckIfPlayerReadyToReturnItems();
      }
    }

    public class VillageNeedsCraftingMaterialsIssueTypeDefiner : SaveableTypeDefiner
    {
      public VillageNeedsCraftingMaterialsIssueTypeDefiner()
        : base(601000)
      {
      }

      protected override void DefineClassTypes()
      {
        this.AddClassDefinition(typeof (VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssue), 1);
        this.AddClassDefinition(typeof (VillageNeedsCraftingMaterialsIssueBehavior.VillageNeedsCraftingMaterialsIssueQuest), 2);
      }
    }
  }
}
