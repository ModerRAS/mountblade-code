// Decompiled with JetBrains decompiler
// Type: TaleWorlds.CampaignSystem.Issues.LandlordNeedsAccessToVillageCommonsIssueBehavior
// Assembly: TaleWorlds.CampaignSystem, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: E85F8C15-4DF6-4E9C-A58A-29177E40D07A
// Assembly location: D:\steam\steamapps\common\Mount & Blade II Bannerlord\bin\Win64_Shipping_Client\TaleWorlds.CampaignSystem.dll

using Helpers;
using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Conversation;
using TaleWorlds.CampaignSystem.Encounters;
using TaleWorlds.CampaignSystem.GameMenus;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Party.PartyComponents;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

#nullable disable
namespace TaleWorlds.CampaignSystem.Issues
{
  public class LandlordNeedsAccessToVillageCommonsIssueBehavior : CampaignBehaviorBase
  {
    private const IssueBase.IssueFrequency LandlordNeedsAccessToVillageCommonsIssueFrequency = IssueBase.IssueFrequency.Common;

    public override void RegisterEvents()
    {
      CampaignEvents.OnCheckForIssueEvent.AddNonSerializedListener((object) this, new Action<Hero>(this.OnCheckForIssue));
    }

    public override void SyncData(IDataStore dataStore)
    {
    }

    public void OnCheckForIssue(Hero hero)
    {
      if (this.ConditionsHold(hero))
        Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(new PotentialIssueData.StartIssueDelegate(this.OnSelected), typeof (LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssue), IssueBase.IssueFrequency.Common));
      else
        Campaign.Current.IssueManager.AddPotentialIssueData(hero, new PotentialIssueData(typeof (LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssue), IssueBase.IssueFrequency.Common));
    }

    private bool ConditionsHold(Hero issueGiver)
    {
      return issueGiver.CurrentSettlement != null && issueGiver.CurrentSettlement.IsVillage && !issueGiver.CurrentSettlement.IsUnderRaid && issueGiver.CurrentSettlement.Village.VillageType == DefaultVillageTypes.WheatFarm && issueGiver.IsRuralNotable && !Clan.BanditFactions.IsEmpty<Clan>() && issueGiver.GetTraitLevel(DefaultTraits.Mercy) <= 0 && issueGiver.GetTraitLevel(DefaultTraits.Generosity) <= 0 && (double) issueGiver.CurrentSettlement.Village.Bound.Town.Security <= 70.0 && issueGiver.CurrentSettlement.Village.Bound.BoundVillages.Any<Village>((Func<Village, bool>) (x => x.Settlement != issueGiver.CurrentSettlement && !x.Settlement.IsUnderRaid && x.Settlement.Notables.Any<Hero>((Func<Hero, bool>) (notable => notable.IsHeadman && notable.CanHaveQuestsOrIssues()))));
    }

    private IssueBase OnSelected(in PotentialIssueData pid, Hero issueOwner)
    {
      return (IssueBase) new LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssue(issueOwner);
    }

    public class LandlordNeedsAccessToVillageCommonsIssue : IssueBase
    {
      private const int AlternativeSolutionTroopTierRequirement = 2;
      private const int MinimumRequiredMenCount = 10;
      private const int NeededCompanionSkill = 150;
      private const int IssueDuration = 15;
      private const int QuestTimeLimit = 6;
      [SaveableField(100)]
      private Settlement _targetSettlement;

      internal static void AutoGeneratedStaticCollectObjectsLandlordNeedsAccessToVillageCommonsIssue(
        object o,
        List<object> collectedObjects)
      {
        ((MBObjectBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
      }

      protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
      {
        base.AutoGeneratedInstanceCollectObjects(collectedObjects);
        collectedObjects.Add((object) this._targetSettlement);
      }

      internal static object AutoGeneratedGetMemberValue_targetSettlement(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssue) o)._targetSettlement;
      }

      public override IssueBase.AlternativeSolutionScaleFlag AlternativeSolutionScaleFlags
      {
        get
        {
          return IssueBase.AlternativeSolutionScaleFlag.Casualties | IssueBase.AlternativeSolutionScaleFlag.FailureRisk;
        }
      }

      public override int AlternativeSolutionBaseNeededMenCount
      {
        get => 3 + MathF.Ceiling(4f + this.IssueDifficultyMultiplier);
      }

      protected override int AlternativeSolutionBaseDurationInDaysInternal
      {
        get => 2 + MathF.Ceiling(4f + this.IssueDifficultyMultiplier);
      }

      protected override int RewardGold
      {
        get => (int) (250.0 + 1000.0 * (double) this.IssueDifficultyMultiplier);
      }

      protected override TextObject AlternativeSolutionStartLog
      {
        get
        {
          TextObject parent = new TextObject("{=6OKW8Ba3}{ISSUE_GIVER.LINK}, a landowner from {ISSUE_GIVER_SETTLEMENT}, has told you about {?ISSUE_GIVER.GENDER}her{?}his{\\?} problems with the herders of {TARGET_SETTLEMENT}. Apparently {?ISSUE_GIVER.GENDER}she{?}he{\\?} purchased the right to use a pasture near the village. But some local herders refuse to clear out and are causing problems for {?ISSUE_GIVER.GENDER}her{?}his{\\?} herdsmen. You have agreed to send {COMPANION.LINK} along with {NEEDED_MEN_COUNT} of your men to take care of the situation. You expect them to return in {RETURN_DAYS} days.");
          StringHelpers.SetCharacterProperties("COMPANION", this.AlternativeSolutionHero.CharacterObject, parent);
          StringHelpers.SetCharacterProperties("ISSUE_GIVER", this.IssueOwner.CharacterObject, parent);
          parent.SetTextVariable("ISSUE_GIVER_SETTLEMENT", this.IssueOwner.CurrentSettlement.EncyclopediaLinkWithName);
          parent.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.EncyclopediaLinkWithName);
          parent.SetTextVariable("NEEDED_MEN_COUNT", this.AlternativeSolutionSentTroops.TotalManCount - 1);
          parent.SetTextVariable("RETURN_DAYS", this.GetTotalAlternativeSolutionDurationInDays());
          return parent;
        }
      }

      public override TextObject Title
      {
        get
        {
          TextObject title = new TextObject("{=jYHKGhnc}Landlord needs access to the {TARGET_SETTLEMENT} commons");
          title.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
          return title;
        }
      }

      public override TextObject Description
      {
        get
        {
          TextObject description = new TextObject("{=XXac5fMa}A landowner needs your help in a dispute with herders from nearby {TARGET_SETTLEMENT}. They won't let {?ISSUE_GIVER.GENDER}her{?}his{\\?} herdsmen use pastures {?ISSUE_GIVER.GENDER}she{?}he{\\?} bought.");
          description.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
          return description;
        }
      }

      public override TextObject IssueAsRumorInSettlement
      {
        get
        {
          TextObject parent = new TextObject("{=nxyXKy2z}Old {QUEST_GIVER.NAME} has got some problems with those herders over in {TARGET_SETTLEMENT}.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.IssueOwner.CharacterObject, parent);
          parent.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
          return parent;
        }
      }

      public override TextObject IssueBriefByIssueGiver
      {
        get
        {
          TextObject briefByIssueGiver = new TextObject("{=DUB6zfSe}I have a bit of a dispute with {TARGET_SETTLEMENT}. I recently purchased the right to graze cattle in the nearby pastures from a landowner there. But now some of the herders are making problems.[if:convo_thinking][ib:closed]");
          if (this.IssueOwner.CharacterObject.GetPersona() == DefaultTraits.PersonaCurt)
            briefByIssueGiver = new TextObject("{=0TyPBryV}I recently bought the right to graze cattle near the village of {TARGET_SETTLEMENT}. Good pastureland is hard to find. But now the locals are giving my herdsmen trouble.[if:convo_thinking][ib:closed]");
          briefByIssueGiver.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
          return briefByIssueGiver;
        }
      }

      public override TextObject IssueAcceptByPlayer
      {
        get => new TextObject("{=TXDjKUNf}What's the problem?");
      }

      public override TextObject IssueQuestSolutionExplanationByIssueGiver
      {
        get
        {
          TextObject explanationByIssueGiver = new TextObject("{=Je7SWXK3}They claim that I don't have the right to graze there, that village land can't be bought and sold like that. But look, I spent my silver. I won't get it back. Meanwhile, I can't afford to wait. I need someone to ride along with my herdsmen and my cattle can graze, one way or the other, even if it means violence. I can't let my herd just starve.[if:convo_bored][ib:hip]");
          if (this.IssueOwner.CharacterObject.GetPersona() == DefaultTraits.PersonaCurt)
            explanationByIssueGiver = new TextObject("{=5ehlbXm6}They don't want to share the pastures. But I spent my silver, and I hold the title deed. I need someone to ride along with my herdsmen and clear off anyone who gets in their way.[if:convo_stern][ib:hip]");
          return explanationByIssueGiver;
        }
      }

      public override TextObject IssueAlternativeSolutionExplanationByIssueGiver
      {
        get
        {
          TextObject explanationByIssueGiver = new TextObject("{=wodLHjnh}You or one of your companions with some {ALTERNATIVE_TROOP_AMOUNT} men should do the job. Either way I am willing to pay you {REWARD}{GOLD_ICON}. I doubt they'd stand up long to real warriors.[if:convo_mocking_teasing][ib:closed2]");
          explanationByIssueGiver.SetTextVariable("REWARD", this.RewardGold);
          explanationByIssueGiver.SetTextVariable("ALTERNATIVE_TROOP_AMOUNT", this.GetTotalAlternativeSolutionNeededMenCount());
          explanationByIssueGiver.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          return explanationByIssueGiver;
        }
      }

      public override bool IsThereAlternativeSolution => true;

      public override bool IsThereLordSolution => false;

      public override TextObject IssueQuestSolutionAcceptByPlayer
      {
        get => new TextObject("{=GOkjJwZr}I can get your herdsmen to the pastures.");
      }

      public override TextObject IssueAlternativeSolutionAcceptByPlayer
      {
        get
        {
          TextObject solutionAcceptByPlayer = new TextObject("{=QO0EX2O3}Sure. I can order one of my companions and {TROOP_AMOUNT} men to escort your herds to pasture in {TARGET_SETTLEMENT}.");
          solutionAcceptByPlayer.SetTextVariable("TROOP_AMOUNT", this.GetTotalAlternativeSolutionNeededMenCount());
          solutionAcceptByPlayer.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
          return solutionAcceptByPlayer;
        }
      }

      public override TextObject IssueDiscussAlternativeSolution
      {
        get
        {
          TextObject alternativeSolution = new TextObject("{=BH17ZNSe}I don't think we'll have any more problems at {TARGET_SETTLEMENT}, thanks to your men. Please give them our thanks, {?PLAYER.GENDER}madam{?}sir{\\?}.[if:convo_mocking_teasing][ib:hip]");
          alternativeSolution.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
          return alternativeSolution;
        }
      }

      public override TextObject IssueAlternativeSolutionResponseByIssueGiver
      {
        get
        {
          TextObject parent = new TextObject("{=8INOZiew}Thank you, [if:convo_normal][ib:confident]both for looking out for my interests and upholding the law.");
          if (this.IssueOwner.CharacterObject.GetPersona() == DefaultTraits.PersonaCurt)
            parent = new TextObject("{=UsuOXc25}Thanks. [if:convo_stern][ib:closed]Show those troublemakers that the law is the law.");
          StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, parent);
          return parent;
        }
      }

      protected override int CompanionSkillRewardXP
      {
        get => (int) (700.0 + 900.0 * (double) this.IssueDifficultyMultiplier);
      }

      public LandlordNeedsAccessToVillageCommonsIssue(Hero issueOwner)
        : base(issueOwner, CampaignTime.DaysFromNow(15f))
      {
      }

      protected override float GetIssueEffectAmountInternal(IssueEffect issueEffect)
      {
        if (issueEffect == DefaultIssueEffects.SettlementSecurity)
          return -1f;
        return issueEffect == DefaultIssueEffects.IssueOwnerPower ? -0.1f : 0.0f;
      }

      public override (SkillObject, int) GetAlternativeSolutionSkill(Hero hero)
      {
        int skillValue1 = hero.GetSkillValue(DefaultSkills.OneHanded);
        int skillValue2 = hero.GetSkillValue(DefaultSkills.TwoHanded);
        int skillValue3 = hero.GetSkillValue(DefaultSkills.Polearm);
        return skillValue1 >= skillValue2 && skillValue1 >= skillValue3 ? (DefaultSkills.OneHanded, 150) : (skillValue2 >= skillValue3 ? DefaultSkills.TwoHanded : DefaultSkills.Polearm, 150);
      }

      public override bool AlternativeSolutionCondition(out TextObject explanation)
      {
        explanation = TextObject.Empty;
        return QuestHelper.CheckRosterForAlternativeSolution(MobileParty.MainParty.MemberRoster, this.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2);
      }

      protected override void AlternativeSolutionEndWithSuccessConsequence()
      {
        this.ApplySuccessRewards();
      }

      protected override void AlternativeSolutionEndWithFailureConsequence()
      {
        this.ApplyFailRewards();
      }

      private void ApplySuccessRewards()
      {
        this.IssueOwner.AddPower(10f);
        ChangeRelationAction.ApplyPlayerRelation(this.IssueOwner, 5);
        TraitLevelingHelper.OnIssueSolvedThroughQuest(this.IssueOwner, new Tuple<TraitObject, int>[2]
        {
          new Tuple<TraitObject, int>(DefaultTraits.Honor, 30),
          new Tuple<TraitObject, int>(DefaultTraits.Mercy, -20)
        });
        foreach (Hero notable in (List<Hero>) this._targetSettlement.Notables)
        {
          if (notable.IsHeadman)
          {
            ChangeRelationAction.ApplyPlayerRelation(notable, -3);
            notable.AddPower(-10f);
          }
        }
      }

      private void ApplyFailRewards()
      {
        this.IssueOwner.AddPower(-10f);
        ChangeRelationAction.ApplyPlayerRelation(this.IssueOwner, -5);
        TraitLevelingHelper.OnIssueSolvedThroughQuest(this.IssueOwner, new Tuple<TraitObject, int>[1]
        {
          new Tuple<TraitObject, int>(DefaultTraits.Honor, -20)
        });
        foreach (Hero notable in (List<Hero>) this._targetSettlement.Notables)
        {
          if (notable.IsHeadman)
          {
            ChangeRelationAction.ApplyPlayerRelation(notable, 3);
            notable.AddPower(10f);
          }
        }
      }

      public override bool DoTroopsSatisfyAlternativeSolution(
        TroopRoster troopRoster,
        out TextObject explanation)
      {
        explanation = TextObject.Empty;
        return QuestHelper.CheckRosterForAlternativeSolution(troopRoster, this.GetTotalAlternativeSolutionNeededMenCount(), ref explanation, 2);
      }

      public override bool IsTroopTypeNeededByAlternativeSolution(CharacterObject character)
      {
        return character.Tier >= 2;
      }

      protected override void AfterIssueCreation()
      {
        this._targetSettlement = this.IssueOwner.CurrentSettlement.Village.Bound.BoundVillages.FirstOrDefault<Village>((Func<Village, bool>) (x => x.Settlement != this.IssueOwner.CurrentSettlement && !x.Settlement.IsUnderRaid && x.Settlement.Notables.Any<Hero>((Func<Hero, bool>) (notable => notable.IsHeadman))))?.Settlement;
      }

      protected override void OnGameLoad()
      {
      }

      protected override void HourlyTick()
      {
      }

      protected override QuestBase GenerateIssueQuest(string questId)
      {
        return (QuestBase) new LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest(questId, this.IssueOwner, CampaignTime.DaysFromNow(6f), this._targetSettlement, this.RewardGold, this.IssueDifficultyMultiplier);
      }

      public override IssueBase.IssueFrequency GetFrequency() => IssueBase.IssueFrequency.Common;

      protected override bool CanPlayerTakeQuestConditions(
        Hero issueGiver,
        out IssueBase.PreconditionFlags flag,
        out Hero relationHero,
        out SkillObject skill)
      {
        skill = (SkillObject) null;
        relationHero = (Hero) null;
        flag = IssueBase.PreconditionFlags.None;
        if ((double) issueGiver.GetRelationWithPlayer() < -10.0)
        {
          flag |= IssueBase.PreconditionFlags.Relation;
          relationHero = issueGiver;
        }
        if (this.IssueOwner.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
          flag |= IssueBase.PreconditionFlags.AtWar;
        if (MobileParty.MainParty.MemberRoster.TotalHealthyCount < 10)
          flag |= IssueBase.PreconditionFlags.NotEnoughTroops;
        return flag == IssueBase.PreconditionFlags.None;
      }

      public override bool IssueStayAliveConditions()
      {
        return !this.IssueOwner.CurrentSettlement.IsRaided && !this.IssueOwner.CurrentSettlement.IsUnderRaid && (double) this.IssueOwner.CurrentSettlement.Village.Bound.Town.Security <= 90.0 && this._targetSettlement.Notables.Any<Hero>((Func<Hero, bool>) (x => x.IsHeadman)) && !Clan.BanditFactions.IsEmpty<Clan>();
      }

      protected override void CompleteIssueWithTimedOutConsequences()
      {
      }
    }

    public class LandlordNeedsAccessToVillageCommonsIssueQuest : QuestBase
    {
      private const int PastureRadius = 8;
      private const int BattleFakeSimulationDuration = 5;
      [SaveableField(11)]
      private MobileParty _rivalMobileParty;
      [SaveableField(30)]
      private readonly Settlement _targetSettlement;
      [SaveableField(21)]
      private MobileParty _herdersMobileParty;
      [SaveableField(31)]
      private float _issueDifficultyMultiplier;
      [SaveableField(50)]
      private readonly Hero _headmanNotable;
      [SaveableField(80)]
      private string _questId;
      [SaveableField(90)]
      private int _rewardGold;
      [SaveableField(100)]
      private int _rivalPartySpawnDeltaTime;
      [SaveableField(110)]
      private bool _battleStarted;
      [SaveableField(120)]
      private int _spawnRivalPartyAfterHours;

      internal static void AutoGeneratedStaticCollectObjectsLandlordNeedsAccessToVillageCommonsIssueQuest(
        object o,
        List<object> collectedObjects)
      {
        ((MBObjectBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
      }

      protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
      {
        base.AutoGeneratedInstanceCollectObjects(collectedObjects);
        collectedObjects.Add((object) this._rivalMobileParty);
        collectedObjects.Add((object) this._targetSettlement);
        collectedObjects.Add((object) this._herdersMobileParty);
        collectedObjects.Add((object) this._headmanNotable);
      }

      internal static object AutoGeneratedGetMemberValue_rivalMobileParty(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._rivalMobileParty;
      }

      internal static object AutoGeneratedGetMemberValue_targetSettlement(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._targetSettlement;
      }

      internal static object AutoGeneratedGetMemberValue_herdersMobileParty(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._herdersMobileParty;
      }

      internal static object AutoGeneratedGetMemberValue_issueDifficultyMultiplier(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._issueDifficultyMultiplier;
      }

      internal static object AutoGeneratedGetMemberValue_headmanNotable(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._headmanNotable;
      }

      internal static object AutoGeneratedGetMemberValue_questId(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._questId;
      }

      internal static object AutoGeneratedGetMemberValue_rewardGold(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._rewardGold;
      }

      internal static object AutoGeneratedGetMemberValue_rivalPartySpawnDeltaTime(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._rivalPartySpawnDeltaTime;
      }

      internal static object AutoGeneratedGetMemberValue_battleStarted(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._battleStarted;
      }

      internal static object AutoGeneratedGetMemberValue_spawnRivalPartyAfterHours(object o)
      {
        return (object) ((LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest) o)._spawnRivalPartyAfterHours;
      }

      public override sealed TextObject Title
      {
        get
        {
          TextObject title = new TextObject("{=oT8DUcHf}Landowner needs {TARGET_SETTLEMENT}'s pasture");
          title.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
          return title;
        }
      }

      public override bool IsRemainingTimeHidden => false;

      private TextObject _playerStartsQuestLogText
      {
        get
        {
          TextObject parent = new TextObject("{=GyZHauax}{QUEST_GIVER.LINK}, a rural landowner, has told you about {?QUEST_GIVER.GENDER}her{?}his{\\?} problems with the local herders of {TARGET_SETTLEMENT}. Apparently {?QUEST_GIVER.GENDER}she{?}he{\\?} purchased the right to use a nearby pasture. But the local herders of {TARGET_SETTLEMENT} refuse to clear out and are causing problems for {?QUEST_GIVER.GENDER}her{?}his{\\?} herdsmen. You agreed to do the job yourself, and escort herders to pasture.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("QUEST_GIVER_SETTLEMENT", this.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
          parent.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.EncyclopediaLinkWithName);
          return parent;
        }
      }

      private TextObject _successWitHVillagerSurrenderQuestLogText
      {
        get
        {
          TextObject parent = new TextObject("{=avMQKUoJ}You were able to drive the herders from the disputed pasture. The landowner {QUEST_GIVER.LINK}. {?QUEST_GIVER.GENDER}She{?}he{\\?} is grateful and sends {REWARD}{GOLD_ICON} with {?QUEST_GIVER.GENDER}her{?}his{\\?} regards.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          parent.SetTextVariable("REWARD", this._rewardGold);
          return parent;
        }
      }

      private TextObject _successWitHWinningTheFightQuestLogText
      {
        get
        {
          TextObject parent = new TextObject("{=YbBObxLH}You were able to drive the herders from the disputed pasture. The landowner, {QUEST_GIVER.LINK}, is grateful and sends {REWARD}{GOLD_ICON} with {?QUEST_GIVER.GENDER}her{?}his{\\?} regards.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("QUEST_GIVER_SETTLEMENT", this.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
          parent.SetTextVariable("GOLD_ICON", "{=!}<img src=\"General\\Icons\\Coin@2x\" extend=\"8\">");
          parent.SetTextVariable("REWARD", this._rewardGold);
          return parent;
        }
      }

      private TextObject _failWithLosingTheFightQuestLogText
      {
        get
        {
          TextObject parent = new TextObject("{=117W31dZ}You were unable to drive the herders from the disputed pasture. The landowner, {QUEST_GIVER.LINK}, probably feels that you let {?QUEST_GIVER.GENDER}her{?}him{\\?} down.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("QUEST_GIVER_SETTLEMENT", this.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
          return parent;
        }
      }

      private TextObject _failWithCounterOfferLogText
      {
        get
        {
          TextObject parent = new TextObject("{=zJujFbXU}You decided that the herders had more right to the disputed pasture than the landowner, {QUEST_GIVER.LINK}. {?QUEST_GIVER.GENDER}She{?}He{\\?} probably feels betrayed.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("QUEST_GIVER_SETTLEMENT", this.QuestGiver.CurrentSettlement.EncyclopediaLinkWithName);
          return parent;
        }
      }

      private TextObject _failByTimeoutLogText
      {
        get
        {
          TextObject parent = new TextObject("{=ja74aAEI}You ignored the herders and did not solve the dispute. {?QUEST_GIVER.GENDER}She{?}he{\\?} probably feels betrayed.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject _targetVillageRaided
      {
        get
        {
          TextObject parent = new TextObject("{=aN85Kfnq}{SETTLEMENT} was raided. Your agreement with {QUEST_GIVER.LINK} is canceled.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          parent.SetTextVariable("SETTLEMENT", this._targetSettlement.EncyclopediaLinkWithName);
          return parent;
        }
      }

      private TextObject _playerDeclaredWarQuestLogText
      {
        get
        {
          TextObject parent = new TextObject("{=bqeWVVEE}Your actions have started a war with {QUEST_GIVER.LINK}'s faction. {?QUEST_GIVER.GENDER}She{?}He{\\?} cancels your agreement and the quest is a failure.");
          StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, parent);
          return parent;
        }
      }

      private TextObject _warDeclaredCancelLog
      {
        get
        {
          return new TextObject("{=wQH1N109}War broke out between your clan and the quest giver's realm. Quest canceled.");
        }
      }

      public LandlordNeedsAccessToVillageCommonsIssueQuest(
        string questId,
        Hero questGiver,
        CampaignTime duration,
        Settlement targetSettlement,
        int rewardGold,
        float issueDifficultyMultiplier)
        : base(questId, questGiver, duration, rewardGold)
      {
        this._targetSettlement = targetSettlement;
        this._headmanNotable = targetSettlement.Notables.First<Hero>((Func<Hero, bool>) (x => x.IsHeadman));
        this._questId = questId;
        this._rewardGold = rewardGold;
        this._issueDifficultyMultiplier = issueDifficultyMultiplier;
        this._rivalPartySpawnDeltaTime = 0;
        this.SetDialogs();
        this.InitializeQuestOnCreation();
      }

      protected override void SetDialogs()
      {
        Campaign.Current.ConversationManager.AddDialogFlow(this.GetRivalPartyDialogues(), (object) this);
        Campaign.Current.ConversationManager.AddDialogFlow(this.GetHerderPartyNearVillageDialogues(), (object) this);
        Campaign.Current.ConversationManager.AddDialogFlow(this.GetHerderPartyDialogues(), (object) this);
        this.OfferDialogFlow = DialogFlow.CreateDialogFlow("issue_classic_quest_start").NpcLine(new TextObject("{=qkYCWjTA}I appreciate it. I wait for the good news.")).Condition((ConversationSentence.OnConditionDelegate) (() => Hero.OneToOneConversationHero == this.QuestGiver)).Consequence(new ConversationSentence.OnConsequenceDelegate(this.QuestAcceptedConsequences)).CloseDialog();
        this.DiscussDialogFlow = DialogFlow.CreateDialogFlow("quest_discuss").NpcLine(new TextObject("{=FogJnYH9}Any news about the pastures?[if:convo_undecided_open][ib:closed]")).Condition((ConversationSentence.OnConditionDelegate) (() => Hero.OneToOneConversationHero == this.QuestGiver)).BeginPlayerOptions().PlayerOption(new TextObject("{=wErSpkjy}I'm still working on it.")).NpcLine(new TextObject("{=xolucdbr}I am glad to hear that.[if:convo_undecided_open]")).CloseDialog().PlayerOption(new TextObject("{=7o68QryW}Not yet. I have some other business to attend to.")).NpcLine(new TextObject("{=bEab8stb}Okay. I'm waiting for your good news.[if:convo_undecided_open]")).CloseDialog().EndPlayerOptions().CloseDialog();
      }

      private DialogFlow GetRivalPartyDialogues()
      {
        TextObject npcText = new TextObject("{=Rt2w61N8}Don't get involved in this. [if:convo_confused_normal][ib:hip]We've grazed our herds on these hillsides since our fathers' fathers' time. We don't care if one rich bastard gave a couple of bags of silver to another rich bastard. We don't care about title deeds or courts of law or any of that. Custom is custom, and we're not going anywhere!");
        TextObject text1 = new TextObject("{=YPTZ2et7}Calm down. You're right. No one has the right to sell your ancestral lands. These herdsmen can take their cattle elsewhere.");
        TextObject text2 = new TextObject("{=R1W5Il2d}You can take your grievances to your lord, or to whoever sold the land. The law says a buyer has rights, and you need to clear out.");
        TextObject textObject1 = new TextObject("{=l3ALRD7c}You're just a rich bastard's lackey.[if:convo_confused_annoyed][ib:closed]");
        TextObject textObject2 = new TextObject("{=YLjksPbk}You're a kind {?PLAYER.GENDER}woman, [if:convo_happy]madam{?}man, sir{\\?}. You understand what poor folk like us are up against.");
        StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject1);
        StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject2);
        TextObject text3 = new TextObject("{=ybb0ToHE}We will protect our lands![if:convo_thinking]");
        return DialogFlow.CreateDialogFlow("start", 125).NpcLine(npcText).Condition(new ConversationSentence.OnConditionDelegate(this.RivalPartyTalkOnCondition)).BeginPlayerOptions().PlayerOption(text1).NpcLine(textObject2).Consequence(new ConversationSentence.OnConsequenceDelegate(this.FailWithAcceptingCounterOffer)).CloseDialog().PlayerOption(text2).EndPlayerOptions().BeginNpcOptions().NpcOption(textObject1, new ConversationSentence.OnConditionDelegate(this.RivalPartySurrenderOnCondition)).Consequence(new ConversationSentence.OnConsequenceDelegate(this.SuccessWithVillagersSurrender)).CloseDialog().NpcOption(text3, new ConversationSentence.OnConditionDelegate(this.RivalPartyFightOnCondition)).Consequence((ConversationSentence.OnConsequenceDelegate) (() => PlayerEncounter.LeaveEncounter = false)).CloseDialog().EndNpcOptions().CloseDialog();
      }

      private DialogFlow GetHerderPartyDialogues()
      {
        TextObject textObject = new TextObject("{=He6DW2Xb}Thank you for protecting us {?PLAYER.GENDER}madam{?}sir{\\?}. Keep following, we are almost there.");
        StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject);
        return DialogFlow.CreateDialogFlow("start", 125).NpcLine(textObject).Condition(new ConversationSentence.OnConditionDelegate(this.HerdersTalkOnCondition)).Consequence((ConversationSentence.OnConsequenceDelegate) (() => PlayerEncounter.LeaveEncounter = true)).CloseDialog();
      }

      private bool RivalPartySurrenderOnCondition()
      {
        return MobileParty.MainParty.MemberRoster.TotalManCount - MobileParty.MainParty.MemberRoster.TotalWounded > 14;
      }

      private DialogFlow GetHerderPartyNearVillageDialogues()
      {
        TextObject textObject = new TextObject("{=crg2DrbZ}We are worried that the herders of {TARGET_SETTLEMENT} will harm our animals. Fortunately we have you on our side {?PLAYER.GENDER}madam{?}sir{\\?}.");
        StringHelpers.SetCharacterProperties("PLAYER", CharacterObject.PlayerCharacter, textObject);
        textObject.SetTextVariable("TARGET_SETTLEMENT", this._targetSettlement.Name);
        return DialogFlow.CreateDialogFlow("start", 125).NpcLine(textObject).Condition((ConversationSentence.OnConditionDelegate) (() => this.HerdersTalkOnCondition() && (double) Campaign.Current.Models.MapDistanceModel.GetDistance(MobileParty.ConversationParty, this._targetSettlement) < 10.0)).Consequence((ConversationSentence.OnConsequenceDelegate) (() => PlayerEncounter.LeaveEncounter = true)).CloseDialog();
      }

      private bool RivalPartyTalkOnCondition()
      {
        return this.IsOngoing && this._rivalMobileParty != null && CharacterObject.OneToOneConversationCharacter != null && this._rivalMobileParty.MemberRoster.Contains(CharacterObject.OneToOneConversationCharacter) && MobileParty.ConversationParty != null && !CharacterObject.OneToOneConversationCharacter.IsHero && MobileParty.ConversationParty.HomeSettlement == this._targetSettlement;
      }

      private bool RivalPartyFightOnCondition()
      {
        return MobileParty.MainParty.MemberRoster.TotalManCount - MobileParty.MainParty.MemberRoster.TotalWounded <= 14;
      }

      private bool HerdersTalkOnCondition()
      {
        return this.IsOngoing && this._herdersMobileParty != null && CharacterObject.OneToOneConversationCharacter != null && this._herdersMobileParty.MemberRoster.Contains(CharacterObject.OneToOneConversationCharacter) && MobileParty.ConversationParty != null && !CharacterObject.OneToOneConversationCharacter.IsHero && MobileParty.ConversationParty.Party.Owner != Hero.MainHero && MobileParty.ConversationParty.HomeSettlement == this.QuestGiver.CurrentSettlement;
      }

      private void FailWithAcceptingCounterOffer()
      {
        ChangeRelationAction.ApplyPlayerRelation(this._headmanNotable, 3);
        TraitLevelingHelper.OnIssueSolvedThroughBetrayal(this._headmanNotable, new Tuple<TraitObject, int>[2]
        {
          new Tuple<TraitObject, int>(DefaultTraits.Honor, -30),
          new Tuple<TraitObject, int>(DefaultTraits.Mercy, 20)
        });
        this.CompleteQuestWithFail();
        this.AddLog(this._failWithCounterOfferLogText);
        PlayerEncounter.LeaveEncounter = true;
      }

      private void SpawnRivalParty()
      {
        Clan clan = Clan.BanditFactions.FirstOrDefault<Clan>((Func<Clan, bool>) (x => !x.Culture.CanHaveSettlement));
        if (clan == null)
        {
          Settlement nearestHideout = SettlementHelper.FindNearestHideout();
          if (nearestHideout != null)
          {
            CultureObject banditCulture = nearestHideout.Culture;
            clan = Clan.BanditFactions.FirstOrDefault<Clan>((Func<Clan, bool>) (x => x.Culture == banditCulture));
          }
          if (clan == null)
            clan = Clan.BanditFactions.GetRandomElementInefficiently<Clan>();
        }
        this._rivalMobileParty = BanditPartyComponent.CreateLooterParty("villagers_of_landlord_needs_access_to_village_common_quest" + this._questId, clan, this._targetSettlement, false);
        CharacterObject villager = this.QuestGiver.Culture.Villager;
        TroopRoster memberRoster = new TroopRoster(this._rivalMobileParty.Party);
        TextObject name = new TextObject("{=QLLeHRWw}Herders of {QUEST_SETTLEMENT}");
        name.SetTextVariable("QUEST_SETTLEMENT", this._targetSettlement.Name);
        memberRoster.AddToCounts(villager, MathF.Ceiling((float) (10.0 + 20.0 * (double) this._issueDifficultyMultiplier)));
        this._rivalMobileParty.InitializeMobilePartyAtPosition(memberRoster, new TroopRoster(this._rivalMobileParty.Party), this._targetSettlement.Position2D);
        this._rivalMobileParty.InitializePartyTrade(200);
        this._rivalMobileParty.SetPartyUsedByQuest(true);
        this._rivalMobileParty.SetCustomName(name);
        this._rivalMobileParty.IgnoreForHours(720f);
        this._rivalMobileParty.Ai.SetDoNotMakeNewDecisions(true);
        SetPartyAiAction.GetActionForEngagingParty(this._rivalMobileParty, this._herdersMobileParty);
        this._rivalMobileParty.TargetPosition = this._herdersMobileParty.Position2D;
        this._rivalMobileParty.Party.SetVisualAsDirty();
        this.AddTrackedObject((ITrackableCampaignObject) this._rivalMobileParty);
        this._rivalMobileParty.Aggressiveness = 0.0f;
      }

      private void SuccessWithVillagersSurrender()
      {
        this.CompleteQuestWithSuccess();
        this.AddLog(this._successWitHVillagerSurrenderQuestLogText);
        PlayerEncounter.LeaveEncounter = true;
      }

      private void SpawnHerdersParty()
      {
        this._herdersMobileParty = MobileParty.CreateParty("rival_party_of_landlord_needs_access_to_village_common_quest" + this._questId, (PartyComponent) null);
        CharacterObject villager = this.QuestGiver.Culture.Villager;
        TroopRoster memberRoster = new TroopRoster(this._herdersMobileParty.Party);
        TextObject name = new TextObject("{=tLakpr0a}Herdsmen of {QUEST_GIVER}");
        name.SetTextVariable("QUEST_GIVER", this.QuestGiver.Name);
        memberRoster.AddToCounts(villager, MathF.Ceiling((float) (2.0 + 5.0 * (double) this._issueDifficultyMultiplier)));
        this._herdersMobileParty.InitializeMobilePartyAtPosition(memberRoster, new TroopRoster(this._herdersMobileParty.Party), this.QuestGiver.CurrentSettlement.Position2D);
        this._herdersMobileParty.InitializePartyTrade(200);
        this._herdersMobileParty.SetCustomName(name);
        this._herdersMobileParty.SetCustomHomeSettlement(this.QuestGiver.CurrentSettlement);
        this._herdersMobileParty.SetPartyUsedByQuest(true);
        this._herdersMobileParty.ItemRoster.AddToCounts(MBObjectManager.Instance.GetObject<ItemObject>("sumpter_horse"), MathF.Ceiling((float) (2.0 + 5.0 * (double) this._issueDifficultyMultiplier)));
        this._herdersMobileParty.IgnoreForHours(720f);
        this._herdersMobileParty.Ai.SetDoNotMakeNewDecisions(true);
        this._herdersMobileParty.Party.SetVisualAsDirty();
        this.AddTrackedObject((ITrackableCampaignObject) this._herdersMobileParty);
        this._herdersMobileParty.Aggressiveness = 0.0f;
        Vec2 toPoint = this._targetSettlement.GetPosition2D;
        for (int index = 0; index < 15; ++index)
        {
          toPoint = MobilePartyHelper.FindReachablePointAroundPosition(this._targetSettlement.GetPosition2D, 6f, 5f);
          if (Campaign.Current.Models.MapDistanceModel.GetDistance((IMapPoint) this._targetSettlement, in toPoint, 8f, out float _))
            break;
        }
        this._herdersMobileParty.Ai.SetMoveGoToPoint(toPoint);
        float distance;
        Campaign.Current.Models.MapDistanceModel.GetDistance((IMapPoint) this._herdersMobileParty, in toPoint, 8f, out distance);
        this._spawnRivalPartyAfterHours = (int) ((double) distance / (double) this._herdersMobileParty.Speed) + 3;
      }

      private void QuestAcceptedConsequences()
      {
        this.StartQuest();
        this.AddLog(this._playerStartsQuestLogText);
        this.AddTrackedObject((ITrackableCampaignObject) this._targetSettlement);
        this.SpawnHerdersParty();
      }

      protected override void OnCompleteWithSuccess()
      {
        this.QuestGiver.AddPower(10f);
        this.RelationshipChangeWithQuestGiver = 5;
        this._headmanNotable.AddPower(-10f);
        ChangeRelationAction.ApplyPlayerRelation(this._headmanNotable, -3);
        TraitLevelingHelper.OnIssueSolvedThroughQuest(this.QuestGiver, new Tuple<TraitObject, int>[2]
        {
          new Tuple<TraitObject, int>(DefaultTraits.Honor, 30),
          new Tuple<TraitObject, int>(DefaultTraits.Mercy, -20)
        });
        GiveGoldAction.ApplyForQuestBetweenCharacters((Hero) null, Hero.MainHero, this._rewardGold);
      }

      public override void OnFailed()
      {
        this.QuestGiver.AddPower(-10f);
        this._headmanNotable.AddPower(10f);
        this.RelationshipChangeWithQuestGiver = -5;
        TraitLevelingHelper.OnIssueFailed(this.QuestGiver, new Tuple<TraitObject, int>[1]
        {
          new Tuple<TraitObject, int>(DefaultTraits.Honor, -20)
        });
      }

      protected override void OnTimedOut()
      {
        this.QuestGiver.AddPower(-10f);
        this.RelationshipChangeWithQuestGiver = -5;
        TraitLevelingHelper.OnIssueFailed(this.QuestGiver, new Tuple<TraitObject, int>[1]
        {
          new Tuple<TraitObject, int>(DefaultTraits.Honor, -20)
        });
        this.AddLog(this._failByTimeoutLogText);
      }

      protected override void OnFinalize()
      {
        if (this._herdersMobileParty != null && this._herdersMobileParty.IsVisible && this._herdersMobileParty.IsActive)
          DestroyPartyAction.Apply((PartyBase) null, this._herdersMobileParty);
        if (this._rivalMobileParty == null || !this._rivalMobileParty.IsVisible || !this._rivalMobileParty.IsActive)
          return;
        DestroyPartyAction.Apply((PartyBase) null, this._rivalMobileParty);
      }

      private void OnMapEventStarted(
        MapEvent mapEvent,
        PartyBase attackerParty,
        PartyBase defenderParty)
      {
        if (this._rivalMobileParty != null && mapEvent.InvolvedParties.Contains<PartyBase>(PartyBase.MainParty) && mapEvent.InvolvedParties.Contains<PartyBase>(this._rivalMobileParty.Party) && !mapEvent.InvolvedParties.Contains<PartyBase>(this._herdersMobileParty.Party))
          this._herdersMobileParty.Party.MapEventSide = PartyBase.MainParty.MapEventSide;
        if (!QuestHelper.CheckMinorMajorCoercion((QuestBase) this, mapEvent, attackerParty))
          return;
        QuestHelper.ApplyGenericMinorMajorCoercionConsequences((QuestBase) this, mapEvent);
      }

      private void OnMapEventEnded(MapEvent mapEvent)
      {
        if (this._rivalMobileParty == null || (!mapEvent.InvolvedParties.Contains<PartyBase>(PartyBase.MainParty) || !mapEvent.InvolvedParties.Contains<PartyBase>(this._rivalMobileParty.Party)) && (!mapEvent.InvolvedParties.Contains<PartyBase>(PartyBase.MainParty) || !mapEvent.InvolvedParties.Contains<PartyBase>(this._rivalMobileParty.Party) || !mapEvent.InvolvedParties.Contains<PartyBase>(this._herdersMobileParty.Party)))
          return;
        if (mapEvent.WinningSide == mapEvent.PlayerSide)
        {
          this.CompleteQuestWithSuccess();
          this.AddLog(this._successWitHWinningTheFightQuestLogText);
        }
        else
        {
          this.CompleteQuestWithFail();
          this.AddLog(this._failWithLosingTheFightQuestLogText);
        }
      }

      protected override void HourlyTick()
      {
        if (!this.IsOngoing)
          return;
        this.CheckAnSpawnRivalParty();
        if (this._rivalMobileParty == null)
          return;
        if (this._herdersMobileParty?.MapEvent == null && this._rivalMobileParty?.MapEvent == null && !this._battleStarted && (double) Campaign.Current.Models.MapDistanceModel.GetDistance(this._rivalMobileParty, this._herdersMobileParty) < 0.25)
        {
          EncounterManager.StartPartyEncounter(this._rivalMobileParty.Party, this._herdersMobileParty.Party);
          this._rivalMobileParty.MapEvent.IsInvulnerable = true;
          this._battleStarted = true;
        }
        if (!this._battleStarted || (double) this._rivalMobileParty.MapEvent.BattleStartTime.ElapsedHoursUntilNow <= 5.0)
          return;
        this._rivalMobileParty.MapEvent.FinalizeEvent();
        DestroyPartyAction.Apply(this._rivalMobileParty.Party, this._herdersMobileParty);
      }

      private void CheckAnSpawnRivalParty()
      {
        if (this._rivalMobileParty != null || this._rivalPartySpawnDeltaTime > this._spawnRivalPartyAfterHours)
          return;
        ++this._rivalPartySpawnDeltaTime;
        if (this._rivalPartySpawnDeltaTime <= this._spawnRivalPartyAfterHours)
          return;
        this.SpawnRivalParty();
      }

      private void OnMobilePartyDestroyed(MobileParty mobileParty, PartyBase destroyerParty)
      {
        if (!this.IsOngoing)
          return;
        if (mobileParty == this._rivalMobileParty && (destroyerParty == PartyBase.MainParty || destroyerParty == this._herdersMobileParty.Party))
        {
          this.AddLog(this._successWitHWinningTheFightQuestLogText);
          this.CompleteQuestWithSuccess();
        }
        if (mobileParty != this._herdersMobileParty)
          return;
        this.AddLog(this._failWithLosingTheFightQuestLogText);
        this.CompleteQuestWithFail();
      }

      private void OnClanChangedKingdom(
        Clan clan,
        Kingdom oldKingdom,
        Kingdom newKingdom,
        ChangeKingdomAction.ChangeKingdomActionDetail detail,
        bool showNotification = true)
      {
        if (!this.QuestGiver.CurrentSettlement.MapFaction.IsAtWarWith(Hero.MainHero.MapFaction))
          return;
        this.CompleteQuestWithCancel(this._warDeclaredCancelLog);
      }

      private void OnWarDeclared(
        IFaction faction1,
        IFaction faction2,
        DeclareWarAction.DeclareWarDetail detail)
      {
        QuestHelper.CheckWarDeclarationAndFailOrCancelTheQuest((QuestBase) this, faction1, faction2, detail, this._playerDeclaredWarQuestLogText, this._warDeclaredCancelLog);
      }

      protected override void InitializeQuestOnGameLoad() => this.SetDialogs();

      private void OnVillageRaided(Village village)
      {
        if (village != this._targetSettlement.Village)
          return;
        this.AddLog(this._targetVillageRaided);
        this.CompleteQuestWithCancel();
      }

      protected override void RegisterEvents()
      {
        CampaignEvents.WarDeclared.AddNonSerializedListener((object) this, new Action<IFaction, IFaction, DeclareWarAction.DeclareWarDetail>(this.OnWarDeclared));
        CampaignEvents.OnClanChangedKingdomEvent.AddNonSerializedListener((object) this, new Action<Clan, Kingdom, Kingdom, ChangeKingdomAction.ChangeKingdomActionDetail, bool>(this.OnClanChangedKingdom));
        CampaignEvents.MapEventEnded.AddNonSerializedListener((object) this, new Action<MapEvent>(this.OnMapEventEnded));
        CampaignEvents.MapEventStarted.AddNonSerializedListener((object) this, new Action<MapEvent, PartyBase, PartyBase>(this.OnMapEventStarted));
        CampaignEvents.MobilePartyDestroyed.AddNonSerializedListener((object) this, new Action<MobileParty, PartyBase>(this.OnMobilePartyDestroyed));
        CampaignEvents.VillageBeingRaided.AddNonSerializedListener((object) this, new Action<Village>(this.OnVillageRaided));
        CampaignEvents.GameMenuOpened.AddNonSerializedListener((object) this, new Action<MenuCallbackArgs>(this.OnGameMenuOpened));
        CampaignEvents.HeroKilledEvent.AddNonSerializedListener((object) this, new Action<Hero, Hero, KillCharacterAction.KillCharacterActionDetail, bool>(this.OnHeroKilled));
      }

      public override void OnHeroCanHaveQuestOrIssueInfoIsRequested(Hero hero, ref bool result)
      {
        if (hero != this._headmanNotable)
          return;
        result = false;
      }

      private void OnHeroKilled(
        Hero victim,
        Hero killer,
        KillCharacterAction.KillCharacterActionDetail detail,
        bool showNotification = true)
      {
        if (victim != this._headmanNotable)
          return;
        TextObject textObject = detail == KillCharacterAction.KillCharacterActionDetail.Lost ? this.TargetHeroDisappearedLogText : this.TargetHeroDiedLogText;
        StringHelpers.SetCharacterProperties("QUEST_TARGET", this._headmanNotable.CharacterObject, textObject);
        StringHelpers.SetCharacterProperties("QUEST_GIVER", this.QuestGiver.CharacterObject, textObject);
        this.AddLog(textObject);
        this.CompleteQuestWithCancel();
      }

      private void OnGameMenuOpened(MenuCallbackArgs args)
      {
        if (!(args.MenuContext.GameMenu.StringId == "join_encounter") || !this._battleStarted || PlayerEncounter.EncounteredBattle == null || !PlayerEncounter.EncounteredBattle.InvolvedParties.Contains<PartyBase>(this._rivalMobileParty.Party))
          return;
        this._rivalMobileParty.MapEvent.IsInvulnerable = false;
      }
    }

    public class LandlordNeedsAccessToVillageCommonsIssueTypeDefiner : SaveableTypeDefiner
    {
      public LandlordNeedsAccessToVillageCommonsIssueTypeDefiner()
        : base(420000)
      {
      }

      protected override void DefineClassTypes()
      {
        this.AddClassDefinition(typeof (LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssue), 1);
        this.AddClassDefinition(typeof (LandlordNeedsAccessToVillageCommonsIssueBehavior.LandlordNeedsAccessToVillageCommonsIssueQuest), 2);
      }
    }
  }
}
