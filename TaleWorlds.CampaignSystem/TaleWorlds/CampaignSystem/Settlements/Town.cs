// Decompiled with JetBrains decompiler
// Type: TaleWorlds.CampaignSystem.Settlements.Town
// Assembly: TaleWorlds.CampaignSystem, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: E85F8C15-4DF6-4E9C-A58A-29177E40D07A
// Assembly location: D:\steam\steamapps\common\Mount & Blade II Bannerlord\bin\Win64_Shipping_Client\TaleWorlds.CampaignSystem.dll

using Helpers;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Xml;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.ComponentInterfaces;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements.Buildings;
using TaleWorlds.CampaignSystem.Settlements.Workshops;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

#nullable disable
namespace TaleWorlds.CampaignSystem.Settlements
{
  public class Town : Fief
  {
    private const int InitialTownGold = 20000;
    private const int HighProsperityThreshold = 5000;
    private const int MidProsperityThreshold = 2000;
    [SaveableField(1017)]
    private float _prosperity;
    [CachedData]
    public MatrixFrame[] BesiegerCampPositions1;
    [CachedData]
    public MatrixFrame[] BesiegerCampPositions2;
    [SaveableField(1000)]
    private int _wallLevel;
    private bool _isCastle;
    [SaveableField(1016)]
    public bool GarrisonAutoRecruitmentIsEnabled = true;
    [SaveableField(1040)]
    private Clan _ownerClan;
    [SaveableField(1015)]
    private float _security;
    [SaveableField(1014)]
    private float _loyalty;
    [CachedData]
    private MBList<Village> _tradeBoundVillagesCache;
    [SaveableField(1006)]
    public MBList<Building> Buildings;
    [SaveableField(1007)]
    public Queue<Building> BuildingsInProgress;
    [SaveableField(1008)]
    public int BoostBuildingProcess;
    [SaveableField(1009)]
    private readonly TownMarketData _marketData;
    [SaveableField(1010)]
    private int _tradeTax;
    [SaveableField(1011)]
    public bool InRebelliousState;
    [SaveableField(1012)]
    private Hero _governor;
    [SaveableField(1013)]
    private Town.SellLog[] _soldItems = new Town.SellLog[0];

    internal static void AutoGeneratedStaticCollectObjectsTown(
      object o,
      List<object> collectedObjects)
    {
      ((MBObjectBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
    }

    protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
    {
      base.AutoGeneratedInstanceCollectObjects(collectedObjects);
      collectedObjects.Add((object) this.Buildings);
      collectedObjects.Add((object) this.BuildingsInProgress);
      collectedObjects.Add((object) this._ownerClan);
      collectedObjects.Add((object) this._marketData);
      collectedObjects.Add((object) this._governor);
      collectedObjects.Add((object) this._soldItems);
      collectedObjects.Add((object) this.Workshops);
      collectedObjects.Add((object) this.LastCapturedBy);
    }

    internal static object AutoGeneratedGetMemberValueWorkshops(object o)
    {
      return (object) ((Town) o).Workshops;
    }

    internal static object AutoGeneratedGetMemberValueLastCapturedBy(object o)
    {
      return (object) ((Town) o).LastCapturedBy;
    }

    internal static object AutoGeneratedGetMemberValueGarrisonAutoRecruitmentIsEnabled(object o)
    {
      return (object) ((Town) o).GarrisonAutoRecruitmentIsEnabled;
    }

    internal static object AutoGeneratedGetMemberValueBuildings(object o)
    {
      return (object) ((Town) o).Buildings;
    }

    internal static object AutoGeneratedGetMemberValueBuildingsInProgress(object o)
    {
      return (object) ((Town) o).BuildingsInProgress;
    }

    internal static object AutoGeneratedGetMemberValueBoostBuildingProcess(object o)
    {
      return (object) ((Town) o).BoostBuildingProcess;
    }

    internal static object AutoGeneratedGetMemberValueInRebelliousState(object o)
    {
      return (object) ((Town) o).InRebelliousState;
    }

    internal static object AutoGeneratedGetMemberValue_prosperity(object o)
    {
      return (object) ((Town) o)._prosperity;
    }

    internal static object AutoGeneratedGetMemberValue_wallLevel(object o)
    {
      return (object) ((Town) o)._wallLevel;
    }

    internal static object AutoGeneratedGetMemberValue_ownerClan(object o)
    {
      return (object) ((Town) o)._ownerClan;
    }

    internal static object AutoGeneratedGetMemberValue_security(object o)
    {
      return (object) ((Town) o)._security;
    }

    internal static object AutoGeneratedGetMemberValue_loyalty(object o)
    {
      return (object) ((Town) o)._loyalty;
    }

    internal static object AutoGeneratedGetMemberValue_marketData(object o)
    {
      return (object) ((Town) o)._marketData;
    }

    internal static object AutoGeneratedGetMemberValue_tradeTax(object o)
    {
      return (object) ((Town) o)._tradeTax;
    }

    internal static object AutoGeneratedGetMemberValue_governor(object o)
    {
      return (object) ((Town) o)._governor;
    }

    internal static object AutoGeneratedGetMemberValue_soldItems(object o)
    {
      return (object) ((Town) o)._soldItems;
    }

    public float Prosperity
    {
      get => this._prosperity;
      set
      {
        this._prosperity = value;
        if ((double) this._prosperity >= 0.0)
          return;
        this._prosperity = 0.0f;
      }
    }

    public IEnumerable<PartyBase> GetDefenderParties(MapEvent.BattleTypes battleType)
    {
      Town town = this;
      yield return town.Settlement.Party;
      foreach (MobileParty party in (List<MobileParty>) town.Settlement.Parties)
      {
        if (party.MapFaction.IsAtWarWith(town.Settlement.SiegeEvent.BesiegerCamp.LeaderParty.MapFaction) && party.IsActive && !party.IsVillager && !party.IsCaravan && (!party.IsMilitia || !town.InRebelliousState && battleType != MapEvent.BattleTypes.SallyOut))
          yield return party.Party;
      }
    }

    public PartyBase GetNextDefenderParty(ref int partyIndex, MapEvent.BattleTypes battleType)
    {
      ++partyIndex;
      if (partyIndex == 0)
        return this.Settlement.Party;
      for (int index = partyIndex - 1; index < this.Settlement.Parties.Count; ++index)
      {
        MobileParty party = this.Settlement.Parties[index];
        if (party.MapFaction.IsAtWarWith(this.Settlement.SiegeEvent.BesiegerCamp.LeaderParty.MapFaction) && party.IsActive && !party.IsVillager && !party.IsCaravan && (!party.IsMilitia || !this.InRebelliousState && battleType != MapEvent.BattleTypes.SallyOut))
        {
          partyIndex = index + 1;
          return party.Party;
        }
      }
      return (PartyBase) null;
    }

    public CultureObject Culture => this.Owner.Settlement.Culture;

    public float ProsperityChange
    {
      get
      {
        return Campaign.Current.Models.SettlementProsperityModel.CalculateProsperityChange(this).ResultNumber;
      }
    }

    public ExplainedNumber ProsperityChangeExplanation
    {
      get
      {
        return Campaign.Current.Models.SettlementProsperityModel.CalculateProsperityChange(this, true);
      }
    }

    public int GarrisonChange
    {
      get
      {
        return (int) Campaign.Current.Models.SettlementGarrisonModel.CalculateGarrisonChange(this.Owner.Settlement).ResultNumber;
      }
    }

    public int GarrisonChangeAutoRecruitment
    {
      get
      {
        return (int) Campaign.Current.Models.SettlementGarrisonModel.CalculateGarrisonChangeAutoRecruitment(this.Owner.Settlement).ResultNumber;
      }
    }

    public ExplainedNumber GarrisonChangeExplanation
    {
      get
      {
        return Campaign.Current.Models.SettlementGarrisonModel.CalculateGarrisonChange(this.Owner.Settlement, true);
      }
    }

    public float FoodChange
    {
      get
      {
        return Campaign.Current.Models.SettlementFoodModel.CalculateTownFoodStocksChange(this).ResultNumber;
      }
    }

    public float FoodChangeWithoutMarketStocks
    {
      get
      {
        return Campaign.Current.Models.SettlementFoodModel.CalculateTownFoodStocksChange(this, false).ResultNumber;
      }
    }

    public ExplainedNumber FoodChangeExplanation
    {
      get
      {
        return Campaign.Current.Models.SettlementFoodModel.CalculateTownFoodStocksChange(this, includeDescriptions: true);
      }
    }

    public float LoyaltyChange
    {
      get
      {
        return Campaign.Current.Models.SettlementLoyaltyModel.CalculateLoyaltyChange(this).ResultNumber;
      }
    }

    public ExplainedNumber LoyaltyChangeExplanation
    {
      get => Campaign.Current.Models.SettlementLoyaltyModel.CalculateLoyaltyChange(this, true);
    }

    public float SecurityChange
    {
      get
      {
        return Campaign.Current.Models.SettlementSecurityModel.CalculateSecurityChange(this).ResultNumber;
      }
    }

    public ExplainedNumber SecurityChangeExplanation
    {
      get => Campaign.Current.Models.SettlementSecurityModel.CalculateSecurityChange(this, true);
    }

    public float MilitiaChange
    {
      get
      {
        return Campaign.Current.Models.SettlementMilitiaModel.CalculateMilitiaChange(this.Owner.Settlement).ResultNumber;
      }
    }

    public ExplainedNumber MilitiaChangeExplanation
    {
      get
      {
        return Campaign.Current.Models.SettlementMilitiaModel.CalculateMilitiaChange(this.Owner.Settlement, true);
      }
    }

    public float Construction
    {
      get
      {
        return Campaign.Current.Models.BuildingConstructionModel.CalculateDailyConstructionPower(this).ResultNumber;
      }
    }

    public ExplainedNumber ConstructionExplanation
    {
      get
      {
        return Campaign.Current.Models.BuildingConstructionModel.CalculateDailyConstructionPower(this, true);
      }
    }

    public Clan OwnerClan
    {
      get => this._ownerClan;
      set
      {
        if (this._ownerClan == value)
          return;
        this.ChangeClanInternal(value);
      }
    }

    public float Security
    {
      get => this._security;
      set
      {
        this._security = value;
        if ((double) this._security < 0.0)
        {
          this._security = 0.0f;
        }
        else
        {
          if ((double) this._security <= 100.0)
            return;
          this._security = 100f;
        }
      }
    }

    public float Loyalty
    {
      get => this._loyalty;
      set
      {
        this._loyalty = value;
        if ((double) this._loyalty < 0.0)
        {
          this._loyalty = 0.0f;
        }
        else
        {
          if ((double) this._loyalty <= 100.0)
            return;
          this._loyalty = 100f;
        }
      }
    }

    public MBReadOnlyList<Village> TradeBoundVillages
    {
      get => (MBReadOnlyList<Village>) this._tradeBoundVillagesCache;
    }

    internal void SetTradeBoundVillageInternal(Village village)
    {
      this._tradeBoundVillagesCache.Add(village);
    }

    internal void RemoveTradeBoundVillageInternal(Village village)
    {
      this._tradeBoundVillagesCache.Remove(village);
    }

    public int FoodStocksUpperLimit()
    {
      return (int) ((double) (Campaign.Current.Models.SettlementFoodModel.FoodStocksUpperLimit + (this.IsCastle ? Campaign.Current.Models.SettlementFoodModel.CastleFoodStockUpperLimitBonus : 0)) + (double) this.GetEffectOfBuildings(BuildingEffectEnum.Foodstock));
    }

    [SaveableProperty(1005)]
    public Workshop[] Workshops { get; protected set; }

    public Building CurrentBuilding
    {
      get
      {
        return !this.BuildingsInProgress.IsEmpty<Building>() ? this.BuildingsInProgress.Peek() : this.CurrentDefaultBuilding;
      }
    }

    public Building CurrentDefaultBuilding
    {
      get => this.Buildings.Find((Predicate<Building>) (k => k.IsCurrentlyDefault));
    }

    public TownMarketData MarketData => this._marketData;

    public int TradeTaxAccumulated
    {
      get => this._tradeTax;
      set => this._tradeTax = value;
    }

    public Hero Governor
    {
      get => this._governor;
      set
      {
        if (this._governor == value)
          return;
        if (this._governor != null)
          this._governor.GovernorOf = (Town) null;
        this._governor = value;
        if (this._governor == null)
          return;
        this._governor.GovernorOf = this;
      }
    }

    public Town()
    {
      this.Buildings = new MBList<Building>();
      this.BuildingsInProgress = new Queue<Building>();
      this.Workshops = new Workshop[0];
      this._marketData = new TownMarketData(this);
      this._tradeBoundVillagesCache = new MBList<Village>();
    }

    public static IEnumerable<Town> AllFiefs
    {
      get
      {
        foreach (Town allTown in (List<Town>) Campaign.Current.AllTowns)
          yield return allTown;
        foreach (Town allCastle in (List<Town>) Campaign.Current.AllCastles)
          yield return allCastle;
      }
    }

    public static MBReadOnlyList<Town> AllTowns => Campaign.Current.AllTowns;

    public static MBReadOnlyList<Town> AllCastles => Campaign.Current.AllCastles;

    public override bool IsTown => !this._isCastle;

    public override bool IsCastle => this._isCastle;

    public override void OnInit()
    {
      this.Loyalty = (float) this.Owner.RandomIntWithSeed(1337U, 30, 70);
      this.Security = (float) this.Owner.RandomIntWithSeed(1001U, 40, 60);
      this.TradeTaxAccumulated = this.IsTown ? 1000 + MBRandom.RandomInt(1000) : 0;
      this.ChangeGold(20000);
      this.Buildings.Add(new Building(this.IsTown ? DefaultBuildingTypes.Fortifications : DefaultBuildingTypes.Wall, this, currentLevel: this._wallLevel));
    }

    public void InitializeWorkshops(int count)
    {
      if (count <= 0)
        return;
      this.Workshops = new Workshop[count];
      for (int index = 0; index < count; ++index)
        this.Workshops[index] = new Workshop(this.Owner.Settlement, "workshop_" + (object) index);
    }

    [LoadInitializationCallback]
    private void OnLoad() => this._tradeBoundVillagesCache = new MBList<Village>();

    protected override void PreAfterLoad() => this._ownerClan?.OnFortificationAdded(this);

    protected override void AfterLoad()
    {
      foreach (Workshop workshop in this.Workshops)
        workshop.AfterLoad();
      bool flag = false;
      for (int index = this.Buildings.Count - 1; index >= 0; --index)
      {
        Building building = this.Buildings[index];
        if (building.BuildingType == null || !building.BuildingType.IsReady)
        {
          this.Buildings.RemoveAt(index);
          flag = true;
        }
      }
      if (!flag)
      {
        foreach (Building building in this.BuildingsInProgress)
        {
          if (building.BuildingType == null || !building.BuildingType.IsReady)
          {
            flag = true;
            break;
          }
        }
      }
      if (flag)
        this.BuildingsInProgress.Clear();
      if (this.Governor == null || this.Governor.GovernorOf != null)
        return;
      this.Governor = (Hero) null;
    }

    public IReadOnlyCollection<Town.SellLog> SoldItems
    {
      get => (IReadOnlyCollection<Town.SellLog>) this._soldItems;
    }

    public IFaction MapFaction => this.OwnerClan?.MapFaction;

    public bool IsUnderSiege => this.Settlement.IsUnderSiege;

    [CachedData]
    public MBReadOnlyList<Village> Villages => this.Settlement.BoundVillages;

    [SaveableProperty(1030)]
    public Clan LastCapturedBy { get; set; }

    private void ChangeClanInternal(Clan value)
    {
      if (this._ownerClan != null)
        this.RemoveOwnerClan();
      this._ownerClan = value;
      if (this._ownerClan == null)
        return;
      this.SetNewOwnerClan();
    }

    public float GetEffectOfBuildings(BuildingEffectEnum buildingEffect)
    {
      float effectOfBuildings = 0.0f;
      foreach (Building building in (List<Building>) this.Buildings)
        effectOfBuildings += building.GetBuildingEffectAmount(buildingEffect);
      return effectOfBuildings;
    }

    private void SetNewOwnerClan()
    {
      this._ownerClan.OnFortificationAdded(this);
      foreach (Village boundVillage in (List<Village>) this.Settlement.BoundVillages)
      {
        boundVillage.Settlement.Party.SetVisualAsDirty();
        boundVillage.VillagerPartyComponent?.MobileParty.Party.SetVisualAsDirty();
      }
    }

    private void RemoveOwnerClan() => this._ownerClan.OnFortificationRemoved(this);

    public bool HasTournament
    {
      get => this.IsTown && Campaign.Current.TournamentManager.GetTournamentGame(this) != null;
    }

    internal void DailyTick()
    {
      this.Loyalty += this.LoyaltyChange;
      this.Security += this.SecurityChange;
      if ((double) this.FoodStocks > 0.0)
        this.Owner.OnConsumedFood();
      this.FoodStocks += this.FoodChange;
      if ((double) this.FoodStocks < 0.0)
      {
        this.FoodStocks = 0.0f;
        this.Owner.RemainingFoodPercentage = -100;
      }
      else
        this.Owner.RemainingFoodPercentage = 0;
      if ((double) this.FoodStocks > (double) this.FoodStocksUpperLimit())
        this.FoodStocks = (float) this.FoodStocksUpperLimit();
      if (!this.CurrentBuilding.BuildingType.IsDefaultProject)
        this.TickCurrentBuilding();
      else if (this.Governor != null && this.Governor.GetPerkValue(DefaultPerks.Charm.Virile) && (double) MBRandom.RandomFloat <= (double) DefaultPerks.Charm.Virile.SecondaryBonus)
      {
        Hero randomElement = this.Settlement.Notables.GetRandomElement<Hero>();
        if (randomElement != null)
          ChangeRelationAction.ApplyRelationChangeBetweenHeroes(this.Governor.Clan.Leader, randomElement, 1, false);
      }
      if (this.Governor != null)
      {
        if (this.Governor.GetPerkValue(DefaultPerks.Roguery.WhiteLies) && (double) MBRandom.RandomFloat <= (double) DefaultPerks.Roguery.WhiteLies.SecondaryBonus)
        {
          Hero randomElement = this.Settlement.Notables.GetRandomElement<Hero>();
          if (randomElement != null)
            ChangeRelationAction.ApplyRelationChangeBetweenHeroes(this.Governor, randomElement, 1);
        }
        if (this.Governor.GetPerkValue(DefaultPerks.Roguery.Scarface) && (double) MBRandom.RandomFloat <= (double) DefaultPerks.Roguery.Scarface.SecondaryBonus)
        {
          Hero elementWithPredicate = this.Settlement.Notables.GetRandomElementWithPredicate<Hero>((Func<Hero, bool>) (x => x.IsGangLeader));
          if (elementWithPredicate != null)
            ChangeRelationAction.ApplyRelationChangeBetweenHeroes(this.Governor, elementWithPredicate, 1);
        }
      }
      this.Prosperity += this.ProsperityChange;
      this.HandleMilitiaAndGarrisonOfSettlementDaily();
      this.RepairWallsOfSettlementDaily();
    }

    private void HandleMilitiaAndGarrisonOfSettlementDaily()
    {
      this.Owner.Settlement.Militia += this.MilitiaChange;
      if (this.GarrisonChange >= 1 && this.GarrisonParty == null)
        this.Owner.Settlement.AddGarrisonParty();
      if (this.GarrisonParty == null || !this.GarrisonParty.IsActive || this.GarrisonParty.MapEvent != null || this.GarrisonParty.CurrentSettlement == null)
        return;
      int dailyTroopXpBonus = Campaign.Current.Models.DailyTroopXpBonusModel.CalculateDailyTroopXpBonus(this);
      float xpBonusMultiplier = Campaign.Current.Models.DailyTroopXpBonusModel.CalculateGarrisonXpBonusMultiplier(this);
      if (dailyTroopXpBonus > 0)
      {
        foreach (TroopRosterElement troopRosterElement in (List<TroopRosterElement>) this.GarrisonParty.MemberRoster.GetTroopRoster())
          this.GarrisonParty.MemberRoster.AddXpToTroop(MathF.Round((float) dailyTroopXpBonus * xpBonusMultiplier * (float) troopRosterElement.Number), troopRosterElement.Character);
      }
      this.DailyGarrisonAdjustment();
    }

    private void RepairWallsOfSettlementDaily()
    {
      Settlement settlement = this.Owner.Settlement;
      float maxWallHitPoints = settlement.MaxWallHitPoints;
      if (!settlement.SettlementWallSectionHitPointsRatioList.Any<float>((Func<float, bool>) (health => (double) health < 1.0)) || settlement.IsUnderSiege)
        return;
      float num1 = maxWallHitPoints * 0.02f;
      float effectOfBuildings = this.GetEffectOfBuildings(BuildingEffectEnum.WallRepairSpeed);
      if ((double) effectOfBuildings > 0.0)
        num1 += (float) ((double) num1 * (double) effectOfBuildings * 0.0099999997764825821);
      float b = num1 / settlement.MaxHitPointsOfOneWallSection;
      for (int index = 0; index < settlement.SettlementWallSectionHitPointsRatioList.Count; ++index)
      {
        float sectionHitPointsRatio = settlement.SettlementWallSectionHitPointsRatioList[index];
        float num2 = MathF.Min(1f - sectionHitPointsRatio, b);
        settlement.SetWallSectionHitPointsRatioAtIndex(index, sectionHitPointsRatio + num2);
        b -= num2;
        if ((double) b <= 0.0)
          break;
      }
    }

    private void DesertOneTroopFromGarrison()
    {
      if (this.GarrisonParty.MemberRoster.TotalManCount <= 0)
        return;
      int num = (int) ((double) MBRandom.RandomFloat * (double) this.GarrisonParty.MemberRoster.TotalManCount);
      for (int index = 0; index < this.GarrisonParty.MemberRoster.Count; ++index)
      {
        num -= this.GarrisonParty.MemberRoster.GetElementNumber(index);
        if (num < 0)
        {
          TroopRoster dummyTroopRoster = TroopRoster.CreateDummyTroopRoster();
          MobilePartyHelper.DesertTroopsFromParty(this.GarrisonParty, index, 1, 0, ref dummyTroopRoster);
          break;
        }
      }
    }

    private void DailyGarrisonAdjustment()
    {
      int garrisonChange = this.GarrisonParty.CurrentSettlement.Town.GarrisonChange;
      int changeAutoRecruitment = this.GarrisonAutoRecruitmentIsEnabled ? this.GarrisonParty.CurrentSettlement.Town.GarrisonChangeAutoRecruitment : 0;
      int num1 = garrisonChange - changeAutoRecruitment;
      int limitedPartySize = this.GarrisonParty.LimitedPartySize;
      if (num1 > 0)
        num1 = MBMath.ClampInt(num1, 0, limitedPartySize - this.GarrisonParty.Party.NumberOfAllMembers - changeAutoRecruitment);
      if (num1 < 0)
      {
        for (int index = 0; index < MathF.Abs(num1); ++index)
          this.DesertOneTroopFromGarrison();
      }
      else if (num1 > 0)
        this.GarrisonParty.MemberRoster.AddToCounts(this.GarrisonParty.MapFaction.BasicTroop, num1);
      if (changeAutoRecruitment > 0)
      {
        int num2 = SettlementHelper.NumberOfVolunteersCanBeRecruitedForGarrison(this.GarrisonParty.CurrentSettlement);
        Hero leader = this.GarrisonParty.CurrentSettlement.OwnerClan.Leader;
        if (num2 > 0)
        {
          float num3 = MBRandom.RandomFloat * (float) num2;
          foreach (Hero notable in (List<Hero>) this.GarrisonParty.CurrentSettlement.Notables)
          {
            if ((double) num3 > 0.0)
            {
              int num4 = Campaign.Current.Models.VolunteerModel.MaximumIndexHeroCanRecruitFromHero(leader, notable);
              for (int index = 0; index < num4; ++index)
              {
                if (notable.IsAlive && notable.VolunteerTypes[index] != null)
                {
                  --num3;
                  if ((double) num3 <= 0.0)
                  {
                    this.GarrisonParty.MemberRoster.AddToCounts(notable.VolunteerTypes[index], 1);
                    leader.Clan.AutoRecruitmentExpenses += Campaign.Current.Models.PartyWageModel.GetTroopRecruitmentCost(notable.VolunteerTypes[index], leader);
                    notable.VolunteerTypes[index] = (CharacterObject) null;
                    break;
                  }
                }
              }
            }
            else
              break;
          }
          if ((double) num3 > 0.0)
          {
            foreach (Village boundVillage in (List<Village>) this.GarrisonParty.CurrentSettlement.BoundVillages)
            {
              if ((double) num3 > 0.0)
              {
                if (boundVillage.VillageState == Village.VillageStates.Normal)
                {
                  foreach (Hero notable in (List<Hero>) boundVillage.Settlement.Notables)
                  {
                    if ((double) num3 > 0.0)
                    {
                      int num5 = Campaign.Current.Models.VolunteerModel.MaximumIndexHeroCanRecruitFromHero(leader, notable);
                      for (int index = 0; index < num5; ++index)
                      {
                        if (notable.IsAlive && notable.VolunteerTypes[index] != null)
                        {
                          --num3;
                          if ((double) num3 <= 0.0)
                          {
                            this.GarrisonParty.MemberRoster.AddToCounts(notable.VolunteerTypes[index], 1);
                            leader.Clan.AutoRecruitmentExpenses += Campaign.Current.Models.PartyWageModel.GetTroopRecruitmentCost(notable.VolunteerTypes[index], leader);
                            notable.VolunteerTypes[index] = (CharacterObject) null;
                            break;
                          }
                        }
                      }
                    }
                    else
                      break;
                  }
                }
              }
              else
                break;
            }
          }
        }
      }
      if (this.GarrisonParty.Party.NumberOfAllMembers <= limitedPartySize)
        return;
      int num6 = MBRandom.RoundRandomized((float) (this.GarrisonParty.Party.NumberOfAllMembers - limitedPartySize) * 0.2f);
      for (int index = 0; index < num6; ++index)
        this.DesertOneTroopFromGarrison();
    }

    public int GetWallLevel()
    {
      int wallLevel = 0;
      foreach (Building building in (List<Building>) this.Buildings)
      {
        if (building.BuildingType == DefaultBuildingTypes.Fortifications && this.IsTown)
        {
          wallLevel = building.CurrentLevel;
          break;
        }
        if (building.BuildingType == DefaultBuildingTypes.Wall && this.IsCastle)
        {
          wallLevel = building.CurrentLevel;
          break;
        }
      }
      return wallLevel;
    }

    public override string ToString() => this.Name.ToString();

    public override void Deserialize(MBObjectManager objectManager, XmlNode node)
    {
      if (!this.IsInitialized)
        this._wallLevel = node.Attributes["level"] != null ? int.Parse(node.Attributes["level"].Value) : 0;
      this._isCastle = node.Attributes["is_castle"] != null && bool.Parse(node.Attributes["is_castle"].Value);
      this.BackgroundCropPosition = float.Parse(node.Attributes["background_crop_position"].Value);
      this.BackgroundMeshName = node.Attributes["background_mesh"].Value;
      this.WaitMeshName = node.Attributes["wait_mesh"].Value;
      if (!this.IsInitialized)
        this._prosperity = float.Parse(node.Attributes["prosperity"].Value);
      this.BesiegerCampPositions1 = new MatrixFrame[1]
      {
        MatrixFrame.Identity
      };
      this.BesiegerCampPositions2 = new MatrixFrame[1]
      {
        MatrixFrame.Identity
      };
      base.Deserialize(objectManager, node);
    }

    public void SetSoldItems(IEnumerable<Town.SellLog> logList)
    {
      this._soldItems = logList.ToArray<Town.SellLog>();
    }

    public override int GetItemPrice(ItemObject item, MobileParty tradingParty = null, bool isSelling = false)
    {
      return this.MarketData.GetPrice(item, tradingParty, isSelling);
    }

    public override int GetItemPrice(
      EquipmentElement itemRosterElement,
      MobileParty tradingParty = null,
      bool isSelling = false)
    {
      return this.MarketData.GetPrice(itemRosterElement, tradingParty, isSelling);
    }

    public override SettlementComponent.ProsperityLevel GetProsperityLevel()
    {
      if ((double) this._prosperity >= 5000.0)
        return SettlementComponent.ProsperityLevel.High;
      return (double) this._prosperity >= 2000.0 ? SettlementComponent.ProsperityLevel.Mid : SettlementComponent.ProsperityLevel.Low;
    }

    private void TickCurrentBuilding()
    {
      if (this.BuildingsInProgress.Peek().CurrentLevel == 3)
        this.BuildingsInProgress.Dequeue();
      if (this.Owner.Settlement.IsUnderSiege || this.BuildingsInProgress.IsEmpty<Building>())
        return;
      BuildingConstructionModel constructionModel = Campaign.Current.Models.BuildingConstructionModel;
      Building building = this.BuildingsInProgress.Peek();
      building.BuildingProgress += this.Construction;
      int num = this.IsCastle ? constructionModel.CastleBoostCost : constructionModel.TownBoostCost;
      if (this.BoostBuildingProcess > 0)
      {
        this.BoostBuildingProcess -= num;
        if (this.BoostBuildingProcess < 0)
          this.BoostBuildingProcess = 0;
      }
      if ((double) building.GetConstructionCost() > (double) building.BuildingProgress)
        return;
      if (building.CurrentLevel < 3)
        building.LevelUp();
      if (building.CurrentLevel == 3)
        building.BuildingProgress = (float) building.GetConstructionCost();
      this.BuildingsInProgress.Dequeue();
    }

    protected override void OnInventoryUpdated(ItemRosterElement item, int count)
    {
      this.MarketData.OnTownInventoryUpdated(item, count);
    }

    public float GetItemCategoryPriceIndex(ItemCategory itemCategory)
    {
      return this.MarketData.GetPriceFactor(itemCategory);
    }

    public struct SellLog
    {
      public static void AutoGeneratedStaticCollectObjectsSellLog(
        object o,
        List<object> collectedObjects)
      {
        ((Town.SellLog) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
      }

      private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
      {
        collectedObjects.Add((object) this.Category);
      }

      internal static object AutoGeneratedGetMemberValueCategory(object o)
      {
        return (object) ((Town.SellLog) o).Category;
      }

      internal static object AutoGeneratedGetMemberValueNumber(object o)
      {
        return (object) ((Town.SellLog) o).Number;
      }

      [SaveableProperty(200)]
      public ItemCategory Category { get; private set; }

      [SaveableProperty(201)]
      public int Number { get; private set; }

      public SellLog(ItemCategory category, int count)
      {
        this.Category = category;
        this.Number = count;
      }
    }
  }
}
