// Decompiled with JetBrains decompiler
// Type: TaleWorlds.CampaignSystem.Settlements.SettlementComponent
// Assembly: TaleWorlds.CampaignSystem, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: E85F8C15-4DF6-4E9C-A58A-29177E40D07A
// Assembly location: D:\steam\steamapps\common\Mount & Blade II Bannerlord\bin\Win64_Shipping_Client\TaleWorlds.CampaignSystem.dll

using System.Collections.Generic;
using System.Xml;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.Core;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

#nullable disable
namespace TaleWorlds.CampaignSystem.Settlements
{
  public abstract class SettlementComponent : MBObjectBase
  {
    private PartyBase _owner;

    protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
    {
      base.AutoGeneratedInstanceCollectObjects(collectedObjects);
    }

    internal static object AutoGeneratedGetMemberValueGold(object o)
    {
      return (object) ((SettlementComponent) o).Gold;
    }

    internal static object AutoGeneratedGetMemberValueIsOwnerUnassigned(object o)
    {
      return (object) ((SettlementComponent) o).IsOwnerUnassigned;
    }

    [SaveableProperty(50)]
    public int Gold { get; private set; }

    public virtual SettlementComponent.ProsperityLevel GetProsperityLevel()
    {
      return SettlementComponent.ProsperityLevel.Mid;
    }

    public float BackgroundCropPosition { get; protected set; }

    public string BackgroundMeshName { get; protected set; }

    public string WaitMeshName { get; protected set; }

    public string CastleBackgroundMeshName { get; protected set; }

    public PartyBase Owner
    {
      get => this._owner;
      internal set
      {
        if (this._owner == value)
          return;
        if (this._owner != null)
          this._owner.ItemRoster.RosterUpdatedEvent -= new ItemRoster.RosterUpdatedEventDelegate(this.OnInventoryUpdated);
        this._owner = value;
        if (this._owner == null)
          return;
        this._owner.ItemRoster.RosterUpdatedEvent += new ItemRoster.RosterUpdatedEventDelegate(this.OnInventoryUpdated);
      }
    }

    public Settlement Settlement => this._owner.Settlement;

    protected abstract void OnInventoryUpdated(ItemRosterElement item, int count);

    public TextObject Name => this.Owner.Name;

    [SaveableProperty(80)]
    public bool IsOwnerUnassigned { get; set; }

    public virtual void OnPartyEntered(MobileParty mobileParty)
    {
    }

    public virtual void OnPartyLeft(MobileParty mobileParty)
    {
    }

    public virtual void OnInit()
    {
    }

    public void ChangeGold(int changeAmount)
    {
      this.Gold += changeAmount;
      if (this.Gold >= 0)
        return;
      this.Gold = 0;
    }

    public int GetNumberOfTroops()
    {
      int numberOfTroops = 0;
      foreach (MobileParty party in (List<MobileParty>) this.Owner.Settlement.Parties)
      {
        if (party.IsMilitia || party.IsGarrison)
          numberOfTroops += party.Party.NumberOfAllMembers;
      }
      return numberOfTroops;
    }

    public override void Deserialize(MBObjectManager objectManager, XmlNode node)
    {
      base.Deserialize(objectManager, node);
    }

    public virtual int GetItemPrice(ItemObject item, MobileParty tradingParty = null, bool isSelling = false)
    {
      return 0;
    }

    public virtual int GetItemPrice(
      EquipmentElement itemRosterElement,
      MobileParty tradingParty = null,
      bool isSelling = false)
    {
      return 0;
    }

    public virtual bool IsTown => false;

    public virtual bool IsCastle => false;

    public virtual void OnRelatedPartyRemoved(MobileParty mobileParty)
    {
    }

    public List<CharacterObject> GetPrisonerHeroes()
    {
      List<PartyBase> partyBaseList = new List<PartyBase>()
      {
        this.Owner
      };
      foreach (MobileParty party in (List<MobileParty>) this.Owner.Settlement.Parties)
      {
        if (party.IsGarrison)
          partyBaseList.Add(party.Party);
      }
      List<CharacterObject> prisonerHeroes = new List<CharacterObject>();
      foreach (PartyBase partyBase in partyBaseList)
      {
        for (int index1 = 0; index1 < partyBase.PrisonRoster.Count; ++index1)
        {
          for (int index2 = 0; index2 < partyBase.PrisonRoster.GetElementNumber(index1); ++index2)
          {
            CharacterObject character = partyBase.PrisonRoster.GetElementCopyAtIndex(index1).Character;
            if (character.IsHero)
              prisonerHeroes.Add(character);
          }
        }
      }
      return prisonerHeroes;
    }

    public enum ProsperityLevel
    {
      Low,
      Mid,
      High,
      NumberOfLevels,
    }
  }
}
