// Decompiled with JetBrains decompiler
// Type: TaleWorlds.CampaignSystem.Party.PartyBase
// Assembly: TaleWorlds.CampaignSystem, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: E85F8C15-4DF6-4E9C-A58A-29177E40D07A
// Assembly location: D:\steam\steamapps\common\Mount & Blade II Bannerlord\bin\Win64_Shipping_Client\TaleWorlds.CampaignSystem.dll

using System;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.CharacterDevelopment;
using TaleWorlds.CampaignSystem.Map;
using TaleWorlds.CampaignSystem.MapEvents;
using TaleWorlds.CampaignSystem.Roster;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.CampaignSystem.Siege;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;
using TaleWorlds.SaveSystem.Load;

#nullable disable
namespace TaleWorlds.CampaignSystem.Party
{
  public sealed class PartyBase : IBattleCombatant, IRandomOwner
  {
    private static readonly HashSet<TerrainType> ValidTerrainTypes = new HashSet<TerrainType>()
    {
      TerrainType.Snow,
      TerrainType.Steppe,
      TerrainType.Plain,
      TerrainType.Desert,
      TerrainType.Swamp,
      TerrainType.Dune,
      TerrainType.Bridge,
      TerrainType.Forest,
      TerrainType.Fording
    };
    [SaveableField(15)]
    private int _remainingFoodPercentage;
    [SaveableField(182)]
    private CampaignTime _lastEatingTime = CampaignTime.Now;
    [SaveableField(8)]
    private Hero _customOwner;
    [SaveableField(9)]
    private int _index;
    [SaveableField(200)]
    private MapEventSide _mapEventSide;
    [CachedData]
    private int _lastMemberRosterVersionNo;
    [CachedData]
    private int _partyMemberSizeLastCheckVersion;
    [CachedData]
    private int _cachedPartyMemberSizeLimit;
    [CachedData]
    private int _prisonerSizeLastCheckVersion;
    [CachedData]
    private int _cachedPrisonerSizeLimit;
    [CachedData]
    private int _lastNumberOfMenWithHorseVersionNo;
    [CachedData]
    private int _lastNumberOfMenPerTierVersionNo;
    [SaveableField(17)]
    private int _numberOfMenWithHorse;
    private int[] _numberOfHealthyMenPerTier;
    [CachedData]
    private float _cachedTotalStrength;

    internal static void AutoGeneratedStaticCollectObjectsPartyBase(
      object o,
      List<object> collectedObjects)
    {
      ((PartyBase) o).AutoGeneratedInstanceCollectObjects(collectedObjects);
    }

    private void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
    {
      CampaignTime.AutoGeneratedStaticCollectObjectsCampaignTime((object) this._lastEatingTime, collectedObjects);
      collectedObjects.Add((object) this._customOwner);
      collectedObjects.Add((object) this._mapEventSide);
      collectedObjects.Add((object) this.Settlement);
      collectedObjects.Add((object) this.MobileParty);
      collectedObjects.Add((object) this.MemberRoster);
      collectedObjects.Add((object) this.PrisonRoster);
      collectedObjects.Add((object) this.ItemRoster);
    }

    internal static object AutoGeneratedGetMemberValueSettlement(object o)
    {
      return (object) ((PartyBase) o).Settlement;
    }

    internal static object AutoGeneratedGetMemberValueMobileParty(object o)
    {
      return (object) ((PartyBase) o).MobileParty;
    }

    internal static object AutoGeneratedGetMemberValueMemberRoster(object o)
    {
      return (object) ((PartyBase) o).MemberRoster;
    }

    internal static object AutoGeneratedGetMemberValuePrisonRoster(object o)
    {
      return (object) ((PartyBase) o).PrisonRoster;
    }

    internal static object AutoGeneratedGetMemberValueItemRoster(object o)
    {
      return (object) ((PartyBase) o).ItemRoster;
    }

    internal static object AutoGeneratedGetMemberValueRandomValue(object o)
    {
      return (object) ((PartyBase) o).RandomValue;
    }

    internal static object AutoGeneratedGetMemberValueAverageBearingRotation(object o)
    {
      return (object) ((PartyBase) o).AverageBearingRotation;
    }

    internal static object AutoGeneratedGetMemberValue_remainingFoodPercentage(object o)
    {
      return (object) ((PartyBase) o)._remainingFoodPercentage;
    }

    internal static object AutoGeneratedGetMemberValue_lastEatingTime(object o)
    {
      return (object) ((PartyBase) o)._lastEatingTime;
    }

    internal static object AutoGeneratedGetMemberValue_customOwner(object o)
    {
      return (object) ((PartyBase) o)._customOwner;
    }

    internal static object AutoGeneratedGetMemberValue_index(object o)
    {
      return (object) ((PartyBase) o)._index;
    }

    internal static object AutoGeneratedGetMemberValue_mapEventSide(object o)
    {
      return (object) ((PartyBase) o)._mapEventSide;
    }

    internal static object AutoGeneratedGetMemberValue_numberOfMenWithHorse(object o)
    {
      return (object) ((PartyBase) o)._numberOfMenWithHorse;
    }

    public Vec2 Position2D
    {
      get => !this.IsMobile ? this.Settlement.Position2D : this.MobileParty.Position2D;
    }

    public bool IsVisible
    {
      get => !this.IsMobile ? this.Settlement.IsVisible : this.MobileParty.IsVisible;
    }

    public bool IsActive => !this.IsMobile ? this.Settlement.IsActive : this.MobileParty.IsActive;

    public SiegeEvent SiegeEvent
    {
      get => !this.IsMobile ? this.Settlement.SiegeEvent : this.MobileParty.SiegeEvent;
    }

    public void OnVisibilityChanged(bool value)
    {
      this.MapEvent?.PartyVisibilityChanged(this, value);
      CampaignEventDispatcher.Instance.OnPartyVisibilityChanged(this);
      this.SetVisualAsDirty();
    }

    [SaveableProperty(1)]
    public Settlement Settlement { get; private set; }

    [SaveableProperty(2)]
    public MobileParty MobileParty { get; private set; }

    public bool IsSettlement => this.Settlement != null;

    public bool IsMobile => this.MobileParty != null;

    [SaveableProperty(3)]
    public TroopRoster MemberRoster { get; private set; }

    [SaveableProperty(4)]
    public TroopRoster PrisonRoster { get; private set; }

    [SaveableProperty(5)]
    public ItemRoster ItemRoster { get; private set; }

    public TextObject Name
    {
      get
      {
        if (this.IsSettlement)
          return this.Settlement.Name;
        return !this.IsMobile ? TextObject.Empty : this.MobileParty.Name;
      }
    }

    public float DaysStarving => !this.IsStarving ? 0.0f : this._lastEatingTime.ElapsedDaysUntilNow;

    public void OnConsumedFood() => this._lastEatingTime = CampaignTime.Now;

    public int RemainingFoodPercentage
    {
      get => this._remainingFoodPercentage;
      set => this._remainingFoodPercentage = value;
    }

    public bool IsStarving => this._remainingFoodPercentage < 0;

    public string Id => this.MobileParty?.StringId ?? this.Settlement.StringId;

    public Hero Owner
    {
      get
      {
        Hero customOwner = this._customOwner;
        if (customOwner != null)
          return customOwner;
        return !this.IsMobile ? this.Settlement.Owner : this.MobileParty.Owner;
      }
    }

    public void SetCustomOwner(Hero customOwner) => this._customOwner = customOwner;

    public Hero LeaderHero => this.MobileParty?.LeaderHero;

    public static PartyBase MainParty
    {
      get => Campaign.Current == null ? (PartyBase) null : Campaign.Current.MainParty.Party;
    }

    public bool LevelMaskIsDirty { get; private set; }

    public void SetLevelMaskIsDirty() => this.LevelMaskIsDirty = true;

    public void OnLevelMaskUpdated() => this.LevelMaskIsDirty = false;

    public int Index
    {
      get => this._index;
      private set => this._index = value;
    }

    public bool IsValid => this.Index >= 0;

    public IMapEntity MapEntity
    {
      get => this.IsMobile ? (IMapEntity) this.MobileParty : (IMapEntity) this.Settlement;
    }

    public IFaction MapFaction
    {
      get
      {
        if (this.MobileParty != null)
          return this.MobileParty.MapFaction;
        return this.Settlement != null ? this.Settlement.MapFaction : (IFaction) null;
      }
    }

    [SaveableProperty(210)]
    public int RandomValue { get; private set; } = MBRandom.RandomInt(1, int.MaxValue);

    public CultureObject Culture => this.MapFaction.Culture;

    public Tuple<uint, uint> PrimaryColorPair
    {
      get
      {
        return this.MapFaction == null ? new Tuple<uint, uint>(4291609515U, 4291609515U) : new Tuple<uint, uint>(this.MapFaction.Color, this.MapFaction.Color2);
      }
    }

    public Tuple<uint, uint> AlternativeColorPair
    {
      get
      {
        return this.MapFaction == null ? new Tuple<uint, uint>(4291609515U, 4291609515U) : new Tuple<uint, uint>(this.MapFaction.AlternativeColor, this.MapFaction.AlternativeColor2);
      }
    }

    public Banner Banner
    {
      get
      {
        if (this.LeaderHero != null)
          return this.LeaderHero.ClanBanner;
        return this.MapFaction?.Banner;
      }
    }

    int IBattleCombatant.GetTacticsSkillAmount()
    {
      return this.LeaderHero != null ? this.LeaderHero.GetSkillValue(DefaultSkills.Tactics) : 0;
    }

    public MapEvent MapEvent => this._mapEventSide?.MapEvent;

    public MapEventSide MapEventSide
    {
      get => this._mapEventSide;
      set
      {
        if (this._mapEventSide == value)
          return;
        if (value != null && this.IsMobile && this.MapEvent != null && this.MapEvent.DefenderSide.LeaderParty == this)
          Debug.FailedAssert(string.Format("Double MapEvent For {0}", (object) this.Name), "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Party\\PartyBase.cs", nameof (MapEventSide), 246);
        if (this._mapEventSide != null)
          this._mapEventSide.RemovePartyInternal(this);
        this._mapEventSide = value;
        if (this._mapEventSide != null)
          this._mapEventSide.AddPartyInternal(this);
        if (this.MobileParty == null)
          return;
        foreach (MobileParty attachedParty in (List<MobileParty>) this.MobileParty.AttachedParties)
          attachedParty.Party.MapEventSide = this._mapEventSide;
      }
    }

    public BattleSideEnum Side
    {
      get
      {
        MapEventSide mapEventSide = this.MapEventSide;
        return mapEventSide == null ? BattleSideEnum.None : mapEventSide.MissionSide;
      }
    }

    public BattleSideEnum OpponentSide
    {
      get
      {
        return this.Side == BattleSideEnum.Attacker ? BattleSideEnum.Defender : BattleSideEnum.Attacker;
      }
    }

    internal void AfterLoad()
    {
      if (this.RandomValue == 0)
        this.RandomValue = MBRandom.RandomInt(1, int.MaxValue);
      TroopRoster prisonRoster = this.PrisonRoster;
      if (((object) prisonRoster != null ? (prisonRoster.Contains(CharacterObject.PlayerCharacter) ? 1 : 0) : 0) != 0 && (this != Hero.MainHero.PartyBelongedToAsPrisoner || Hero.MainHero.PartyBelongedTo != null && Hero.MainHero.PartyBelongedToAsPrisoner != null))
      {
        if (Hero.MainHero.PartyBelongedTo == PartyBase.MainParty?.MobileParty)
          this.PrisonRoster.AddToCounts(CharacterObject.PlayerCharacter, -1);
        else
          PlayerCaptivity.CaptorParty = this;
      }
      if (this.IsMobile && this.MobileParty.IsCaravan && !this.MobileParty.IsCurrentlyUsedByAQuest && this._customOwner != null && this.MobileParty.Owner != this.Owner)
        this.SetCustomOwner((Hero) null);
      foreach (TroopRosterElement troopRosterElement in (List<TroopRosterElement>) this.PrisonRoster.GetTroopRoster())
      {
        if (troopRosterElement.Character.HeroObject != null && troopRosterElement.Character.HeroObject.PartyBelongedToAsPrisoner == null)
          this.PrisonRoster.RemoveTroop(troopRosterElement.Character);
      }
      if (!MBSaveLoad.IsUpdatingGameVersion || !(MBSaveLoad.LastLoadedGameVersion < ApplicationVersion.FromString("v1.2.0")))
        return;
      this.MemberRoster.RemoveZeroCounts();
    }

    internal void InitCache()
    {
      this._partyMemberSizeLastCheckVersion = -1;
      this._prisonerSizeLastCheckVersion = -1;
      this._lastNumberOfMenWithHorseVersionNo = -1;
      this._lastNumberOfMenPerTierVersionNo = -1;
      this._lastMemberRosterVersionNo = -1;
    }

    [LoadInitializationCallback]
    private void OnLoad(MetaData metaData, ObjectLoadData objectLoadData) => this.InitCache();

    public int PartySizeLimit
    {
      get
      {
        int versionNo = this.MemberRoster.VersionNo;
        if (this._partyMemberSizeLastCheckVersion != versionNo || this._cachedPartyMemberSizeLimit == 0)
        {
          this._partyMemberSizeLastCheckVersion = versionNo;
          this._cachedPartyMemberSizeLimit = (int) Campaign.Current.Models.PartySizeLimitModel.GetPartyMemberSizeLimit(this).ResultNumber;
        }
        return this._cachedPartyMemberSizeLimit;
      }
    }

    public int PrisonerSizeLimit
    {
      get
      {
        int versionNo = this.MemberRoster.VersionNo;
        if (this._prisonerSizeLastCheckVersion != versionNo || this._cachedPrisonerSizeLimit == 0)
        {
          this._prisonerSizeLastCheckVersion = versionNo;
          this._cachedPrisonerSizeLimit = (int) Campaign.Current.Models.PartySizeLimitModel.GetPartyPrisonerSizeLimit(this).ResultNumber;
        }
        return this._cachedPrisonerSizeLimit;
      }
    }

    public ExplainedNumber PartySizeLimitExplainer
    {
      get => Campaign.Current.Models.PartySizeLimitModel.GetPartyMemberSizeLimit(this, true);
    }

    public ExplainedNumber PrisonerSizeLimitExplainer
    {
      get => Campaign.Current.Models.PartySizeLimitModel.GetPartyPrisonerSizeLimit(this, true);
    }

    public int NumberOfHealthyMembers
    {
      get => this.MemberRoster.TotalManCount - this.MemberRoster.TotalWounded;
    }

    public int NumberOfRegularMembers => this.MemberRoster.TotalRegulars;

    public int NumberOfWoundedTotalMembers => this.MemberRoster.TotalWounded;

    public int NumberOfAllMembers => this.MemberRoster.TotalManCount;

    public int NumberOfPrisoners => this.PrisonRoster.TotalManCount;

    public int NumberOfMounts => this.ItemRoster.NumberOfMounts;

    public int NumberOfPackAnimals => this.ItemRoster.NumberOfPackAnimals;

    public IEnumerable<CharacterObject> PrisonerHeroes
    {
      get
      {
        for (int j = 0; j < this.PrisonRoster.Count; ++j)
        {
          if (this.PrisonRoster.GetElementNumber(j) > 0)
          {
            TroopRosterElement elementCopyAtIndex = this.PrisonRoster.GetElementCopyAtIndex(j);
            if (elementCopyAtIndex.Character.IsHero)
              yield return elementCopyAtIndex.Character;
          }
        }
      }
    }

    public int NumberOfMenWithHorse
    {
      get
      {
        if (this._lastNumberOfMenWithHorseVersionNo != this.MemberRoster.VersionNo)
        {
          this.RecalculateNumberOfMenWithHorses();
          this._lastNumberOfMenWithHorseVersionNo = this.MemberRoster.VersionNo;
        }
        return this._numberOfMenWithHorse;
      }
    }

    public int NumberOfMenWithoutHorse => this.NumberOfAllMembers - this.NumberOfMenWithHorse;

    public int GetNumberOfHealthyMenOfTier(int tier)
    {
      if (tier < 0)
      {
        Debug.FailedAssert("Requested men count for negative tier.", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.CampaignSystem\\Party\\PartyBase.cs", nameof (GetNumberOfHealthyMenOfTier), 461);
        return 0;
      }
      bool flag = false;
      if (this._numberOfHealthyMenPerTier == null || tier >= this._numberOfHealthyMenPerTier.Length)
      {
        this._numberOfHealthyMenPerTier = new int[MathF.Max(tier, 6) + 1];
        flag = true;
      }
      else if (this._lastNumberOfMenPerTierVersionNo != this.MemberRoster.VersionNo)
        flag = true;
      if (flag)
      {
        for (int index = 0; index < this._numberOfHealthyMenPerTier.Length; ++index)
          this._numberOfHealthyMenPerTier[index] = 0;
        for (int index = 0; index < this.MemberRoster.Count; ++index)
        {
          CharacterObject characterAtIndex = this.MemberRoster.GetCharacterAtIndex(index);
          if (characterAtIndex != null && !characterAtIndex.IsHero)
          {
            int tier1 = characterAtIndex.Tier;
            if (tier1 >= 0 && tier1 < this._numberOfHealthyMenPerTier.Length)
            {
              int num = this.MemberRoster.GetElementNumber(index) - this.MemberRoster.GetElementWoundedNumber(index);
              this._numberOfHealthyMenPerTier[tier1] += num;
            }
          }
        }
        this._lastNumberOfMenPerTierVersionNo = this.MemberRoster.VersionNo;
      }
      return this._numberOfHealthyMenPerTier[tier];
    }

    public int InventoryCapacity
    {
      get
      {
        return this.MobileParty == null ? 100 : (int) Campaign.Current.Models.InventoryCapacityModel.CalculateInventoryCapacity(this.MobileParty).ResultNumber;
      }
    }

    public float TotalStrength
    {
      get
      {
        if (this._lastMemberRosterVersionNo == this.MemberRoster.VersionNo)
          return this._cachedTotalStrength;
        this._cachedTotalStrength = this.CalculateStrength();
        this._lastMemberRosterVersionNo = this.MemberRoster.VersionNo;
        return this._cachedTotalStrength;
      }
    }

    public PartyBase(MobileParty mobileParty)
      : this(mobileParty, (Settlement) null)
    {
    }

    public PartyBase(Settlement settlement)
      : this((MobileParty) null, settlement)
    {
    }

    private PartyBase(MobileParty mobileParty, Settlement settlement)
    {
      this.Index = Campaign.Current.GeneratePartyId(this);
      this.MobileParty = mobileParty;
      this.Settlement = settlement;
      this.ItemRoster = new ItemRoster();
      this.MemberRoster = new TroopRoster(this);
      this.PrisonRoster = new TroopRoster(this);
      this.MemberRoster.NumberChangedCallback = new NumberChangedCallback(this.MemberRosterNumberChanged);
      this.PrisonRoster.IsPrisonRoster = true;
    }

    private void RecalculateNumberOfMenWithHorses()
    {
      this._numberOfMenWithHorse = 0;
      for (int index = 0; index < this.MemberRoster.Count; ++index)
      {
        TroopRosterElement elementCopyAtIndex = this.MemberRoster.GetElementCopyAtIndex(index);
        if (elementCopyAtIndex.Character != null && elementCopyAtIndex.Character.IsMounted)
          this._numberOfMenWithHorse += elementCopyAtIndex.Number;
      }
    }

    public int GetNumberOfMenWith(TraitObject trait)
    {
      int numberOfMenWith = 0;
      foreach (TroopRosterElement troopRosterElement in (List<TroopRosterElement>) this.MemberRoster.GetTroopRoster())
      {
        if (troopRosterElement.Character.GetTraitLevel(trait) > 0)
          numberOfMenWith += troopRosterElement.Number;
      }
      return numberOfMenWith;
    }

    public int AddPrisoner(CharacterObject element, int numberToAdd)
    {
      return this.PrisonRoster.AddToCounts(element, numberToAdd);
    }

    public int AddMember(CharacterObject element, int numberToAdd, int numberToAddWounded = 0)
    {
      return this.MemberRoster.AddToCounts(element, numberToAdd, woundedCount: numberToAddWounded);
    }

    public void AddPrisoners(TroopRoster roster)
    {
      foreach (TroopRosterElement troopRosterElement in (List<TroopRosterElement>) roster.GetTroopRoster())
        this.AddPrisoner(troopRosterElement.Character, troopRosterElement.Number);
    }

    public void AddMembers(TroopRoster roster) => this.MemberRoster.Add(roster);

    public override string ToString()
    {
      return !this.IsSettlement ? this.MobileParty.Name.ToString() : this.Settlement.Name.ToString();
    }

    public void PlaceRandomPositionAroundPosition(Vec2 centerPosition, float radius)
    {
      Vec2 position = new Vec2(0.0f, 0.0f);
      do
      {
        position.x = centerPosition.x + (float) ((double) MBRandom.RandomFloat * (double) radius * 2.0) - radius;
        position.y = centerPosition.y + (float) ((double) MBRandom.RandomFloat * (double) radius * 2.0) - radius;
      }
      while (!Campaign.Current.MapSceneWrapper.AreFacesOnSameIsland(Campaign.Current.MapSceneWrapper.GetFaceIndex(position), Campaign.Current.MapSceneWrapper.GetFaceIndex(centerPosition), false));
      if (!this.IsMobile)
        return;
      this.MobileParty.Position2D = position;
      this.MobileParty.Ai.SetMoveModeHold();
    }

    public int AddElementToMemberRoster(
      CharacterObject element,
      int numberToAdd,
      bool insertAtFront = false)
    {
      return this.MemberRoster.AddToCounts(element, numberToAdd, insertAtFront);
    }

    public void AddToMemberRosterElementAtIndex(int index, int numberToAdd, int woundedCount = 0)
    {
      this.MemberRoster.AddToCountsAtIndex(index, numberToAdd, woundedCount);
    }

    public void WoundMemberRosterElements(CharacterObject elementObj, int numberToWound)
    {
      this.MemberRoster.AddToCounts(elementObj, 0, woundedCount: numberToWound);
    }

    public void WoundMemberRosterElementsWithIndex(int elementIndex, int numberToWound)
    {
      this.MemberRoster.AddToCountsAtIndex(elementIndex, 0, numberToWound);
    }

    private float CalculateStrength()
    {
      float strength = 0.0f;
      float leaderModifier = 0.0f;
      MapEvent.PowerCalculationContext context = MapEvent.PowerCalculationContext.Default;
      BattleSideEnum side = BattleSideEnum.Defender;
      if (this.MapEvent != null)
      {
        leaderModifier = Campaign.Current.Models.MilitaryPowerModel.GetLeaderModifierInMapEvent(this.MapEvent, this.Side);
        context = this.MapEvent.SimulationContext;
      }
      for (int index = 0; index < this.MemberRoster.Count; ++index)
      {
        TroopRosterElement elementCopyAtIndex = this.MemberRoster.GetElementCopyAtIndex(index);
        if (elementCopyAtIndex.Character != null)
        {
          float troopPower = Campaign.Current.Models.MilitaryPowerModel.GetTroopPower(elementCopyAtIndex.Character, side, context, leaderModifier);
          strength += (float) (elementCopyAtIndex.Number - elementCopyAtIndex.WoundedNumber) * troopPower;
        }
      }
      return strength;
    }

    internal bool GetCharacterFromPartyRank(
      int partyRank,
      out CharacterObject character,
      out PartyBase party,
      out int stackIndex,
      bool includeWoundeds = false)
    {
      for (int index = 0; index < this.MemberRoster.Count; ++index)
      {
        TroopRosterElement elementCopyAtIndex = this.MemberRoster.GetElementCopyAtIndex(index);
        int num = elementCopyAtIndex.Number - (includeWoundeds ? 0 : elementCopyAtIndex.WoundedNumber);
        partyRank -= num;
        if (!elementCopyAtIndex.Character.IsHero && partyRank < 0)
        {
          character = elementCopyAtIndex.Character;
          party = this;
          stackIndex = index;
          return true;
        }
      }
      character = (CharacterObject) null;
      party = (PartyBase) null;
      stackIndex = 0;
      return false;
    }

    public static bool IsPositionOkForTraveling(Vec2 position)
    {
      IMapScene mapSceneWrapper = Campaign.Current.MapSceneWrapper;
      PathFaceRecord faceIndex = mapSceneWrapper.GetFaceIndex(position);
      if (!faceIndex.IsValid())
        return false;
      TerrainType faceTerrainType = mapSceneWrapper.GetFaceTerrainType(faceIndex);
      return PartyBase.ValidTerrainTypes.Contains(faceTerrainType);
    }

    private void MemberRosterNumberChanged(
      bool numberChanged,
      bool woundedNumberChanged,
      bool heroNumberChanged)
    {
      if (!(numberChanged | heroNumberChanged))
        return;
      CampaignEventDispatcher.Instance.OnPartySizeChanged(this);
    }

    public void UpdateVisibilityAndInspected(float mainPartySeeingRange = 0.0f)
    {
      bool isVisible = false;
      bool isInspected = false;
      if (this.IsSettlement)
      {
        isVisible = true;
        if (this.Settlement.SettlementComponent is ISpottable settlementComponent && !settlementComponent.IsSpotted)
          isVisible = false;
        if (isVisible)
          isInspected = PartyBase.CalculateSettlementInspected((IMapPoint) this.Settlement, mainPartySeeingRange);
      }
      else if (this.MobileParty.IsActive)
      {
        if (Campaign.Current.TrueSight)
          isVisible = true;
        else if (this.MobileParty.CurrentSettlement == null || this.MobileParty.LeaderHero?.ClanBanner != null || this.MobileParty.MapEvent != null && this.MobileParty.MapEvent.IsSiegeAssault && this.MobileParty.Party.Side == BattleSideEnum.Attacker)
          PartyBase.CalculateVisibilityAndInspected((IMapPoint) this.MobileParty, out isVisible, out isInspected, mainPartySeeingRange);
      }
      if (this.IsSettlement)
      {
        this.Settlement.IsVisible = isVisible;
        this.Settlement.IsInspected = isInspected;
      }
      else
      {
        this.MobileParty.IsVisible = isVisible;
        this.MobileParty.IsInspected = isInspected;
      }
    }

    private static void CalculateVisibilityAndInspected(
      IMapPoint mapPoint,
      out bool isVisible,
      out bool isInspected,
      float mainPartySeeingRange = 0.0f)
    {
      isInspected = false;
      if ((mapPoint is MobileParty mobileParty ? mobileParty.Army : (Army) null) != null && mobileParty.Army.LeaderParty.AttachedParties.IndexOf(mobileParty) >= 0)
        isVisible = mobileParty.Army.LeaderParty.IsVisible;
      else if (mobileParty != null && MobileParty.MainParty.CurrentSettlement != null && MobileParty.MainParty.CurrentSettlement.SiegeEvent != null && MobileParty.MainParty.CurrentSettlement.SiegeEvent.BesiegerCamp.IsBesiegerSideParty(mobileParty))
      {
        isVisible = true;
      }
      else
      {
        float visibilityRangeOfMapPoint = PartyBase.CalculateVisibilityRangeOfMapPoint(mapPoint, mainPartySeeingRange);
        isVisible = (double) visibilityRangeOfMapPoint > 1.0 && mapPoint.IsActive;
        if (!isVisible)
          return;
        if (mapPoint.IsInspected)
          isInspected = true;
        else
          isInspected = 1.0 / (double) visibilityRangeOfMapPoint < (double) Campaign.Current.Models.MapVisibilityModel.GetPartyRelativeInspectionRange(mapPoint);
      }
    }

    private static bool CalculateSettlementInspected(IMapPoint mapPoint, float mainPartySeeingRange = 0.0f)
    {
      return 1.0 / (double) PartyBase.CalculateVisibilityRangeOfMapPoint(mapPoint, mainPartySeeingRange) < (double) Campaign.Current.Models.MapVisibilityModel.GetPartyRelativeInspectionRange(mapPoint);
    }

    private static float CalculateVisibilityRangeOfMapPoint(
      IMapPoint mapPoint,
      float mainPartySeeingRange)
    {
      MobileParty mainParty = MobileParty.MainParty;
      float lengthSquared = (mainParty.Position2D - mapPoint.Position2D).LengthSquared;
      float num1 = mainPartySeeingRange;
      if ((double) mainPartySeeingRange == 0.0)
        num1 = mainParty.SeeingRange;
      double num2 = (double) num1 * (double) num1 / (double) lengthSquared;
      float num3 = 0.25f;
      if (mapPoint is MobileParty party)
        num3 = Campaign.Current.Models.MapVisibilityModel.GetPartySpottingDifficulty(mainParty, party);
      double num4 = (double) num3;
      return (float) (num2 / num4);
    }

    [SaveableProperty(12)]
    public float AverageBearingRotation { get; set; }

    public BasicCultureObject BasicCulture => (BasicCultureObject) this.Culture;

    public BasicCharacterObject General
    {
      get
      {
        if (this.MobileParty?.Army != null)
        {
          MobileParty leaderParty = this.MobileParty.Army.LeaderParty;
          if (leaderParty == null)
            return (BasicCharacterObject) null;
          Hero leaderHero = leaderParty.LeaderHero;
          return leaderHero == null ? (BasicCharacterObject) null : (BasicCharacterObject) leaderHero.CharacterObject;
        }
        Hero leaderHero1 = this.LeaderHero;
        return leaderHero1 == null ? (BasicCharacterObject) null : (BasicCharacterObject) leaderHero1.CharacterObject;
      }
    }

    public void SetAsCameraFollowParty() => Campaign.Current.CameraFollowParty = this;

    internal void OnFinishLoadState()
    {
      this.SetVisualAsDirty();
      this.MobileParty?.OnFinishLoadState();
      this.MemberRoster.NumberChangedCallback = new NumberChangedCallback(this.MemberRosterNumberChanged);
    }

    [CachedData]
    public bool IsVisualDirty { get; private set; }

    public void SetVisualAsDirty() => this.IsVisualDirty = true;

    public void OnVisualsUpdated() => this.IsVisualDirty = false;

    internal void OnHeroAdded(Hero heroObject) => this.MobileParty?.OnHeroAdded(heroObject);

    internal void OnHeroRemoved(Hero heroObject) => this.MobileParty?.OnHeroRemoved(heroObject);

    internal void OnHeroAddedAsPrisoner(Hero heroObject)
    {
      heroObject.OnAddedToPartyAsPrisoner(this);
    }

    internal void OnHeroRemovedAsPrisoner(Hero heroObject)
    {
      heroObject.OnRemovedFromPartyAsPrisoner(this);
    }

    public void ResetTempXp() => this.MemberRoster.ClearTempXp();

    public void OnGameInitialized()
    {
      if (this.IsMobile)
      {
        this.MobileParty.OnGameInitialized();
      }
      else
      {
        if (!this.IsSettlement)
          return;
        this.Settlement.OnGameInitialized();
      }
    }
  }
}
