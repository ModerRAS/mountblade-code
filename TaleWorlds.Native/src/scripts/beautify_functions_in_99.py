#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import re
import sys

def analyze_function_patterns(file_path):
    """分析函数模式并生成重命名映射"""
    
    # 读取文件内容
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # 查找所有函数定义
    function_pattern = r'^(void|undefined.*|longlong|int|char|bool|float|double|\*)\s+(thunk_)?(FUN_[0-9a-fA-F]+)\s*\((.*?)\)\s*'
    matches = re.findall(function_pattern, content, re.MULTILINE)
    
    # 函数重命名映射
    function_mappings = {
        # 基础系统函数
        'FUN_1800ae370': 'SystemResourceInitialize',
        'FUN_1800ae390': 'SystemResourceConfigure',
        'FUN_1800ae3c0': 'SystemResourceSetup',
        'FUN_1800ae3f0': 'SystemResourceGetHandle',
        'FUN_1800ae430': 'SystemResourceCreate',
        'FUN_1800ae600': 'SystemMemoryAllocate',
        'FUN_1800ae640': 'SystemMemoryManager',
        'FUN_1800ae730': 'SystemStringBufferInitialize',
        'FUN_1800aec40': 'SystemStringBufferProcess',
        'FUN_1800aeef0': 'SystemStringBufferFormat',
        'FUN_1800af2c0': 'SystemValidationCheck',
        'FUN_1800af9f0': 'SystemResourceOperation',
        'FUN_1800b01b0': 'SystemDataProcessor',
        'FUN_1800b01cf': 'SystemDataHandler',
        'FUN_1800b030f': 'SystemCleanupRoutine',
        'FUN_1800b0380': 'SystemResourceCleanup',
        'FUN_1800b039e': 'SystemOperationProcessor',
        'FUN_1800b0710': 'SystemStatusQuery',
        'FUN_1800b0890': 'SystemConfigurationLoader',
        'FUN_1800b08e0': 'SystemDataAccessor',
        'FUN_1800b1230': 'SystemComplexProcessor',
        'FUN_1800b1d50': 'SystemDataConverter',
        'FUN_1800b1d80': 'SystemAdvancedProcessor',
        'FUN_1800b2450': 'SystemDataTransformer',
        'FUN_1800b2bd0': 'SystemDataValidator',
        'FUN_1800b2cb2': 'SystemStatusReader',
        'FUN_1800b33d0': 'SystemDataManager',
        'FUN_1800b3a40': 'SystemInitializer',
        'FUN_1800b3cc0': 'SystemModuleInitializer',
        'FUN_1800b3fe0': 'SystemBufferManager',
        'FUN_1800b4550': 'SystemController',
        'FUN_1800b47e0': 'SystemOperationExecutor',
        'FUN_1800b4810': 'SystemOperationHandler',
        'FUN_1800b4830': 'SystemOperationProcessor',
        'FUN_1800b4860': 'SystemContextManager',
        'FUN_1800b4890': 'SystemContextHandler',
        'FUN_1800b48c0': 'SystemContextProcessor',
        'FUN_1800b48e0': 'SystemContextExecutor',
        'FUN_1800b4a00': 'SystemDataRetriever',
        'FUN_1800b4a40': 'SystemPointerManager',
        'FUN_1800b4e00': 'SystemDataWriter',
        'FUN_1800b4ec0': 'SystemCharacterProcessor',
        'FUN_1800b55b0': 'SystemCharacterReader',
        'FUN_1800b57a0': 'SystemDataWriter',
        'FUN_1800b5cc0': 'SystemAdvancedWriter',
        'FUN_1800b5d10': 'SystemDataHandler',
        'FUN_1800b5d38': 'SystemQuickCleanup',
        'FUN_1800b5e73': 'SystemMemoryRelease',
        'FUN_1800b5ec0': 'SystemMemoryManager',
        'FUN_1800b5f00': 'SystemResourceHandler',
        'FUN_1800b6620': 'SystemFinalCleanup',
        'FUN_1800b6780': 'SystemResourceWriter',
        'FUN_1800b6940': 'SystemDataProcessor',
        'FUN_1800b6b20': 'SystemAdvancedWriter',
        'FUN_1800b6d80': 'SystemPointerHandler',
        'FUN_1800b6de0': 'SystemDataConverter',
        'FUN_1800b70e0': 'SystemLargeDataProcessor',
        'FUN_1800b76b0': 'SystemDataPairProcessor',
        'FUN_1800b76d4': 'SystemQuickOperation',
        'FUN_1800b782b': 'SystemMemoryCheck',
        'FUN_1800b7840': 'SystemDataPairHandler',
        'FUN_1800b7a70': 'SystemQuadProcessor',
        'FUN_1800b7ca0': 'SystemDataConverter',
        'FUN_1800b7eb0': 'SystemAdvancedProcessor',
        'FUN_1800b8090': 'SystemDataPointerHandler',
        'FUN_1800b82b0': 'SystemQuadOperation',
        'FUN_1800b8370': 'SystemLargeDataHandler',
        'FUN_1800b8500': 'SystemPointerProcessor',
        'FUN_1800b8570': 'SystemLargeDataProcessor',
        'FUN_1800b8630': 'SystemLargeDataHandler',
        'FUN_1800b8674': 'SystemPointerOperation',
        'FUN_1800b8754': 'SystemQuickOperation',
        'FUN_1800b87c0': 'SystemDataPairProcessor',
        'FUN_1800b88d0': 'SystemDataProcessor',
        'FUN_1800b8911': 'SystemDataOperation',
        'FUN_1800b89fa': 'SystemQuickRelease',
        'FUN_1800b8a10': 'SystemQuadOperation',
        'FUN_1800b8a30': 'SystemQuadProcessor',
        'FUN_1800b8a90': 'SystemDataHandler',
        'FUN_1800b8aa6': 'SystemQuickCleanup',
        'FUN_1800b8adc': 'SystemMemoryReset',
        'FUN_1800b8b00': 'SystemQuadOperation',
        'FUN_1800b8b20': 'SystemPointerHandler',
        'FUN_1800b8b4a': 'SystemPointerOperation',
        'FUN_1800b8c45': 'SystemQuickRelease',
        'FUN_1800b8c6e': 'SystemDataOperation',
        'FUN_1800b8cb0': 'SystemLargeDataProcessor',
        'FUN_1800b8cd6': 'SystemDataProcessor',
        'FUN_1800b8cdb': 'SystemDataHandler',
        'FUN_1800b8ce0': 'SystemDataProcessor',
        'FUN_1800b8d50': 'SystemQuickCleanup',
        'FUN_1800b8d74': 'SystemMemoryRelease',
        'FUN_1800b8d95': 'SystemQuickOperation',
        'FUN_1800b8da0': 'SystemLargeDataHandler',
        'FUN_1800b9030': 'SystemQuadOperation',
        'FUN_1800b9210': 'SystemDataPairProcessor',
        'FUN_1800b9222': 'SystemQuickOperation',
        'FUN_1800b9266': 'SystemQuickCleanup',
        'FUN_1800b9270': 'SystemQuadOperation',
        'FUN_1800b92f0': 'SystemDataPairHandler',
        'FUN_1800b9400': 'SystemDataPairProcessor',
        'FUN_1800b9470': 'SystemDataPairHandler',
        'FUN_1800b94f0': 'SystemDataRetriever',
        'FUN_1800b9570': 'SystemDataHandler',
        'FUN_1800b95a0': 'SystemDataProcessor',
        'FUN_1800b95d0': 'SystemDataWriter',
        'FUN_1800b95dd': 'SystemDataWriter',
        'FUN_1800b9602': 'SystemDataProcessor',
        'FUN_1800b96f3': 'SystemQuickRelease',
        'FUN_1800b96fd': 'SystemQuickCleanup',
        'FUN_1800b9720': 'SystemDataOperation',
        'FUN_1800b972d': 'SystemDataOperation',
        'FUN_1800b9752': 'SystemDataProcessor',
        'FUN_1800b9842': 'SystemQuickRelease',
        'FUN_1800b984c': 'SystemQuickCleanup',
        'FUN_1800b9870': 'SystemTripleOperation',
        'FUN_1800b9879': 'SystemTripleProcessor',
        'FUN_1800b9898': 'SystemQuadOperation',
        'FUN_1800b9995': 'SystemQuickRelease',
        'FUN_1800b9a8e': 'SystemQuickCleanup',
        'FUN_1800b9b80': 'SystemQuadOperation',
        'FUN_1800b9f60': 'SystemFloatProcessor',
        'FUN_1800ba100': 'SystemDataHandler',
        'FUN_1800ba129': 'SystemQuickOperation',
        'FUN_1800ba168': 'SystemDataProcessor',
        'FUN_1800ba180': 'SystemDataHandler',
        'FUN_1800ba1b0': 'SystemDataProcessor',
        'FUN_1800ba1f0': 'SystemDataHandler',
        'FUN_1800ba230': 'SystemDataRetriever',
        'FUN_1800ba290': 'SystemPointerHandler',
        'FUN_1800ba340': 'SystemLargeDataProcessor',
        'FUN_1800ba4b0': 'SystemResourceHandler',
        'FUN_1800ba6f0': 'SystemResourceProcessor',
        'FUN_1800baa80': 'SystemPointerHandler',
        'FUN_1800babf0': 'SystemResourceHandler',
        'FUN_1800bb630': 'SystemDataRetriever',
        'FUN_1800bbc40': 'SystemDataPairProcessor',
        'FUN_1800bc110': 'SystemPointerHandler',
        'FUN_1800bc180': 'SystemDataRetriever',
        'FUN_1800bc460': 'SystemDataHandler',
        'FUN_1800bc480': 'SystemDataProcessor',
        'FUN_1800bc4a0': 'SystemDataHandler',
        'FUN_1800bcab0': 'SystemPointerHandler',
        'FUN_1800bd410': 'SystemDataRetriever',
        'FUN_1800bd5c0': 'SystemDataRetriever',
        'FUN_1800bd790': 'SystemDataRetriever',
        'FUN_1800bd890': 'SystemDataRetriever',
        'FUN_1800bdbb0': 'SystemDataRetriever',
        'FUN_1800bdc80': 'SystemDataRetriever',
        'FUN_1800bde30': 'SystemDataRetriever',
        'FUN_1800bdfe0': 'SystemQuickCleanup',
        'FUN_1800be440': 'SystemDataRetriever',
        'FUN_1800be610': 'SystemDataRetriever',
        'FUN_1800be7e0': 'SystemQuickRelease',
        'FUN_1800bed00': 'SystemDataProcessor',
        'FUN_1800bf780': 'SystemQuickCleanup',
        'FUN_1800bf9e0': 'SystemDataPairProcessor',
        'FUN_1800c0100': 'SystemDataRetriever',
        'FUN_1800c0230': 'SystemDataPairProcessor',
        'FUN_1800c0570': 'SystemDataPairProcessor',
        'FUN_1800c0830': 'SystemDataHandler',
        'FUN_1800c0c20': 'SystemDataProcessor',
        'FUN_1800c0da0': 'SystemQuadOperation',
        'FUN_1800c0ef0': 'SystemDataProcessor',
        'FUN_1800c11a0': 'SystemDataProcessor',
        'FUN_1800c12e0': 'SystemQuadOperation',
        'FUN_1800c1420': 'SystemDataOperation',
        'FUN_1800c17c0': 'SystemDataRetriever',
        'FUN_1800c18f0': 'SystemPointerHandler',
        'FUN_1800c19c0': 'SystemQuadOperation',
        'FUN_1800c19f0': 'SystemQuadProcessor',
        'FUN_1800c1a20': 'SystemQuadOperation',
        'FUN_1800c1a50': 'SystemQuadProcessor',
        'FUN_1800c1a80': 'SystemQuickCleanup',
        'FUN_1800c26d0': 'SystemDataProcessor',
        'FUN_1800c2970': 'SystemPointerProcessor',
        'FUN_1800c29fa': 'SystemDataRetriever',
        'FUN_1800c2a70': 'SystemQuadOperation',
        'FUN_1800c2a90': 'SystemQuadProcessor',
        'FUN_1800c2c20': 'SystemDataPairProcessor',
        'FUN_1800c2ca0': 'SystemQuadOperation',
        'FUN_1800c2ff0': 'SystemQuadOperation',
        'FUN_1800c33e0': 'SystemDataHandler',
        'FUN_1800c3730': 'SystemQuickRelease',
        'FUN_1800c3761': 'SystemDataPairProcessor',
        'FUN_1800c37dd': 'SystemDataPairProcessor',
        'FUN_1800c37f0': 'SystemDataHandler',
        'FUN_1800c3bf0': 'SystemPointerHandler',
        'FUN_1800c3c70': 'SystemQuickCleanup',
        'FUN_1800c4620': 'SystemDataValidator',
        'FUN_1800c47c0': 'SystemLargeDataProcessor',
        'FUN_1800c4800': 'SystemDataProcessor',
        'FUN_1800c4960': 'SystemDataRetriever',
        'FUN_1800c4da0': 'SystemDataRetriever',
        'FUN_1800c5600': 'SystemDataHandler',
        'FUN_1800c6320': 'SystemDataPairProcessor',
        'FUN_1800c6910': 'SystemDataPairProcessor',
        'FUN_1800c78b0': 'SystemDataPairProcessor',
        'FUN_1800c7ab5': 'SystemQuickOperation',
        'FUN_1800c7b10': 'SystemDataPairProcessor',
        'FUN_1800c7cb0': 'SystemDataPairProcessor',
        'FUN_1800c8190': 'SystemDataPairProcessor',
        'FUN_1800c89a0': 'SystemDataPairProcessor',
        'FUN_1800c9eb0': 'SystemDataPairProcessor',
        'FUN_1800ca380': 'SystemDataPairProcessor',
        'FUN_1800cbd80': 'SystemDataPairProcessor',
        'FUN_1800cbddb': 'SystemDataHandler',
        'FUN_1800cbeef': 'SystemQuickRelease',
        'FUN_1800cbf90': 'SystemDataPairProcessor',
        'FUN_1800cd1b0': 'SystemTripleProcessor',
        'FUN_1800cd350': 'SystemQuadOperation',
        'FUN_1800cd410': 'SystemDataOperation',
        'FUN_1800cd7d0': 'SystemDataPairProcessor',
        'FUN_1800cfb40': 'SystemTripleProcessor',
        'FUN_1800cfee0': 'SystemDataPairProcessor',
        'FUN_1800d0950': 'SystemComplexProcessor',
        'FUN_1800d36c0': 'SystemDataPairProcessor',
        'FUN_1800d40d0': 'SystemDataPairProcessor',
        'FUN_1800d4179': 'SystemQuickCleanup',
        'FUN_1800d4253': 'SystemQuickRelease',
        'FUN_1800d4270': 'SystemTripleProcessor',
        'FUN_1800d5be0': 'SystemDataOperation',
        'FUN_1800d7010': 'SystemQuadProcessor',
        'FUN_1800d7036': 'SystemQuadOperation',
        'FUN_1800d727a': 'SystemQuickCleanup',
        'FUN_1800d7470': 'SystemDataPairProcessor',
        'FUN_1800d7810': 'SystemQuickRelease',
        'FUN_1800d82a0': 'SystemTripleProcessor',
        'FUN_1800d82bb': 'SystemQuadOperation',
        'FUN_1800d83ba': 'SystemQuickCleanup',
        'FUN_1800d85c5': 'SystemQuickRelease',
        'FUN_1800d8a40': 'SystemDataHandler',
        'FUN_1800d8a80': 'SystemDataProcessor',
        'FUN_1800d8b10': 'SystemResourceHandler',
        'FUN_1800d8b40': 'SystemResourceProcessor',
        'FUN_1800d8b70': 'SystemResourceHandler',
        'FUN_1800d8ba0': 'SystemResourceProcessor',
        'FUN_1800d8bd0': 'SystemResourceHandler',
        'FUN_1800d9060': 'SystemPointerHandler',
        'FUN_1800da760': 'SystemTripleProcessor',
        'FUN_1800da770': 'SystemTripleProcessor',
        'FUN_1800da98f': 'SystemQuickCleanup',
        'FUN_1800da9b0': 'SystemQuickRelease',
        'FUN_1800daa50': 'SystemDataRetriever',
        'FUN_1800dabf0': 'SystemQuickCleanup',
        'FUN_1800dae20': 'SystemDataRetriever',
        'FUN_1800daf60': 'SystemDataRetriever',
        'FUN_1800db0a0': 'SystemDataRetriever',
        'FUN_1800db220': 'SystemTripleProcessor',
        'FUN_1800db370': 'SystemDataProcessor',
        'FUN_1800db610': 'SystemDataPairProcessor',
        'FUN_1800dbd90': 'SystemTripleProcessor',
        'FUN_1800dc070': 'SystemDataProcessor',
        'FUN_1800dca70': 'SystemDataPairProcessor',
        'FUN_1800dd0e0': 'SystemDataPairProcessor',
        'FUN_1800dd660': 'SystemDataPairProcessor',
        'FUN_1800dd8a0': 'SystemDataPairProcessor',
        'FUN_1800de960': 'SystemDataPairProcessor',
        'FUN_1800debc0': 'SystemDataPairProcessor',
        'FUN_1800dec37': 'SystemDataPairProcessor',
        'FUN_1800df203': 'SystemPointerHandler',
        'FUN_1800df226': 'SystemDataProcessor',
        'FUN_1800df25a': 'SystemQuickCleanup',
        'FUN_1800df3bb': 'SystemQuickRelease',
        'FUN_1800df54f': 'SystemQuickCleanup',
        'FUN_1800df927': 'SystemDataPairProcessor',
        'FUN_1800df980': 'SystemTripleProcessor',
        'FUN_1800dfc20': 'SystemTripleProcessor',
        'FUN_1800e1190': 'SystemDataPairProcessor',
        'FUN_1800e24b0': 'SystemDataPairProcessor',
        'FUN_1800e2c60': 'SystemDataPairProcessor',
        'FUN_1800e31a0': 'SystemTripleProcessor',
        'FUN_1800e3580': 'SystemTripleProcessor',
        'FUN_1800e3700': 'SystemDataPairProcessor',
        'FUN_1800e44b0': 'SystemQuadProcessor',
        'FUN_1800e4da0': 'SystemQuadProcessor',
        'FUN_1800e4ee0': 'SystemQuadProcessor',
        'FUN_1800e4ef6': 'SystemTripleProcessor',
        'FUN_1800e4f89': 'SystemQuickCleanup',
        'FUN_1800e4f90': 'SystemQuadProcessor',
        'FUN_1800e4fbe': 'SystemDataHandler',
        'FUN_1800e4fef': 'SystemQuickRelease',
        'FUN_1800e5085': 'SystemQuickCleanup',
        'FUN_1800e5090': 'SystemQuickRelease',
        'FUN_1800e5110': 'SystemTripleProcessor',
        'FUN_1800e5180': 'SystemTripleProcessor',
        'FUN_1800e5197': 'SystemQuickCleanup',
        'FUN_1800e5254': 'SystemQuickRelease',
        'FUN_1800e5450': 'SystemQuickCleanup',
        'FUN_1800e545a': 'SystemQuickRelease',
        'FUN_1800e563b': 'SystemQuickCleanup',
        'FUN_1800e5650': 'SystemQuickRelease',
        'FUN_1800e6820': 'SystemDataPairProcessor',
        'FUN_1800e79f0': 'SystemDataHandler',
        'FUN_1800e7b80': 'SystemDataHandler',
        'FUN_1800e7be0': 'SystemDataHandler',
        'FUN_1800e7c40': 'SystemDataHandler',
        'FUN_1800e7ca0': 'SystemDataHandler',
        'FUN_1800e7d00': 'SystemDataHandler',
        'FUN_1800e7d93': 'SystemDataRetriever',
        'FUN_1800e7e24': 'SystemDataRetriever',
        'FUN_1800e7e73': 'SystemDataRetriever',
        'FUN_1800e7f04': 'SystemDataRetriever',
        'FUN_1800e7f20': 'SystemPointerHandler',
        'FUN_1800e8060': 'SystemDataProcessor',
        'FUN_1800e8140': 'SystemLargeDataProcessor',
        'FUN_1800e8163': 'SystemDataPairProcessor',
        'FUN_1800e81e2': 'SystemQuickCleanup',
        'FUN_1800e8340': 'SystemDataPairProcessor',
        'FUN_1800e8362': 'SystemDataPairProcessor',
        'FUN_1800e8367': 'SystemDataPairProcessor',
        'FUN_1800e84a0': 'SystemQuickCleanup',
        'FUN_1800e862d': 'SystemQuickRelease',
        'FUN_1800e8640': 'SystemDataPairProcessor',
        'FUN_1800e8a00': 'SystemDataPairProcessor',
        'FUN_1800e8a22': 'SystemDataPairProcessor',
        'FUN_1800e8a27': 'SystemDataPairProcessor',
        'FUN_1800e8b60': 'SystemQuickCleanup',
        'FUN_1800e8ced': 'SystemQuickRelease',
        'FUN_1800e92d0': 'SystemQuadOperation',
        'FUN_1800e9360': 'SystemQuadProcessor',
        'FUN_1800e94a0': 'SystemDataPairProcessor',
        'FUN_1800e94be': 'SystemQuickCleanup',
        'FUN_1800e9522': 'SystemQuickRelease',
        'FUN_1800e9540': 'SystemDataPairProcessor',
        'FUN_1800e9790': 'SystemDataPairProcessor',
        'FUN_1800e98d0': 'SystemDataPairProcessor',
        'FUN_1800e98fb': 'SystemDataPairProcessor',
        'FUN_1800e996b': 'SystemDataPairProcessor',
    }
    
    # 处理thunk函数
    thunk_mappings = {
        'thunk_FUN_1801be3b5': 'SystemStatusChecker',
        'thunk_FUN_1804bc994': 'SystemOperationHandler',
        'thunk_FUN_1806e0451': 'SystemDataProcessor',
        'thunk_FUN_180752300': 'SystemComplexOperation',
        'thunk_FUN_1807524e0': 'SystemDataRetriever',
        'thunk_FUN_1808fc418': 'SystemDataAccessor',
        'thunk_MemoryCleanupOperation': 'SystemMemoryCleanup',
    }
    
    # 合并映射
    all_mappings = {}
    all_mappings.update(function_mappings)
    all_mappings.update(thunk_mappings)
    
    return all_mappings

def beautify_functions(file_path, output_path):
    """美化函数名"""
    
    # 获取函数映射
    function_mappings = analyze_function_patterns(file_path)
    
    # 读取文件内容
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # 应用重命名
    for old_name, new_name in function_mappings.items():
        # 替换函数定义
        content = re.sub(r'\b' + re.escape(old_name) + r'\b', new_name, content)
    
    # 写入输出文件
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(content)
    
    print(f"处理完成，共重命名 {len(function_mappings)} 个函数")
    print(f"输出文件: {output_path}")
    
    return function_mappings

if __name__ == "__main__":
    input_file = "/dev/shm/mountblade-code/TaleWorlds.Native/src/99_unmatched_functions.c"
    output_file = "/dev/shm/mountblade-code/TaleWorlds.Native/src/99_unmatched_functions.c"
    
    mappings = beautify_functions(input_file, output_file)
    
    print("\n重命名映射:")
    for old, new in mappings.items():
        print(f"  {old} -> {new}")